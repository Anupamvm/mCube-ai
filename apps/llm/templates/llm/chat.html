{% extends 'core/base.html' %}

{% block title %}AI Chat - mCube Trading System{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <h1>ðŸ’¬ Chat with AI Assistant</h1>
        <div class="llm-info">
            <span class="status {% if llm_enabled %}online{% else %}offline{% endif %}">
                <span class="dot"></span>
                {% if llm_enabled %}Connected{% else %}Offline{% endif %}
            </span>
            <span class="model-name">{{ llm_model }}</span>
        </div>
    </div>

    {% if not llm_enabled %}
    <div class="alert alert-error">
        <strong>Error:</strong> LLM client is not connected. Please check the configuration.
    </div>
    {% else %}

    <div class="chat-box">
        <div class="messages" id="chat-messages">
            <div class="message assistant">
                <div class="message-avatar">ðŸ¤–</div>
                <div class="message-content">
                    <div class="message-text">
                        Hello! I'm your AI trading assistant. I can help you with:
                        <ul>
                            <li>Analyzing market news and trends</li>
                            <li>Answering questions about stocks and companies</li>
                            <li>Summarizing investor calls and reports</li>
                            <li>Providing trading insights based on available data</li>
                        </ul>
                        How can I assist you today?
                    </div>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="settings-row">
                <label>Temperature: <span id="temp-value">0.7</span></label>
                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">

                <label>Max Tokens: <span id="tokens-value">1000</span></label>
                <input type="number" id="max_tokens" min="100" max="4000" step="100" value="1000">
            </div>

            <div class="chat-input-row">
                <textarea id="user-input" placeholder="Type your message here..." rows="3"></textarea>
                <button id="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<style>
.chat-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chat-header h1 {
    font-size: 28px;
    color: #333;
}

.llm-info {
    display: flex;
    gap: 15px;
    align-items: center;
}

.status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
    font-size: 14px;
}

.status .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}

.status.online {
    color: #10b981;
}

.status.online .dot {
    background: #10b981;
    animation: pulse 2s infinite;
}

.status.offline {
    color: #ef4444;
}

.status.offline .dot {
    background: #ef4444;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.model-name {
    font-size: 13px;
    color: #666;
    background: #f3f4f6;
    padding: 6px 12px;
    border-radius: 4px;
}

.chat-box {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 250px);
}

.messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f9fafb;
}

.message {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
    background: #e5e7eb;
}

.message.user .message-avatar {
    background: #dbeafe;
}

.message.assistant .message-avatar {
    background: #d1fae5;
}

.message-content {
    flex: 1;
    max-width: 80%;
}

.message-text {
    background: #fff;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    line-height: 1.6;
}

.message.user .message-text {
    background: #3b82f6;
    color: #fff;
}

.message-text ul {
    margin: 10px 0 0 20px;
}

.message-text li {
    margin: 5px 0;
}

.message-meta {
    font-size: 12px;
    color: #999;
    margin-top: 5px;
}

.input-area {
    background: #fff;
    border-top: 1px solid #ddd;
    padding: 15px;
}

.settings-row {
    display: flex;
    gap: 20px;
    align-items: center;
    margin-bottom: 12px;
    font-size: 14px;
}

.settings-row label {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #666;
}

.settings-row input[type="range"] {
    width: 120px;
}

.settings-row input[type="number"] {
    width: 80px;
    padding: 4px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.chat-input-row {
    display: flex;
    gap: 10px;
}

#user-input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-family: inherit;
    font-size: 14px;
    resize: none;
}

#user-input:focus {
    outline: none;
    border-color: #3b82f6;
}

#send-btn {
    padding: 12px 30px;
    background: #3b82f6;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}

#send-btn:hover {
    background: #2563eb;
}

#send-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

.alert {
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.alert-error {
    background: #fee2e2;
    border: 1px solid #fecaca;
    color: #991b1b;
}

.typing-indicator {
    display: flex;
    gap: 4px;
    padding: 12px 16px;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #9ca3af;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}
</style>

<script>
// Message history
let messages = [];

// Update slider values
document.getElementById('temperature').addEventListener('input', function(e) {
    document.getElementById('temp-value').textContent = e.target.value;
});

document.getElementById('max_tokens').addEventListener('input', function(e) {
    document.getElementById('tokens-value').textContent = e.target.value;
});

// Handle Enter key
document.getElementById('user-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

async function sendMessage() {
    const input = document.getElementById('user-input');
    const message = input.value.trim();

    if (!message) return;

    // Add user message
    addMessage('user', message);

    // Clear input
    input.value = '';

    // Add to history
    messages.push({
        role: 'user',
        content: message
    });

    // Show typing indicator
    showTypingIndicator();

    // Get settings
    const temperature = parseFloat(document.getElementById('temperature').value);
    const max_tokens = parseInt(document.getElementById('max_tokens').value);

    // Disable send button
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    try {
        // Send to backend
        const response = await fetch('{% url "llm:chat" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                messages: messages,
                temperature: temperature,
                max_tokens: max_tokens
            })
        });

        const data = await response.json();

        // Remove typing indicator
        hideTypingIndicator();

        if (data.success) {
            // Add assistant response
            addMessage('assistant', data.response, data.metadata);

            // Add to history
            messages.push({
                role: 'assistant',
                content: data.response
            });
        } else {
            addMessage('assistant', 'Error: ' + (data.error || 'Unknown error occurred'));
        }
    } catch (error) {
        hideTypingIndicator();
        addMessage('assistant', 'Error: Failed to communicate with the server');
        console.error(error);
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
    }
}

function addMessage(role, content, metadata) {
    const messagesDiv = document.getElementById('chat-messages');

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;

    const avatar = role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';

    let metaHtml = '';
    if (metadata) {
        const tokens = metadata.usage?.total_tokens || 0;
        const time = metadata.processing_time_ms || 0;
        metaHtml = `<div class="message-meta">${tokens} tokens â€¢ ${time}ms</div>`;
    }

    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
            <div class="message-text">${escapeHtml(content)}</div>
            ${metaHtml}
        </div>
    `;

    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function showTypingIndicator() {
    const messagesDiv = document.getElementById('chat-messages');

    const indicatorDiv = document.createElement('div');
    indicatorDiv.className = 'message assistant';
    indicatorDiv.id = 'typing-indicator';
    indicatorDiv.innerHTML = `
        <div class="message-avatar">ðŸ¤–</div>
        <div class="message-content">
            <div class="message-text">
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;

    messagesDiv.appendChild(indicatorDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) {
        indicator.remove();
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

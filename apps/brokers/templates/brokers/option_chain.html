{% extends 'brokers/base.html' %}

{% block title %}Nifty Option Chain - mCube{% endblock %}

{% block page_title %}Nifty Option Chain{% endblock %}

{% block page_content %}
<style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-content {
        text-align: center;
        color: white;
    }

    .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #4CAF50;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .loading-subtext {
        font-size: 14px;
        color: #ccc;
    }
</style>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text">Fetching Nifty Option Chain...</div>
        <div class="loading-subtext">This may take 30-60 seconds</div>
    </div>
</div>

<div class="card">
    <h2>Nifty Option Chain - All Expiries</h2>

    <form method="post" id="fetchOptionChainForm">
        {% csrf_token %}
        <button type="submit" class="btn btn-success" id="fetchButton">Fetch Nifty Option Chain</button>
    </form>

    {% if total_records %}
    <p style="margin-top: 10px;">
        <strong>Total Records:</strong> {{ total_records }}<br>
        <strong>Spot Price:</strong> {% if spot_price %}₹{{ spot_price|floatformat:2 }}{% else %}N/A{% endif %}
    </p>
    {% endif %}
</div>

<script>
    document.getElementById('fetchOptionChainForm').addEventListener('submit', function(e) {
        // Show loading overlay
        document.getElementById('loadingOverlay').classList.add('active');

        // Disable the button to prevent multiple clicks
        var button = document.getElementById('fetchButton');
        button.disabled = true;
        button.textContent = 'Fetching...';
    });
</script>

{% if expiry_dates %}
<div class="card">
    <h3>Select Expiry</h3>
    <form method="get">
        <div class="form-group">
            <label>Expiry Date:</label>
            <select name="expiry" onchange="this.form.submit()">
                {% for expiry in expiry_dates %}
                <option value="{{ expiry|date:'Y-m-d' }}" {% if expiry == selected_expiry %}selected{% endif %}>
                    {{ expiry|date:"d-M-Y" }}
                </option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>
{% endif %}

{% if option_chain %}
<div class="card">
    <h3>Option Chain for {{ selected_expiry|date:"d-M-Y" }} ({{ option_chain|length }} strikes)</h3>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th colspan="5" style="text-align: center; background-color: #e8f5e9;">CALLS</th>
                    <th style="text-align: center; background-color: #fff3e0;">STRIKE</th>
                    <th colspan="5" style="text-align: center; background-color: #ffebee;">PUTS</th>
                </tr>
                <tr>
                    <!-- Call columns -->
                    <th>OI</th>
                    <th>Volume</th>
                    <th>LTP</th>
                    <th>Bid</th>
                    <th>Ask</th>
                    <!-- Strike -->
                    <th>Price</th>
                    <!-- Put columns -->
                    <th>Ask</th>
                    <th>Bid</th>
                    <th>LTP</th>
                    <th>Volume</th>
                    <th>OI</th>
                </tr>
            </thead>
            <tbody>
                {% for oc in option_chain %}
                <tr {% if spot_price and oc.strike_price == spot_price|floatformat:0|add:"0.00" %}style="background-color: #fff9c4;"{% endif %}>
                    <!-- Call data -->
                    <td>{{ oc.call_oi|floatformat:0 }}</td>
                    <td>{{ oc.call_volume|floatformat:0 }}</td>
                    <td style="font-weight: bold;">₹{{ oc.call_ltp|floatformat:2 }}</td>
                    <td>₹{{ oc.call_bid|floatformat:2 }}</td>
                    <td>₹{{ oc.call_ask|floatformat:2 }}</td>
                    <!-- Strike -->
                    <td style="text-align: center; font-weight: bold; background-color: #f5f5f5;">{{ oc.strike_price|floatformat:2 }}</td>
                    <!-- Put data -->
                    <td>₹{{ oc.put_ask|floatformat:2 }}</td>
                    <td>₹{{ oc.put_bid|floatformat:2 }}</td>
                    <td style="font-weight: bold;">₹{{ oc.put_ltp|floatformat:2 }}</td>
                    <td>{{ oc.put_volume|floatformat:0 }}</td>
                    <td>{{ oc.put_oi|floatformat:0 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% elif not error %}
<div class="card">
    <p>No option chain data available. Click "Fetch Nifty Option Chain" to load data.</p>
</div>
{% endif %}
{% endblock %}

<!-- Strangle Order Confirmation Modal (Hidden by default) -->
<div class="modal fade" id="strangleConfirmModal" tabindex="-1" role="dialog" aria-labelledby="strangleConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px;">
    <div class="modal-content" style="max-height: 90vh; display: flex; flex-direction: column;">
      <div class="modal-header bg-warning text-dark" style="flex-shrink: 0;">
        <h5 class="modal-title" id="strangleConfirmModalLabel">
          <i class="fas fa-exclamation-triangle"></i> Confirm Strangle Trade
        </h5>
        <button type="button" class="close text-dark" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body" style="overflow-y: auto; flex: 1 1 auto;">
        <div id="strangleConfirmContent">
          <!-- Main Confirmation Message -->
          <div class="alert alert-warning">
            <h5 class="font-weight-bold mb-3">
              <i class="fas fa-question-circle"></i> Are you sure you want to take the following trade?
            </h5>
            <h6 class="font-weight-bold">Strategy: Nifty Strangle (Short)</h6>
            <p class="mb-0">Selling both Call and Put options to collect premium</p>
          </div>

          <!-- Strike Details -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                  <strong><i class="fas fa-arrow-up"></i> CALL Strike</strong>
                </div>
                <div class="card-body">
                  <h3 class="text-center mb-2" id="modal-call-strike">-</h3>
                  <p class="text-center mb-0">
                    <span class="badge badge-secondary">SELL</span>
                    <span class="badge badge-info" id="modal-call-premium">‚Çπ-</span>
                  </p>
                  <p class="text-center text-muted small mb-0" id="modal-call-symbol">-</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-success">
                <div class="card-header bg-success text-white">
                  <strong><i class="fas fa-arrow-down"></i> PUT Strike</strong>
                </div>
                <div class="card-body">
                  <h3 class="text-center mb-2" id="modal-put-strike">-</h3>
                  <p class="text-center mb-0">
                    <span class="badge badge-secondary">SELL</span>
                    <span class="badge badge-info" id="modal-put-premium">‚Çπ-</span>
                  </p>
                  <p class="text-center text-muted small mb-0" id="modal-put-symbol">-</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Trade Summary Table -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fas fa-list"></i> Trade Summary</strong>
            </div>
            <div class="card-body">
              <table class="table table-bordered table-sm mb-0">
                <tr>
                  <td class="font-weight-bold" style="width: 50%;">Spot Price:</td>
                  <td class="text-right"><strong id="modal-spot-price">‚Çπ-</strong></td>
                </tr>
                <tr class="table-light">
                  <td colspan="2" class="font-weight-bold text-center">Call Strike Details</td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Call Strike:</td>
                  <td class="text-right"><strong id="modal-call-strike-table">-</strong></td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Call Premium:</td>
                  <td class="text-right" id="modal-call-premium-table">‚Çπ-</td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Call Lots:</td>
                  <td class="text-right">
                    <input type="number" id="modal-call-lots-input" min="1" max="100"
                           style="width: 70px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 2px 5px;"
                           onchange="updateLotsFromModal()" />
                    lots (<span id="modal-call-quantity">-</span> qty)
                  </td>
                </tr>
                <tr class="table-light">
                  <td colspan="2" class="font-weight-bold text-center">Put Strike Details</td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Put Strike:</td>
                  <td class="text-right"><strong id="modal-put-strike-table">-</strong></td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Put Premium:</td>
                  <td class="text-right" id="modal-put-premium-table">‚Çπ-</td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Put Lots:</td>
                  <td class="text-right">
                    <input type="number" id="modal-put-lots-input" min="1" max="100"
                           style="width: 70px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 2px 5px;"
                           onchange="updateLotsFromModal()" />
                    lots (<span id="modal-put-quantity">-</span> qty)
                  </td>
                </tr>
                <tr class="table-light">
                  <td colspan="2" class="font-weight-bold text-center">Margin Details</td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Total Margin Required:</td>
                  <td class="text-right text-danger"><strong id="modal-total-margin-required">‚Çπ-</strong></td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Total Margin Available:</td>
                  <td class="text-right text-success"><strong id="modal-total-margin-available">‚Çπ-</strong></td>
                </tr>
                <tr class="table-success">
                  <td class="font-weight-bold">Premium Collection:</td>
                  <td class="text-right"><h5 class="mb-0 text-success" id="modal-premium-collection">‚Çπ-</h5></td>
                </tr>
              </table>
            </div>
          </div>

          <!-- Batch Execution Info -->
          <div class="alert alert-info">
            <h6 class="font-weight-bold"><i class="fas fa-info-circle"></i> Execution Details</h6>
            <p class="mb-0">
              <strong>Neo API Limit:</strong> Maximum 20 lots per order
            </p>
            <p class="mb-0 mt-1">
              Orders will be placed with <strong>20-second delays</strong> between each order.
            </p>
            <p class="mb-0 mt-2">
              <strong>Total Orders:</strong> <span id="modal-total-orders">-</span> orders
              (<span id="modal-call-orders">-</span> Call + <span id="modal-put-orders">-</span> Put)
            </p>
            <p class="mb-0 mt-1">
              <strong>Estimated Time:</strong> <span id="modal-estimated-time">-</span> seconds
            </p>
          </div>

          <!-- Final Confirmation -->
          <div class="alert alert-danger">
            <h6 class="font-weight-bold"><i class="fas fa-exclamation-circle"></i> Do you want me to place this order?</h6>
            <p class="mb-0">This will place <strong>REAL MARKET ORDERS</strong> on Kotak Securities.</p>
          </div>

          <!-- Hidden fields -->
          <input type="hidden" id="modal-suggestion-id" value="">
          <input type="hidden" id="modal-lots-value" value="">
        </div>

        <!-- Progress Section (hidden initially) -->
        <div id="strangleExecutionProgress" style="display: none;">
          <h6 class="font-weight-bold mb-3">
            <i class="fas fa-sync fa-spin" id="progress-spinner"></i> Executing Orders...
          </h6>

          <!-- Overall Progress Bar -->
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <small class="font-weight-bold">Overall Progress</small>
              <small id="overall-progress-text">0/0 batches</small>
            </div>
            <div class="progress" style="height: 30px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                   role="progressbar"
                   id="overall-progress-bar"
                   style="width: 0%"
                   aria-valuenow="0"
                   aria-valuemin="0"
                   aria-valuemax="100">
                <span id="overall-progress-percent">0%</span>
              </div>
            </div>
          </div>

          <!-- Call Orders Progress -->
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <small class="font-weight-bold">üìû Call Orders</small>
              <small id="call-progress-text">0/0 completed</small>
            </div>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar bg-danger"
                   role="progressbar"
                   id="call-progress-bar"
                   style="width: 0%"
                   aria-valuenow="0"
                   aria-valuemin="0"
                   aria-valuemax="100">
              </div>
            </div>
          </div>

          <!-- Put Orders Progress -->
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <small class="font-weight-bold">üìâ Put Orders</small>
              <small id="put-progress-text">0/0 completed</small>
            </div>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar bg-success"
                   role="progressbar"
                   id="put-progress-bar"
                   style="width: 0%"
                   aria-valuenow="0"
                   aria-valuemin="0"
                   aria-valuemax="100">
              </div>
            </div>
          </div>

          <!-- Current Batch Info -->
          <div class="alert alert-info mb-3" id="current-batch-info">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>Current Batch:</strong> <span id="current-batch-number">-</span>
              </div>
              <div>
                <strong>Lots:</strong> <span id="current-batch-lots">-</span>
              </div>
              <div>
                <strong>Qty:</strong> <span id="current-batch-qty">-</span>
              </div>
            </div>
          </div>

          <!-- Status Log -->
          <div id="batch-status-log" class="border p-3" style="max-height: 250px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #f8f9fa; border-radius: 4px;">
            <div style="color: #6c757d; font-style: italic;">Waiting for execution to start...</div>
          </div>
        </div>
      </div>

      <div class="modal-footer" style="flex-shrink: 0; border-top: 2px solid #dee2e6;">
        <button type="button" class="btn btn-secondary btn-lg" data-dismiss="modal" id="modal-cancel-btn" style="min-width: 150px;">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger btn-lg" id="modal-interrupt-btn" style="min-width: 150px; display: none;" onclick="interruptOrderExecution()">
          <i class="fas fa-stop-circle"></i> Interrupt Orders
        </button>
        <button type="button" class="btn btn-success btn-lg" id="modal-confirm-btn" style="min-width: 150px;">
          <i class="fas fa-check"></i> Confirm Order
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Strangle confirmation modal JavaScript (Vanilla JS - no jQuery dependency)
let strangleModalData = {};

// Ensure modal is hidden on page load
(function() {
    function hideModalOnLoad() {
        const modalEl = document.getElementById('strangleConfirmModal');
        if (modalEl) {
            modalEl.style.display = 'none';
            modalEl.classList.remove('show');
            modalEl.setAttribute('aria-hidden', 'true');
        }
        // Remove any backdrop that might be lingering
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(bd => bd.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', hideModalOnLoad);
    } else {
        hideModalOnLoad();
    }
})();

function showStrangleConfirmModal(suggestionData) {
    console.log('[MODAL] ========================================');
    console.log('[MODAL] showStrangleConfirmModal called');
    console.log('[MODAL] ========================================');
    console.log('[MODAL] Received data:', suggestionData);

    try {
        strangleModalData = suggestionData;

        // Validate required data
        if (!suggestionData) {
            console.error('[MODAL] ‚ùå No suggestion data provided');
            alert('Error: No suggestion data available');
            return;
        }

        console.log('[MODAL] ‚úÖ Data validation passed');

        // Populate modal with data
        console.log('[MODAL] Step 1: Extracting data fields...');
        const callStrike = suggestionData.call_strike;
        console.log('[MODAL]   call_strike:', callStrike);
        const putStrike = suggestionData.put_strike;
        console.log('[MODAL]   put_strike:', putStrike);
        const callPremium = suggestionData.call_premium;
        console.log('[MODAL]   call_premium:', callPremium);
        const putPremium = suggestionData.put_premium;
        console.log('[MODAL]   put_premium:', putPremium);
        const totalPremium = callPremium + putPremium;
        console.log('[MODAL]   total_premium:', totalPremium);
        const recommendedLots = suggestionData.recommended_lots;
        console.log('[MODAL]   recommended_lots:', recommendedLots);
        const marginPerLot = suggestionData.margin_per_lot;
        console.log('[MODAL]   margin_per_lot:', marginPerLot);
        const lotSize = 50; // NIFTY lot size
        console.log('[MODAL]   lot_size:', lotSize);

        // Format expiry - with error handling
        console.log('[MODAL] Step 2: Formatting expiry date...');
        let expiryStr = 'N/A';
        try {
            console.log('[MODAL]   expiry_date raw:', suggestionData.expiry_date);
            const expiryDate = new Date(suggestionData.expiry_date);
            console.log('[MODAL]   expiryDate object:', expiryDate);
            if (!isNaN(expiryDate.getTime())) {
                // Format: 25NOV (day first, then month)
                const day = expiryDate.getDate().toString().padStart(2, '0');
                const month = expiryDate.toLocaleDateString('en-US', {month: 'short'}).toUpperCase();
                expiryStr = day + month;
                console.log('[MODAL]   formatted expiry:', expiryStr);
            } else {
                console.warn('[MODAL]   ‚ö†Ô∏è  Invalid date');
            }
        } catch (dateErr) {
            console.error('[MODAL]   ‚ùå Date parsing error:', dateErr);
            alert('[ERROR] Date parsing failed: ' + dateErr.message);
        }

    // Build symbols
    console.log('[MODAL] Step 3: Building option symbols...');
    const callSymbol = `NIFTY${expiryStr}${callStrike}CE`;
    const putSymbol = `NIFTY${expiryStr}${putStrike}PE`;
    console.log('[MODAL]   call_symbol:', callSymbol);
    console.log('[MODAL]   put_symbol:', putSymbol);

    // Populate card display fields
    console.log('[MODAL] Step 4: Populating modal fields...');
    try {
        document.getElementById('modal-call-strike').textContent = callStrike;
        document.getElementById('modal-put-strike').textContent = putStrike;
        document.getElementById('modal-call-premium').textContent = `‚Çπ${callPremium.toFixed(2)}`;
        document.getElementById('modal-put-premium').textContent = `‚Çπ${putPremium.toFixed(2)}`;
        document.getElementById('modal-call-symbol').textContent = callSymbol;
        document.getElementById('modal-put-symbol').textContent = putSymbol;
        console.log('[MODAL]   ‚úÖ Card fields populated');
    } catch (fieldErr) {
        console.error('[MODAL]   ‚ùå Error populating fields:', fieldErr);
        alert('[ERROR] Failed to populate modal fields: ' + fieldErr.message);
        throw fieldErr;
    }

    // Populate table fields
    document.getElementById('modal-spot-price').textContent = `‚Çπ${suggestionData.spot_price.toLocaleString('en-IN', {maximumFractionDigits: 2})}`;

    document.getElementById('modal-call-strike-table').textContent = callStrike;
    document.getElementById('modal-call-premium-table').textContent = `‚Çπ${callPremium.toFixed(2)}`;
    document.getElementById('modal-call-lots-input').value = recommendedLots;
    document.getElementById('modal-call-quantity').textContent = recommendedLots * lotSize;

    document.getElementById('modal-put-strike-table').textContent = putStrike;
    document.getElementById('modal-put-premium-table').textContent = `‚Çπ${putPremium.toFixed(2)}`;
    document.getElementById('modal-put-lots-input').value = recommendedLots;
    document.getElementById('modal-put-quantity').textContent = recommendedLots * lotSize;

    const totalCollection = totalPremium * recommendedLots * lotSize;
    const totalMarginRequired = suggestionData.margin_required || (marginPerLot * recommendedLots);
    const totalMarginAvailable = suggestionData.margin_available || 0;

    document.getElementById('modal-total-margin-required').textContent = `‚Çπ${totalMarginRequired.toLocaleString('en-IN', {maximumFractionDigits: 0})}`;
    document.getElementById('modal-total-margin-available').textContent = `‚Çπ${totalMarginAvailable.toLocaleString('en-IN', {maximumFractionDigits: 0})}`;
    document.getElementById('modal-premium-collection').textContent = `‚Çπ${totalCollection.toLocaleString('en-IN', {maximumFractionDigits: 0})}`;

    // Calculate number of orders (Neo API limit: 20 lots per order)
    const ordersPerLeg = Math.ceil(recommendedLots / 20);
    const totalOrders = ordersPerLeg * 2; // Call + Put
    const estimatedTime = (ordersPerLeg - 1) * 20; // 20 sec delay between orders (only between, not after last)

    document.getElementById('modal-total-orders').textContent = totalOrders;
    document.getElementById('modal-call-orders').textContent = ordersPerLeg;
    document.getElementById('modal-put-orders').textContent = ordersPerLeg;
    document.getElementById('modal-estimated-time').textContent = estimatedTime;

    // Store in hidden fields
    document.getElementById('modal-suggestion-id').value = suggestionData.suggestion_id;
    document.getElementById('modal-lots-value').value = recommendedLots;

    // Show modal using Bootstrap's jQuery method if available, otherwise vanilla JS
    console.log('[MODAL] Step 7: Attempting to show modal...');
    const modalEl = document.getElementById('strangleConfirmModal');

    if (!modalEl) {
        console.error('[MODAL] ‚ùå Modal element #strangleConfirmModal not found!');
        alert('[ERROR] Modal element not found in DOM!');
        return;
    }

    console.log('[MODAL]   ‚úÖ Modal element found:', modalEl);

    // Try using Bootstrap's jQuery modal if available
    if (typeof $ !== 'undefined' && $.fn.modal) {
        console.log('[MODAL]   Using Bootstrap jQuery modal...');
        try {
            $(modalEl).modal('show');
            console.log('[MODAL]   ‚úÖ Bootstrap modal.show() called');
        } catch (modalShowErr) {
            console.error('[MODAL]   ‚ùå Bootstrap modal error:', modalShowErr);
            alert('[ERROR] Bootstrap modal failed: ' + modalShowErr.message);
        }
    } else {
        // Fallback to vanilla JS
        console.log('[MODAL]   jQuery not available, using vanilla JS modal...');

        // Remove any existing backdrop first
        const existingBackdrop = document.getElementById('strangleModalBackdrop');
        if (existingBackdrop) {
            existingBackdrop.remove();
        }

        // Add backdrop
        console.log('[MODAL] Creating backdrop...');
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'strangleModalBackdrop';
        document.body.appendChild(backdrop);

        // Prevent body scroll
        document.body.classList.add('modal-open');
        document.body.style.overflow = 'hidden';

        // Show modal with fade animation
        modalEl.style.display = 'block';
        modalEl.classList.add('show');
        modalEl.setAttribute('aria-modal', 'true');
        modalEl.removeAttribute('aria-hidden');

        // Close modal when clicking backdrop (use once: true to prevent duplicate handlers)
        backdrop.addEventListener('click', function() {
            closeStrangleModal();
        }, { once: true });

        // Close modal when clicking X button (remove old handlers first)
        const closeButtons = modalEl.querySelectorAll('[data-dismiss="modal"]');
        closeButtons.forEach(btn => {
            // Clone and replace to remove old event listeners
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener('click', function() {
                closeStrangleModal();
            }, { once: true });
        });
    }

        console.log('[MODAL] ‚úÖ Modal shown successfully!');

    } catch (error) {
        console.error('[MODAL] ========================================');
        console.error('[MODAL] ‚ùå FATAL ERROR IN MODAL');
        console.error('[MODAL] ========================================');
        console.error('[MODAL] Error:', error);
        console.error('[MODAL] Error message:', error.message);
        console.error('[MODAL] Stack trace:', error.stack);
        console.error('[MODAL] Suggestion data was:', suggestionData);
        console.error('[MODAL] ========================================');
        alert('‚ùå FATAL ERROR: Unable to show confirmation modal.\n\nError: ' + error.message + '\n\nPlease check browser console (F12) for full details.');
    }

    console.log('[MODAL] ========================================');
    console.log('[MODAL] Function showStrangleConfirmModal completed');
    console.log('[MODAL] ========================================');
}

function closeStrangleModal() {
    const modalEl = document.getElementById('strangleConfirmModal');

    // Try using Bootstrap's jQuery modal if available
    if (typeof $ !== 'undefined' && $.fn.modal) {
        console.log('[MODAL] Using Bootstrap jQuery modal hide');
        $(modalEl).modal('hide');
    } else {
        // Fallback to vanilla JS
        console.log('[MODAL] Using vanilla JS modal hide');
        const backdrop = document.getElementById('strangleModalBackdrop');

        // Hide modal
        modalEl.classList.remove('show');
        modalEl.setAttribute('aria-hidden', 'true');
        modalEl.removeAttribute('aria-modal');

        // Remove backdrop
        if (backdrop) {
            backdrop.remove();
        }

        // Restore body scroll
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';

        // Hide modal after animation
        setTimeout(() => {
            modalEl.style.display = 'none';
        }, 150);
    }

    // Reset modal content (works for both Bootstrap and vanilla JS)
    setTimeout(() => {
        document.getElementById('strangleConfirmContent').style.display = 'block';
        document.getElementById('strangleExecutionProgress').style.display = 'none';
        document.getElementById('modal-cancel-btn').style.display = 'inline-block';
        document.getElementById('modal-confirm-btn').style.display = 'inline-block';
        document.getElementById('modal-confirm-btn').disabled = false;
        document.getElementById('modal-confirm-btn').innerHTML = '<i class="fas fa-check"></i> Confirm Order';
    }, 200);
}

// Execute orders when Confirm button is clicked - wait for DOM to load
document.addEventListener('DOMContentLoaded', function() {
    const confirmBtn = document.getElementById('modal-confirm-btn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
            executeStrangleOrders();
        });
    }
});

// Global variable to track execution state
let executionState = {
    isRunning: false,
    shouldStop: false,
    suggestionId: null,
    totalBatches: 0,
    completedBatches: 0,
    callOrders: 0,
    putOrders: 0,
    pollInterval: null
};

function executeStrangleOrders() {
    const suggestionId = document.getElementById('modal-suggestion-id').value;
    executionState.suggestionId = suggestionId;
    executionState.isRunning = true;
    executionState.shouldStop = false;

    console.log('[EXECUTE] ========================================');
    console.log('[EXECUTE] Starting order execution for suggestion #' + suggestionId);
    console.log('[EXECUTE] Step 1: Fetching FRESH data from database...');
    console.log('[EXECUTE] ========================================');

    // Hide confirmation content, show progress
    document.getElementById('strangleConfirmContent').style.display = 'none';
    document.getElementById('strangleExecutionProgress').style.display = 'block';
    document.getElementById('modal-cancel-btn').style.display = 'none';
    document.getElementById('modal-interrupt-btn').style.display = 'inline-block';
    document.getElementById('modal-confirm-btn').disabled = true;
    document.getElementById('modal-confirm-btn').style.display = 'none';

    // Clear previous logs
    const log = document.getElementById('batch-status-log');
    log.innerHTML = '';
    addLogEntry('üîÑ Fetching latest trade parameters from database...', 'info');

    // STEP 1: Fetch fresh data from database before executing orders
    fetch(`/trading/api/suggestions/${suggestionId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Failed to fetch suggestion data: HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(freshData => {
        if (!freshData.success || !freshData.suggestion) {
            throw new Error('Failed to fetch fresh suggestion data');
        }

        const suggestion = freshData.suggestion;
        console.log('[EXECUTE] ‚úÖ Fresh data fetched from database:');
        console.log('[EXECUTE]   - Lots: ' + suggestion.recommended_lots);
        console.log('[EXECUTE]   - Call Strike: ' + suggestion.call_strike);
        console.log('[EXECUTE]   - Put Strike: ' + suggestion.put_strike);

        addLogEntry(`‚úÖ Fresh data loaded - ${suggestion.recommended_lots} lots`, 'success');
        addLogEntry(`üìä Call Strike: ${suggestion.call_strike} | Put Strike: ${suggestion.put_strike}`, 'info');

        // Use FRESH database values (not UI values)
        const totalLots = suggestion.recommended_lots;

        // Calculate batches
        const batchSize = 20;
        const totalBatches = Math.ceil(totalLots / batchSize);
        executionState.totalBatches = totalBatches;

        // Update UI with batch info
        document.getElementById('overall-progress-text').textContent = `0/${totalBatches} batches`;
        document.getElementById('call-progress-text').textContent = `0/${totalBatches} completed`;
        document.getElementById('put-progress-text').textContent = `0/${totalBatches} completed`;

        addLogEntry(`üì¶ Total batches: ${totalBatches} (${totalLots} lots √∑ ${batchSize} max per batch)`, 'info');
        addLogEntry('üöÄ Starting order execution...', 'info');

        // STEP 2: Create execution control record
        return fetch('/trading/api/create-execution-control/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                suggestion_id: suggestionId,
                total_batches: totalBatches
            })
        })
        .then(res => res.json())
        .then(() => {
            // STEP 3: Execute orders with fresh data
            return fetch('/trading/trigger/execute-strangle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `suggestion_id=${suggestionId}&total_lots=${totalLots}`
            });
        });
    })
    .then(response => {
        console.log('[EXECUTE] Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('[EXECUTE] Response data:', data);
        if (data.success) {
            console.log('[EXECUTE] ‚úÖ Orders executed successfully!');
            showExecutionComplete(data);
        } else {
            console.error('[EXECUTE] ‚ùå Order execution failed:', data.error);
            showExecutionError(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('[EXECUTE] ‚ùå Error:', error);
        showExecutionError('Error: ' + error.message);
    });

    // Start polling for progress updates
    startProgressPolling(suggestionId);
}

function startProgressPolling(suggestionId) {
    // Poll every 2 seconds for progress updates
    executionState.pollInterval = setInterval(() => {
        if (!executionState.isRunning) {
            clearInterval(executionState.pollInterval);
            return;
        }

        fetch(`/trading/api/execution-progress/${suggestionId}/`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateProgressUI(data.progress);
                }
            })
            .catch(err => {
                console.error('Error polling progress:', err);
            });
    }, 2000);
}

function updateProgressUI(progress) {
    const { batches_completed, total_batches, call_orders, put_orders, current_batch, is_cancelled } = progress;

    // Update overall progress
    const overallPercent = total_batches > 0 ? (batches_completed / total_batches) * 100 : 0;
    document.getElementById('overall-progress-bar').style.width = overallPercent + '%';
    document.getElementById('overall-progress-percent').textContent = Math.round(overallPercent) + '%';
    document.getElementById('overall-progress-text').textContent = `${batches_completed}/${total_batches} batches`;

    // Update call/put progress
    const callPercent = total_batches > 0 ? (call_orders / total_batches) * 100 : 0;
    const putPercent = total_batches > 0 ? (put_orders / total_batches) * 100 : 0;

    document.getElementById('call-progress-bar').style.width = callPercent + '%';
    document.getElementById('put-progress-bar').style.width = putPercent + '%';
    document.getElementById('call-progress-text').textContent = `${call_orders}/${total_batches} completed`;
    document.getElementById('put-progress-text').textContent = `${put_orders}/${total_batches} completed`;

    // Update current batch info
    if (current_batch) {
        document.getElementById('current-batch-number').textContent = `${current_batch.batch_num}/${total_batches}`;
        document.getElementById('current-batch-lots').textContent = current_batch.lots || '-';
        document.getElementById('current-batch-qty').textContent = current_batch.quantity || '-';
    }

    // Check if cancelled
    if (is_cancelled) {
        executionState.isRunning = false;
        clearInterval(executionState.pollInterval);
        addLogEntry('üõë Execution interrupted by user', 'warning');
    }
}

function addLogEntry(message, type = 'info') {
    const log = document.getElementById('batch-status-log');
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
        'info': '#17a2b8',
        'success': '#28a745',
        'warning': '#ffc107',
        'error': '#dc3545'
    };

    const color = colors[type] || colors['info'];
    const entry = document.createElement('div');
    entry.style.color = color;
    entry.style.marginBottom = '4px';
    entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

function interruptOrderExecution() {
    if (!confirm('‚ö†Ô∏è Are you sure you want to interrupt order execution?\n\nThis will stop placing any remaining orders.')) {
        return;
    }

    const suggestionId = executionState.suggestionId;
    addLogEntry('üõë Sending interrupt signal...', 'warning');

    fetch('/trading/api/cancel-execution/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            suggestion_id: suggestionId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLogEntry('‚úÖ Interrupt signal sent successfully', 'success');
            addLogEntry('‚è≥ Waiting for current batch to complete...', 'info');
            executionState.shouldStop = true;

            // Disable interrupt button
            const btn = document.getElementById('modal-interrupt-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-check"></i> Interrupted';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-secondary');
        } else {
            addLogEntry('‚ùå Failed to interrupt: ' + data.error, 'error');
            alert('Failed to interrupt execution: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error interrupting execution:', error);
        addLogEntry('‚ùå Network error during interrupt', 'error');
        alert('Network error while trying to interrupt');
    });
}

function showExecutionComplete(data) {
    executionState.isRunning = false;
    clearInterval(executionState.pollInterval);

    addLogEntry('‚úÖ All orders executed successfully!', 'success');

    if (data.batch_result && data.batch_result.summary) {
        addLogEntry(`üìä Summary: ${data.batch_result.summary.call_success_count} call orders, ${data.batch_result.summary.put_success_count} put orders`, 'success');
    }

    // Stop spinner
    document.getElementById('progress-spinner').classList.remove('fa-spin');

    // Update buttons
    document.getElementById('modal-interrupt-btn').style.display = 'none';
    document.getElementById('modal-cancel-btn').style.display = 'inline-block';
    document.getElementById('modal-cancel-btn').textContent = 'Close';
    document.getElementById('modal-cancel-btn').classList.remove('btn-secondary');
    document.getElementById('modal-cancel-btn').classList.add('btn-success');
}

function showExecutionError(error) {
    executionState.isRunning = false;
    clearInterval(executionState.pollInterval);

    addLogEntry(`‚ùå Error: ${error}`, 'error');

    // Stop spinner
    document.getElementById('progress-spinner').classList.remove('fa-spin');

    // Update buttons
    document.getElementById('modal-interrupt-btn').style.display = 'none';
    document.getElementById('modal-cancel-btn').style.display = 'inline-block';
    document.getElementById('modal-cancel-btn').textContent = 'Close';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Update lots when user edits in modal - save to database immediately
function updateLotsFromModal() {
    const suggestionId = document.getElementById('modal-suggestion-id').value;
    const callLotsInput = document.getElementById('modal-call-lots-input');
    const putLotsInput = document.getElementById('modal-put-lots-input');

    const newLots = parseInt(callLotsInput.value);
    const lotSize = 50; // NIFTY lot size

    // Sync both inputs (call and put should be same for strangle)
    callLotsInput.value = newLots;
    putLotsInput.value = newLots;

    // Update quantity displays
    document.getElementById('modal-call-quantity').textContent = newLots * lotSize;
    document.getElementById('modal-put-quantity').textContent = newLots * lotSize;

    // Update hidden field
    document.getElementById('modal-lots-value').value = newLots;

    // Save to database
    console.log(`[EDIT] Saving lots change to database: ${newLots} lots for suggestion #${suggestionId}`);

    fetch('/trading/api/suggestions/update-parameters/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            suggestion_id: suggestionId,
            recommended_lots: newLots
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('[EDIT] ‚úÖ Database updated:', data.message);

            // Update margin displays with recalculated values
            if (data.suggestion && data.suggestion.margin_required) {
                document.getElementById('modal-total-margin-required').textContent =
                    `‚Çπ${data.suggestion.margin_required.toLocaleString('en-IN', {maximumFractionDigits: 0})}`;
            }

            // Show brief success indicator
            callLotsInput.style.borderColor = '#10B981';
            putLotsInput.style.borderColor = '#10B981';
            setTimeout(() => {
                callLotsInput.style.borderColor = '#ddd';
                putLotsInput.style.borderColor = '#ddd';
            }, 1000);
        } else {
            console.error('[EDIT] ‚ùå Failed to update database:', data.error);
            alert('Failed to save changes: ' + data.error);

            // Revert to original value if save failed
            const originalLots = strangleModalData.recommended_lots || 1;
            callLotsInput.value = originalLots;
            putLotsInput.value = originalLots;
        }
    })
    .catch(error => {
        console.error('[EDIT] ‚ùå Network error:', error);
        alert('Network error while saving changes');
    });
}
</script>

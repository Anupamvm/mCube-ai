{% extends "core/master_base.html" %}
{% load static %}

{% block title %}Manual Trade Triggers - mCube Trading{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: var(--white);
        padding: 2rem 0;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-sm);
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0 0 0.5rem 0;
    }

    .page-subtitle {
        color: var(--gray);
        margin: 0;
    }

    .triggers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .trigger-card {
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-md);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .trigger-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .trigger-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .trigger-icon {
        font-size: 2.5rem;
    }

    .trigger-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0;
    }

    .trigger-description {
        color: var(--gray);
        margin: 0 0 1.5rem 0;
        line-height: 1.6;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--dark);
    }

    .form-select {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid var(--gray-light);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
        width: 100%;
    }

    .btn-primary {
        background: var(--primary);
        color: var(--white);
    }

    .btn-primary:hover:not(:disabled) {
        background: var(--primary-hover);
        transform: translateY(-1px);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-success {
        background: var(--success);
        color: var(--white);
    }

    .btn-success:hover {
        background: var(--success-hover);
    }

    .btn-secondary {
        background: var(--white);
        color: var(--dark);
        border: 1px solid var(--gray-light);
    }

    .btn-secondary:hover {
        background: var(--light);
    }

    .loading-spinner {
        display: none;
        margin-top: 1rem;
        text-align: center;
        color: var(--primary);
    }

    .loading-spinner.active {
        display: block;
    }

    .result-panel {
        display: none;
        margin-top: 2rem;
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-md);
    }

    .result-panel.active {
        display: block;
    }

    .result-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--light);
        margin-bottom: 1.5rem;
    }

    .result-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        flex: 1;
    }

    .result-badge {
        padding: 0.5rem 1rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
    }

    .result-badge.pass {
        background: #D1FAE5;
        color: #065F46;
    }

    .result-badge.fail {
        background: #FEE2E2;
        color: #991B1B;
    }

    .result-section {
        margin-bottom: 2rem;
    }

    .result-section h3 {
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0 0 1rem 0;
        color: var(--dark);
    }

    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .result-item {
        background: var(--lighter);
        padding: 1rem;
        border-radius: var(--radius-md);
    }

    .result-item-label {
        font-size: 0.75rem;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .result-item-value {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--dark);
    }

    .explanation-box {
        background: #F0F9FF;
        border-left: 4px solid var(--primary);
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-top: 1rem;
    }

    .explanation-box h4 {
        margin: 0 0 0.5rem 0;
        color: var(--primary);
        font-size: 1rem;
    }

    .explanation-box p {
        margin: 0.5rem 0;
        line-height: 1.6;
        color: var(--dark);
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .error-message {
        background: #FEE2E2;
        color: #991B1B;
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-top: 1rem;
        border-left: 4px solid var(--danger);
    }

    /* Breeze Login Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: var(--radius-lg);
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        margin-bottom: 1.5rem;
    }

    .modal-header h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        color: var(--dark);
    }

    .modal-header p {
        margin: 0;
        color: var(--gray);
        font-size: 0.875rem;
    }

    .modal-body {
        margin-bottom: 1.5rem;
    }

    .modal-body .form-group {
        margin-bottom: 1rem;
    }

    .modal-body .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--dark);
    }

    .modal-body .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--gray-light);
        border-radius: var(--radius-md);
        font-size: 1rem;
    }

    .modal-body .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .modal-footer {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .modal-error {
        background: #FEE2E2;
        color: #991B1B;
        padding: 0.75rem;
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }

    .modal-success {
        background: #D1FAE5;
        color: #065F46;
        padding: 0.75rem;
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }

    @media (max-width: 768px) {
        .triggers-grid {
            grid-template-columns: 1fr;
        }

        .result-grid {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">Manual Trade Triggers</h1>
        <p class="page-subtitle">Manually run trading algorithms and get detailed analysis</p>
    </div>
</div>

<div class="container">
    <div class="triggers-grid">
        <!-- 1. Run Futures Algorithm -->
        <div class="trigger-card">
            <div class="trigger-header">
                <span class="trigger-icon">üéØ</span>
                <h2 class="trigger-title">Futures Algorithm</h2>
            </div>
            <p class="trigger-description">
                Runs the complete futures screening algorithm to find the top 3 trading opportunities.
                Uses multi-factor analysis (OI, sector strength, technical indicators) with volume filtering.
            </p>

            <!-- Volume Threshold Inputs -->
            <div class="form-group" style="background: var(--lighter); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                <label class="form-label" style="margin-bottom: 0.75rem;">üìä Volume Filters (OR Logic)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <div>
                        <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem; color: var(--gray);">This Month Volume (‚â•)</label>
                        <input type="number" class="form-select" id="futuresThisMonthVolume" value="1000" min="0" step="100" style="padding: 0.5rem;" placeholder="e.g., 1000">
                    </div>
                    <div>
                        <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem; color: var(--gray);">Next Month Volume (‚â•)</label>
                        <input type="number" class="form-select" id="futuresNextMonthVolume" value="800" min="0" step="100" style="padding: 0.5rem;" placeholder="e.g., 800">
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: var(--gray); margin: 0.5rem 0 0 0;">
                    üí° Tip: Algorithm analyzes all contracts meeting volume criteria and returns top 3 opportunities.
                </p>
            </div>

            <button class="btn btn-primary" onclick="runFuturesAlgorithm(this)" id="btnFutures">
                Run Futures Screening
            </button>
            <div class="loading-spinner" id="loadingFutures">
                <div>‚è≥ Analyzing stocks...</div>
            </div>
        </div>

        <!-- 2. Nifty Options Strangle -->
        <div class="trigger-card">
            <div class="trigger-header">
                <span class="trigger-icon">üìä</span>
                <h2 class="trigger-title">Nifty Strangle</h2>
            </div>
            <p class="trigger-description">
                Generates a Nifty weekly strangle position for your Kotak account.
                Calculates optimal strikes based on current market conditions and VIX.
            </p>
            <button class="btn btn-primary" onclick="runNiftyStrangle(this)" id="btnStrangle">
                Generate Strangle Position
            </button>
            <div class="loading-spinner" id="loadingStrangle">
                <div>‚è≥ Calculating strikes...</div>
            </div>
        </div>

        <!-- 3. Verify Future Trade -->
        <div class="trigger-card">
            <div class="trigger-header">
                <span class="trigger-icon">‚úÖ</span>
                <h2 class="trigger-title">Verify Future Trade</h2>
            </div>
            <p class="trigger-description">
                Verify a specific futures contract for trading. Adjust volume thresholds to filter contracts and get complete analysis with pass/fail verdict.
            </p>

            <!-- Volume Threshold Inputs -->
            <div class="form-group" style="background: var(--lighter); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                <label class="form-label" style="margin-bottom: 0.75rem;">üìä Volume Filters (OR Logic)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div>
                        <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem; color: var(--gray);">This Month Volume (‚â•)</label>
                        <input type="number" class="form-select" id="thisMonthVolume" value="1000" min="0" step="100" style="padding: 0.5rem;" placeholder="e.g., 1000">
                    </div>
                    <div>
                        <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem; color: var(--gray);">Next Month Volume (‚â•)</label>
                        <input type="number" class="form-select" id="nextMonthVolume" value="800" min="0" step="100" style="padding: 0.5rem;" placeholder="e.g., 800">
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: var(--gray); margin: 0 0 0.75rem 0;">
                    üí° Tip: Lower values = more contracts. Try 500/400 for smaller volume stocks.
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <button class="btn btn-secondary" onclick="refreshContractList()" id="btnRefreshContracts" style="margin-bottom: 0; font-size: 0.8rem;" title="Query local database with volume filters (fast)">
                        üîÑ Update List
                    </button>
                    <button class="btn btn-primary" onclick="fetchAndUpdateTrendlyne()" id="btnFetchTrendlyne" style="margin-bottom: 0; font-size: 0.8rem;" title="Download fresh data from Trendlyne (2-3 mins)">
                        üì• Fetch Fresh Data
                    </button>
                </div>
                <p style="font-size: 0.7rem; color: var(--gray); margin: 0.5rem 0 0 0; font-style: italic;">
                    <strong>Update List</strong>: Filter existing data | <strong>Fetch Fresh Data</strong>: Download from Trendlyne (2-3 min)
                </p>
            </div>

            <div class="form-group">
                <label class="form-label" for="contractSelect">Select Futures Contract (<span id="contractCount">{{ total_contracts|default:"0" }}</span> contracts available)</label>
                <select class="form-select" id="contractSelect">
                    <option value="">-- Select a contract --</option>
                    {% for contract in futures_contracts %}
                    <option value="{{ contract.value }}"
                            data-volume="{{ contract.volume }}"
                            data-price="{{ contract.price }}"
                            data-lot="{{ contract.lot_size }}">
                        {{ contract.display }} (Vol: {{ contract.volume }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <button class="btn btn-primary" onclick="verifyFutureTrade(this)" id="btnVerify">
                Verify Trade
            </button>
            <div class="loading-spinner" id="loadingVerify">
                <div>‚è≥ Analyzing <span id="verifyingStock"></span>...</div>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="result-panel" id="resultsPanel">
        <div class="result-header">
            <h2 class="result-title" id="resultTitle">Analysis Results</h2>
            <span class="result-badge" id="resultBadge"></span>
        </div>
        <div id="resultContent"></div>
    </div>
</div>

<!-- Breeze Login Modal -->
<div class="modal-overlay" id="breezeLoginModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üîê Breeze Re-Authentication Required</h2>
            <p>Your Breeze session has expired. Please enter your new session token to continue.</p>
        </div>
        <div class="modal-body">
            <div id="modalMessage"></div>
            <div class="form-group">
                <label class="form-label" for="sessionTokenInput">Session Token</label>
                <input
                    type="text"
                    id="sessionTokenInput"
                    class="form-input"
                    placeholder="Enter Breeze session token"
                    autocomplete="off"
                />
                <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.5rem;">
                    üí° <a href="https://api.icicidirect.com/apiuser/home" target="_blank" style="color: var(--primary); text-decoration: underline;">Click here to get your session token</a>
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeBreezeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateBreezeSession()" id="updateSessionBtn">
                Update & Retry
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // CSRF token for POST requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Global variable to store the pending request for retry after re-auth
    let pendingRequest = null;

    // Breeze Authentication Modal Functions
    function showBreezeLoginModal(pendingRequestData) {
        pendingRequest = pendingRequestData;
        document.getElementById('breezeLoginModal').classList.add('active');
        document.getElementById('sessionTokenInput').value = '';
        document.getElementById('modalMessage').innerHTML = '';
        document.getElementById('sessionTokenInput').focus();
    }

    function closeBreezeModal() {
        document.getElementById('breezeLoginModal').classList.remove('active');
        pendingRequest = null;
    }

    async function updateBreezeSession() {
        const sessionToken = document.getElementById('sessionTokenInput').value.trim();
        const btn = document.getElementById('updateSessionBtn');
        const messageDiv = document.getElementById('modalMessage');

        if (!sessionToken) {
            messageDiv.innerHTML = '<div class="modal-error">Please enter a session token</div>';
            return;
        }

        btn.disabled = true;
        btn.textContent = '‚è≥ Updating...';
        messageDiv.innerHTML = '';

        try {
            const response = await fetch('{% url "trading:update_breeze_session" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ session_token: sessionToken })
            });

            const data = await response.json();

            if (data.success) {
                messageDiv.innerHTML = '<div class="modal-success">‚úÖ Session updated successfully! Retrying request...</div>';

                // Wait a moment then close modal and retry
                setTimeout(async () => {
                    closeBreezeModal();

                    // Retry the original request
                    if (pendingRequest) {
                        await retryRequest(pendingRequest);
                    }
                }, 1000);
            } else {
                messageDiv.innerHTML = `<div class="modal-error">‚ùå ${data.error}</div>`;
                btn.disabled = false;
                btn.textContent = 'Update & Retry';
            }
        } catch (error) {
            messageDiv.innerHTML = `<div class="modal-error">‚ùå Network error: ${error.message}</div>`;
            btn.disabled = false;
            btn.textContent = 'Update & Retry';
        }
    }

    async function retryRequest(requestData) {
        // Retry the original request based on request type
        const { type, params } = requestData;

        if (type === 'futures_algorithm') {
            const btn = document.getElementById('btnFutures');
            await runFuturesAlgorithm(btn, params.confirmed);
        } else if (type === 'verify_trade') {
            const btn = document.getElementById('btnVerify');
            await verifyFutureTrade(btn);
        } else if (type === 'nifty_strangle') {
            const btn = document.getElementById('btnStrangle');
            await runNiftyStrangle(btn);
        }
    }

    // Handle authentication errors in responses
    function handleAuthError(data, requestType, params = {}) {
        if (data.auth_required) {
            showBreezeLoginModal({
                type: requestType,
                params: params
            });
            return true;
        }
        return false;
    }

    // Refresh Contract List from Local DB (fast operation)
    // This just queries the existing database with new volume filters
    async function refreshContractList() {
        const thisMonthVol = document.getElementById('thisMonthVolume').value || 1000;
        const nextMonthVol = document.getElementById('nextMonthVolume').value || 800;
        const btn = document.getElementById('btnRefreshContracts');

        btn.disabled = true;
        btn.textContent = '‚è≥ Updating...';

        try {
            const response = await fetch('{% url "trading:get_contracts" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    this_month_volume: parseInt(thisMonthVol),
                    next_month_volume: parseInt(nextMonthVol)
                })
            });

            const data = await response.json();

            if (data.success) {
                // Update dropdown with new contract list
                const select = document.getElementById('contractSelect');
                select.innerHTML = '<option value="">-- Select a contract --</option>';

                data.contracts.forEach(contract => {
                    const option = document.createElement('option');
                    option.value = contract.value;
                    option.setAttribute('data-volume', contract.volume);
                    option.setAttribute('data-price', contract.price || 0);
                    option.setAttribute('data-lot', contract.lot_size || 0);
                    option.textContent = `${contract.display} (Vol: ${contract.volume})`;
                    select.appendChild(option);
                });

                // Update count
                document.getElementById('contractCount').textContent = data.total_contracts;

                btn.textContent = '‚úÖ Updated';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Update List';
                }, 2000);
            } else {
                alert('Error updating contracts: ' + data.error);
                btn.textContent = 'üîÑ Update List';
            }
        } catch (error) {
            alert('Network error: ' + error.message);
            btn.textContent = 'üîÑ Update List';
        } finally {
            btn.disabled = false;
        }
    }

    // Fetch Fresh Data from Trendlyne (slow operation - webscraping)
    // This downloads latest F&O data from Trendlyne and updates the dropdown
    async function fetchAndUpdateTrendlyne() {
        const thisMonthVol = document.getElementById('thisMonthVolume').value || 1000;
        const nextMonthVol = document.getElementById('nextMonthVolume').value || 800;
        const btn = document.getElementById('btnFetchTrendlyne');
        const updateBtn = document.getElementById('btnRefreshContracts');
        const selectElement = document.getElementById('contractSelect');

        // Disable both buttons during fetch
        btn.disabled = true;
        updateBtn.disabled = true;
        btn.textContent = '‚è≥ Fetching...';

        // Show wait message in dropdown
        selectElement.innerHTML = '<option value="">‚è≥ Downloading Trendlyne data... Please wait 2-3 minutes...</option>';

        try {
            const response = await fetch('{% url "trading:refresh_trendlyne" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data_type: 'fno'
                })
            });

            const data = await response.json();

            if (data.success) {
                btn.textContent = '‚úÖ Fetched';
                selectElement.innerHTML = '<option value="">‚úÖ Data downloaded! Updating list...</option>';

                // Now refresh the contract list with current volume filters
                setTimeout(async () => {
                    await refreshContractList();
                    btn.textContent = 'üì• Fetch Trendlyne';
                }, 1000);
            } else {
                selectElement.innerHTML = `<option value="">‚ùå Error: ${data.error}</option>`;
                btn.textContent = 'üì• Fetch Trendlyne';
                alert('Error fetching Trendlyne data: ' + data.error);
            }
        } catch (error) {
            selectElement.innerHTML = `<option value="">‚ùå Network error occurred</option>`;
            btn.textContent = 'üì• Fetch Trendlyne';
            alert('Network error: ' + error.message);
        } finally {
            btn.disabled = false;
            updateBtn.disabled = false;
        }
    }

    // 1. Run Futures Algorithm
    async function runFuturesAlgorithm(btn, confirmed = false) {
        console.log('[Futures] runFuturesAlgorithm called with confirmed=', confirmed);

        const thisMonthVol = document.getElementById('futuresThisMonthVolume').value || 1000;
        const nextMonthVol = document.getElementById('futuresNextMonthVolume').value || 800;

        console.log('[Futures] Volume filters:', { thisMonthVol, nextMonthVol });

        btn.disabled = true;
        document.getElementById('loadingFutures').classList.add('active');
        document.getElementById('resultsPanel').classList.remove('active');

        try {
            const response = await fetch('{% url "trading:trigger_futures" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    this_month_volume: parseInt(thisMonthVol),
                    next_month_volume: parseInt(nextMonthVol),
                    confirmed: confirmed
                })
            });

            const data = await response.json();

            // Debug logging
            console.log('Futures algorithm response:', data);

            // Check for authentication error
            if (handleAuthError(data, 'futures_algorithm', { confirmed })) {
                return;
            }

            if (data.success) {
                displayFuturesTop3Result(data);
            } else if (data.requires_confirmation) {
                // Stop spinner during confirmation dialog
                document.getElementById('loadingFutures').classList.remove('active');
                btn.disabled = false;

                console.log('[Futures] Showing confirmation dialog for', data.contract_count, 'contracts');

                // Ask user for confirmation
                const userConfirmed = confirm(
                    `${data.message}\n\n` +
                    `Contracts found: ${data.contract_count}\n` +
                    `This will analyze ALL contracts and may take several minutes.\n\n` +
                    `Click OK to proceed or Cancel to adjust filters.`
                );

                console.log('[Futures] User confirmed:', userConfirmed);

                if (userConfirmed) {
                    console.log('[Futures] Re-running with confirmation=true');
                    // Re-run with confirmation
                    await runFuturesAlgorithm(btn, true);
                    return;
                } else {
                    console.log('[Futures] User cancelled');
                    displayError('Analysis cancelled. Please adjust volume filters to reduce contract count.');
                }
            } else {
                console.error('[Futures] Unexpected response:', data);
                displayError(data.error || data.message || 'Failed to run futures algorithm. Please check console for details.');
            }
        } catch (error) {
            displayError('Network error: ' + error.message);
        } finally {
            btn.disabled = false;
            document.getElementById('loadingFutures').classList.remove('active');
        }
    }

    function buildFullPositionSizingUI(suggestion, index) {
        // Extract data from suggestion
        const recommendedLots = suggestion.recommended_lots || 1;
        const marginRequired = suggestion.margin_required || 0;
        const marginAvailable = suggestion.margin_available || 0;
        const marginPerLot = suggestion.margin_per_lot || 0;
        const marginUtilization = suggestion.margin_utilization || 0;
        const entryValue = suggestion.entry_value || 0;
        const futuresPrice = suggestion.futures_price || 0;
        const stopLoss = suggestion.stop_loss || 0;
        const target = suggestion.target || 0;
        const direction = (suggestion.direction || 'LONG').toUpperCase();
        const stockSymbol = suggestion.stock_symbol || '';
        const lotSize = suggestion.lot_size || 1;
        const maxLotsPossible = Math.floor(marginAvailable / marginPerLot) || 1;
        const suggestionId = suggestion.id;

        // Calculate risk/reward per lot
        const riskPerLot = Math.abs(futuresPrice - stopLoss) * lotSize;
        const rewardPerLot = Math.abs(target - futuresPrice) * lotSize;

        // Store data globally for interactive updates
        window[`algoFuturesData${index}`] = {
            recommendedLots,
            marginPerLot,
            marginAvailable,
            futuresPrice,
            lotSize,
            riskPerLot,
            rewardPerLot,
            stopLoss,
            target,
            direction,
            index
        };

        return `
            <div class="result-section" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 2rem; border-radius: var(--radius-lg); margin-bottom: 0;">
                <h3 style="color: white; margin-bottom: 1.5rem; font-size: 1.3rem;">
                    üìä Position Sizing & Risk Analysis
                </h3>

                <!-- Main Position Info with Interactive Slider -->
                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                    <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üéØ Initial Position (50% of Available Margin)</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Recommended Lots</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="algo${index}RecommendedLots">${recommendedLots}</div>
                            <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.25rem;">${lotSize * recommendedLots} shares</div>
                            <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.15rem; word-break: break-all;" id="algo${index}TotalStockValue">‚Çπ${formatIndianNumber(lotSize * recommendedLots * futuresPrice)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Margin Required</div>
                            <div style="font-size: 1.2rem; font-weight: 700; word-break: break-all;" id="algo${index}MarginRequired">‚Çπ${formatIndianNumber(marginRequired)}</div>
                            <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.25rem;"><span id="algo${index}MarginUtil">${marginUtilization.toFixed(1)}</span>% used</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Entry Value</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #FEF3C7; word-break: break-all;" id="algo${index}EntryValue">‚Çπ${formatIndianNumber(entryValue)}</div>
                            <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.25rem;">@ ‚Çπ${futuresPrice.toFixed(2)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Max Risk</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #FEE2E2; word-break: break-all;" id="algo${index}MaxRisk">‚Çπ${formatIndianNumber(riskPerLot * recommendedLots)}</div>
                            <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.25rem;">to SL @ ‚Çπ${stopLoss.toFixed(2)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Max Profit</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #D1FAE5; word-break: break-all;" id="algo${index}MaxProfit">‚Çπ${formatIndianNumber(rewardPerLot * recommendedLots)}</div>
                            <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.25rem;">at Target @ ‚Çπ${target.toFixed(2)}</div>
                        </div>
                    </div>

                    <!-- Interactive Lot Adjustment Slider -->
                    <div style="background: rgba(255,255,255,0.1); padding: 1.25rem; border-radius: var(--radius-md);">
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">
                            üéöÔ∏è Adjust Number of Lots
                        </label>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button onclick="adjustAlgoLots(${index}, -1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: var(--radius-md); font-size: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚àí</button>
                            <input type="range" id="algo${index}LotsSlider" min="1" max="${maxLotsPossible}" value="${recommendedLots}"
                                   oninput="updateAlgoCalculations(${index}, this.value)"
                                   style="flex: 1; height: 8px; border-radius: 4px; outline: none; -webkit-appearance: none; background: rgba(255,255,255,0.3);">
                            <button onclick="adjustAlgoLots(${index}, 1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: var(--radius-md); font-size: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">+</button>
                            <input type="number" id="algo${index}LotsInput" value="${recommendedLots}" min="1" max="${maxLotsPossible}"
                                   onchange="updateAlgoCalculations(${index}, this.value)"
                                   style="width: 80px; background: rgba(255,255,255,0.9); border: none; padding: 0.5rem; border-radius: var(--radius-md); font-size: 1.1rem; font-weight: 700; text-align: center; color: #1F2937;">
                        </div>
                        <div style="margin-top: 1rem; font-size: 0.75rem; opacity: 0.8; text-align: center;">
                            Max lots with 50% margin: ${maxLotsPossible} lots | Available Margin: ‚Çπ${(marginAvailable / 100000).toFixed(1)}L
                        </div>
                    </div>

                    <!-- Margin Breakdown from Breeze API -->
                    <div style="background: rgba(255,255,255,0.1); padding: 1.25rem; border-radius: var(--radius-md); margin-top: 1rem;">
                        <h4 style="color: white; font-size: 0.95rem; margin-bottom: 1rem; opacity: 0.9;">üí∞ Margin Breakdown (Breeze API)</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; font-size: 0.85rem;">
                            <div>
                                <div style="opacity: 0.8; margin-bottom: 0.25rem;">Available Margin</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${formatIndianNumber(marginAvailable)}</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; margin-bottom: 0.25rem;">Used Margin</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${formatIndianNumber(marginRequired)}</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; margin-bottom: 0.25rem;">Margin per Lot</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${formatIndianNumber(marginPerLot)}</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; font-size: 0.75rem; opacity: 0.8; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: var(--radius-sm);">
                            <strong>üìê 50% Safety Rule:</strong> Initial position uses ‚Çπ${formatIndianNumber(marginAvailable * 0.5)} (50% of available). Remaining 50% reserved for averaging (2 more positions).
                        </div>
                    </div>
                </div>

                <!-- Averaging Strategy -->
                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                    <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üîÑ Averaging Strategy (3 Levels)</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                        <!-- Level 1: Initial Position -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                üìç Level 1: Entry
                            </div>
                            <div style="font-size: 0.75rem; margin-bottom: 0.5rem; opacity: 0.8;">
                                Price: ‚Çπ${futuresPrice.toFixed(2)}<br>
                                Lots: <span id="algo${index}Avg1Lots">${recommendedLots}</span>
                            </div>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.75rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Margin:</span>
                                    <span style="font-weight: 700;" id="algo${index}Avg1Margin">‚Çπ${formatIndianNumber(marginPerLot * recommendedLots)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Level 2: First Averaging -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                üìç Level 2: -2% Averaging
                            </div>
                            <div style="font-size: 0.75rem; margin-bottom: 0.5rem; opacity: 0.8;">
                                Price: ‚Çπ${(futuresPrice * 0.98).toFixed(2)}<br>
                                Add Lots: <span id="algo${index}Avg2Lots">${Math.ceil(recommendedLots * 0.5)}</span>
                            </div>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                    <span>Add Margin:</span>
                                    <span style="font-weight: 700;" id="algo${index}Avg2Margin">‚Çπ${formatIndianNumber(marginPerLot * Math.ceil(recommendedLots * 0.5))}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Total Lots:</span>
                                    <span style="font-weight: 700; color: #D1FAE5;" id="algo${index}Avg2Total">${recommendedLots + Math.ceil(recommendedLots * 0.5)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Level 3: Second Averaging -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                üìç Level 3: -4% Averaging
                            </div>
                            <div style="font-size: 0.75rem; margin-bottom: 0.5rem; opacity: 0.8;">
                                Price: ‚Çπ${(futuresPrice * 0.96).toFixed(2)}<br>
                                Add Lots: <span id="algo${index}Avg3Lots">${Math.ceil(recommendedLots * 0.5)}</span>
                            </div>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                    <span>Add Margin:</span>
                                    <span style="font-weight: 700;" id="algo${index}Avg3Margin">‚Çπ${formatIndianNumber(marginPerLot * Math.ceil(recommendedLots * 0.5))}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Total Lots:</span>
                                    <span style="font-weight: 700; color: #D1FAE5;" id="algo${index}Avg3Total">${recommendedLots + Math.ceil(recommendedLots * 0.5) * 2}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.08); padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem; font-size: 0.85rem;">
                        <strong>üí° Strategy:</strong> Start with <span id="algo${index}AvgSummaryInitial">${recommendedLots}</span> lots. If price drops, add 50% more lots at -2% and -4% levels to average down your entry price while managing risk.
                    </div>
                </div>

                <!-- P&L Scenarios -->
                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                    <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üí∞ P&L Scenarios (Initial Position)</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem;">
                        <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At Target (+${((target - futuresPrice) / futuresPrice * 100).toFixed(1)}%)</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #D1FAE5;" id="algo${index}PnlTarget">‚Çπ${formatIndianNumber(rewardPerLot * recommendedLots)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At +2%</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #D1FAE5;" id="algo${index}PnlPlus2">‚Çπ${formatIndianNumber(futuresPrice * 0.02 * lotSize * recommendedLots)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At +1%</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #D1FAE5;" id="algo${index}PnlPlus1">‚Çπ${formatIndianNumber(futuresPrice * 0.01 * lotSize * recommendedLots)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At -1%</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #FEE2E2;" id="algo${index}PnlMinus1">-‚Çπ${formatIndianNumber(futuresPrice * 0.01 * lotSize * recommendedLots)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At -2%</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #FEE2E2;" id="algo${index}PnlMinus2">-‚Çπ${formatIndianNumber(futuresPrice * 0.02 * lotSize * recommendedLots)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At Stop Loss (${((stopLoss - futuresPrice) / futuresPrice * 100).toFixed(1)}%)</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #FEE2E2;" id="algo${index}PnlStopLoss">-‚Çπ${formatIndianNumber(riskPerLot * recommendedLots)}</div>
                        </div>
                    </div>
                </div>

                <!-- Take Trade Button -->
                <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); text-align: center;">
                    <button
                        id="algoTakeTradeBtn${index}"
                        style="background: white; color: #2563eb; border: none; padding: 1rem 2rem; border-radius: var(--radius-md); font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
                        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)';"
                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                        üöÄ Take This Trade (#${suggestionId})
                    </button>
                    <div style="margin-top: 1rem; font-size: 0.85rem; opacity: 0.9;">
                        Place ${direction} order for ${stockSymbol} | <span id="algo${index}DisplayLots">${recommendedLots}</span> lots @ ‚Çπ${futuresPrice.toFixed(2)}
                    </div>
                </div>
            </div>
        `;
    }

    function adjustAlgoLots(index, delta) {
        const slider = document.getElementById(`algo${index}LotsSlider`);
        const input = document.getElementById(`algo${index}LotsInput`);
        if (slider && input) {
            let newValue = parseInt(slider.value) + delta;
            newValue = Math.max(1, Math.min(newValue, parseInt(slider.max)));
            slider.value = newValue;
            input.value = newValue;
            updateAlgoCalculations(index, newValue);
        }
    }

    function updateAlgoCalculations(index, newLots) {
        const lots = parseInt(newLots);
        if (!lots || lots < 1) return;

        const data = window[`algoFuturesData${index}`];
        if (!data) {
            console.error(`Algo futures data not found for index ${index}`);
            return;
        }

        // Sync slider and input
        const slider = document.getElementById(`algo${index}LotsSlider`);
        const input = document.getElementById(`algo${index}LotsInput`);
        if (slider) slider.value = lots;
        if (input) input.value = lots;

        // Update main position values
        const totalMargin = data.marginPerLot * lots;
        const marginUtil = (totalMargin / data.marginAvailable * 100).toFixed(1);
        const entryValue = data.futuresPrice * data.lotSize * lots;
        const maxRisk = data.riskPerLot * lots;
        const maxProfit = data.rewardPerLot * lots;
        const totalStockValue = data.lotSize * lots * data.futuresPrice;

        // Update displays
        if (document.getElementById(`algo${index}RecommendedLots`)) {
            document.getElementById(`algo${index}RecommendedLots`).textContent = lots;
        }
        if (document.getElementById(`algo${index}TotalStockValue`)) {
            document.getElementById(`algo${index}TotalStockValue`).textContent = '‚Çπ' + formatIndianNumber(totalStockValue);
        }
        if (document.getElementById(`algo${index}MarginRequired`)) {
            document.getElementById(`algo${index}MarginRequired`).textContent = '‚Çπ' + formatIndianNumber(totalMargin);
        }
        if (document.getElementById(`algo${index}MarginUtil`)) {
            document.getElementById(`algo${index}MarginUtil`).textContent = marginUtil;
        }
        if (document.getElementById(`algo${index}EntryValue`)) {
            document.getElementById(`algo${index}EntryValue`).textContent = '‚Çπ' + formatIndianNumber(entryValue);
        }
        if (document.getElementById(`algo${index}MaxRisk`)) {
            document.getElementById(`algo${index}MaxRisk`).textContent = '‚Çπ' + formatIndianNumber(maxRisk);
        }
        if (document.getElementById(`algo${index}MaxProfit`)) {
            document.getElementById(`algo${index}MaxProfit`).textContent = '‚Çπ' + formatIndianNumber(maxProfit);
        }

        // Update averaging strategy
        const avg2Lots = Math.ceil(lots * 0.5);
        const avg3Lots = Math.ceil(lots * 0.5);

        if (document.getElementById(`algo${index}Avg1Lots`)) {
            document.getElementById(`algo${index}Avg1Lots`).textContent = lots;
        }
        if (document.getElementById(`algo${index}Avg1Margin`)) {
            document.getElementById(`algo${index}Avg1Margin`).textContent = '‚Çπ' + formatIndianNumber(data.marginPerLot * lots);
        }
        if (document.getElementById(`algo${index}Avg2Lots`)) {
            document.getElementById(`algo${index}Avg2Lots`).textContent = avg2Lots;
        }
        if (document.getElementById(`algo${index}Avg2Margin`)) {
            document.getElementById(`algo${index}Avg2Margin`).textContent = '‚Çπ' + formatIndianNumber(data.marginPerLot * avg2Lots);
        }
        if (document.getElementById(`algo${index}Avg2Total`)) {
            document.getElementById(`algo${index}Avg2Total`).textContent = lots + avg2Lots;
        }
        if (document.getElementById(`algo${index}Avg3Lots`)) {
            document.getElementById(`algo${index}Avg3Lots`).textContent = avg3Lots;
        }
        if (document.getElementById(`algo${index}Avg3Margin`)) {
            document.getElementById(`algo${index}Avg3Margin`).textContent = '‚Çπ' + formatIndianNumber(data.marginPerLot * avg3Lots);
        }
        if (document.getElementById(`algo${index}Avg3Total`)) {
            document.getElementById(`algo${index}Avg3Total`).textContent = lots + (avg2Lots + avg3Lots);
        }
        if (document.getElementById(`algo${index}AvgSummaryInitial`)) {
            document.getElementById(`algo${index}AvgSummaryInitial`).textContent = lots;
        }

        // Update P&L scenarios
        const pnlTarget = data.rewardPerLot * lots;
        const pnlPlus2 = data.futuresPrice * 0.02 * data.lotSize * lots;
        const pnlPlus1 = data.futuresPrice * 0.01 * data.lotSize * lots;
        const pnlMinus1 = data.futuresPrice * 0.01 * data.lotSize * lots;
        const pnlMinus2 = data.futuresPrice * 0.02 * data.lotSize * lots;
        const pnlStopLoss = data.riskPerLot * lots;

        if (document.getElementById(`algo${index}PnlTarget`)) {
            document.getElementById(`algo${index}PnlTarget`).textContent = '‚Çπ' + formatIndianNumber(pnlTarget);
        }
        if (document.getElementById(`algo${index}PnlPlus2`)) {
            document.getElementById(`algo${index}PnlPlus2`).textContent = '‚Çπ' + formatIndianNumber(pnlPlus2);
        }
        if (document.getElementById(`algo${index}PnlPlus1`)) {
            document.getElementById(`algo${index}PnlPlus1`).textContent = '‚Çπ' + formatIndianNumber(pnlPlus1);
        }
        if (document.getElementById(`algo${index}PnlMinus1`)) {
            document.getElementById(`algo${index}PnlMinus1`).textContent = '-‚Çπ' + formatIndianNumber(pnlMinus1);
        }
        if (document.getElementById(`algo${index}PnlMinus2`)) {
            document.getElementById(`algo${index}PnlMinus2`).textContent = '-‚Çπ' + formatIndianNumber(pnlMinus2);
        }
        if (document.getElementById(`algo${index}PnlStopLoss`)) {
            document.getElementById(`algo${index}PnlStopLoss`).textContent = '-‚Çπ' + formatIndianNumber(pnlStopLoss);
        }

        // Update Take Trade button display
        if (document.getElementById(`algo${index}DisplayLots`)) {
            document.getElementById(`algo${index}DisplayLots`).textContent = lots;
        }
    }

    async function toggleAlgoContract(index) {
        console.log('toggleAlgoContract called with index:', index);

        const detailsDiv = document.getElementById(`algoContractDetails${index}`);
        const iconSpan = document.getElementById(`algoToggleIcon${index}`);

        if (!detailsDiv || !iconSpan) {
            console.log('Elements not found:', { detailsDiv: !!detailsDiv, iconSpan: !!iconSpan });
            return;
        }

        // Toggle visibility
        const isHidden = detailsDiv.style.display === 'none';
        detailsDiv.style.display = isHidden ? 'block' : 'none';
        iconSpan.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';

        console.log('Toggle:', { isHidden, willExpand: isHidden, loaded: detailsDiv.dataset.loaded });

        // Lazy load full UI on first expand
        if (isHidden && !detailsDiv.dataset.loaded) {
            detailsDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);">üìä Loading position sizing...</div>';

            const suggestionId = window.futuresAlgoSuggestionIds ? window.futuresAlgoSuggestionIds[index] : null;

            console.log('Looking for suggestion ID:', {
                index,
                suggestionId,
                allIds: window.futuresAlgoSuggestionIds,
                arrayLength: window.futuresAlgoSuggestionIds ? window.futuresAlgoSuggestionIds.length : 0
            });

            if (!suggestionId) {
                const errorMsg = `
                    <div style="text-align: center; padding: 2rem; color: #EF4444;">
                        ‚ö†Ô∏è Suggestion ID not found
                        <div style="font-size: 0.875rem; margin-top: 1rem; color: var(--gray);">
                            Debug Info:<br>
                            Index: ${index}<br>
                            Array length: ${window.futuresAlgoSuggestionIds ? window.futuresAlgoSuggestionIds.length : 0}<br>
                            IDs: ${window.futuresAlgoSuggestionIds ? JSON.stringify(window.futuresAlgoSuggestionIds) : 'undefined'}<br>
                            <br>
                            <strong>Possible Fix:</strong> The backend may need to be restarted to save suggestions for ALL PASS results.
                        </div>
                    </div>
                `;
                detailsDiv.innerHTML = errorMsg;
                return;
            }

            try {
                // Fetch suggestion data
                const response = await fetch(`/trading/api/suggestions/${suggestionId}/`);
                const result = await response.json();

                if (result.success) {
                    // Build full position sizing UI (same as Verify Future Trade)
                    const positionSizingHTML = buildFullPositionSizingUI(result.suggestion, index);
                    detailsDiv.innerHTML = positionSizingHTML;
                    detailsDiv.dataset.loaded = 'true';

                    // Attach event listener to Take Trade button
                    const btn = document.getElementById(`algoTakeTradeBtn${index}`);
                    if (btn) {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            takeFuturesTradeFromServer(suggestionId, e.currentTarget);
                        });
                    }
                } else {
                    detailsDiv.innerHTML = `<div style="text-align: center; padding: 2rem; color: #EF4444;">‚ö†Ô∏è ${result.error || 'Failed to load'}</div>`;
                }
            } catch (error) {
                console.error('Error loading position sizing:', error);
                detailsDiv.innerHTML = `<div style="text-align: center; padding: 2rem; color: #EF4444;">‚ö†Ô∏è Error: ${error.message}</div>`;
            }
        }
    }

    function displayFuturesTop3Result(data) {
        const allContracts = data.all_contracts;
        const totalAnalyzed = data.total_analyzed;
        const totalPassed = data.total_passed;
        const totalFailed = data.total_failed;
        const totalErrors = data.total_errors;
        const volumeFilters = data.volume_filters;
        const suggestionIds = data.suggestion_ids || [];  // Get suggestion IDs from backend

        document.getElementById('resultTitle').textContent = `Futures Algorithm: ${totalAnalyzed} Analyzed`;
        document.getElementById('resultBadge').textContent = `${totalPassed} PASSED`;
        document.getElementById('resultBadge').className = 'result-badge pass';

        // Separate PASS contracts from others
        const passedContracts = allContracts.filter(c => c.verdict === 'PASS');
        const failedContracts = allContracts.filter(c => c.verdict === 'FAIL');
        const errorContracts = allContracts.filter(c => c.verdict === 'ERROR');

        console.log('Suggestion IDs from backend:', suggestionIds);
        console.log('Passed contracts:', passedContracts.length);
        console.log('All contracts:', allContracts.length);

        // Build collapsible HTML for PASS contracts (with full verification UI)
        let passedHTML = '';
        let passedSuggestionIds = [];  // Track suggestion IDs for passed contracts only
        passedContracts.forEach((contract, index) => {
            const rank = index + 1;
            const suggestionId = suggestionIds[index] ||  null;  // All PASS results have suggestion IDs
            passedSuggestionIds.push(suggestionId);

            console.log(`Contract ${index}: ${contract.symbol}, SuggestionID: ${suggestionId}`);

            // Determine emoji and color
            let rankEmoji, bgColor;
            if (rank === 1) {
                rankEmoji = 'ü•á';
                bgColor = '#059669';
            } else if (rank === 2) {
                rankEmoji = 'ü•à';
                bgColor = '#2563EB';
            } else if (rank === 3) {
                rankEmoji = 'ü•â';
                bgColor = '#D97706';
            } else {
                rankEmoji = '‚úÖ';
                bgColor = '#059669';
            }

            const scores = contract.scores || {};
            const scoreBreakdown = `
                <div style="display: inline-flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Basis: ${scores.basis || 0}/10</span>
                    <span style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">OI: ${scores.oi || 0}/15</span>
                    <span style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">DMA: ${scores.dma || 0}/15</span>
                    <span style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sector: ${scores.sector || 0}/20</span>
                    <span style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Volume: ${scores.volume || 0}/10</span>
                    <span style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Tech: ${scores.technical || 0}/15</span>
                    <span style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">S/R: ${scores.sr || 0}/5</span>
                </div>
            `;

            passedHTML += `
                <div style="background: white; border-radius: var(--radius-lg); margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; border-left: 4px solid ${bgColor};">
                    <!-- Collapsed Summary Header (always visible) -->
                    <div onclick="toggleAlgoContract(${index})" style="padding: 1.25rem; cursor: pointer; background: linear-gradient(135deg, ${bgColor}15 0%, ${bgColor}05 100%); transition: all 0.2s;" onmouseover="this.style.background='linear-gradient(135deg, ${bgColor}25 0%, ${bgColor}15 100%)'" onmouseout="this.style.background='linear-gradient(135deg, ${bgColor}15 0%, ${bgColor}05 100%)'">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                <span style="font-size: 2rem;">${rankEmoji}</span>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                        <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--dark);">${contract.symbol}</h3>
                                        <span style="background: ${bgColor}; color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 600;">Score: ${contract.composite_score}</span>
                                        <span style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 600;">${contract.direction}</span>
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">
                                        Expiry: ${contract.expiry} | Futures: ‚Çπ${contract.futures_price.toFixed(2)} | Basis: ${contract.basis_pct.toFixed(2)}% | Volume: ${contract.volume.toLocaleString()}
                                    </div>
                                    ${scoreBreakdown}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span id="algoToggleIcon${index}" style="font-size: 1.5rem; transition: transform 0.3s; color: ${bgColor};">‚ñº</span>
                            </div>
                        </div>
                    </div>

                    <!-- Expanded Full Verification UI (hidden by default) -->
                    <div id="algoContractDetails${index}" style="display: none; padding: 1.5rem; border-top: 1px solid #E5E7EB;">
                        <div style="text-align: center; padding: 2rem; color: var(--gray);">
                            üìä Loading full analysis with position sizing...
                        </div>
                    </div>
                </div>
            `;
        });

        // Build simple list for FAIL and ERROR contracts
        let failedHTML = '';
        if (failedContracts.length > 0 || errorContracts.length > 0) {
            const allNonPass = [...failedContracts, ...errorContracts];
            allNonPass.forEach(contract => {
                const isError = contract.verdict === 'ERROR';
                const bgColor = isError ? '#EF4444' : '#6B7280';
                const emoji = isError ? '‚ùå' : '‚ö†Ô∏è';

                failedHTML += `
                    <div style="background: white; border-radius: var(--radius-md); padding: 1rem; margin-bottom: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 3px solid ${bgColor};">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.5rem;">${emoji}</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem; color: var(--dark);">${contract.symbol}</h4>
                                    <div style="font-size: 0.75rem; color: var(--gray);">Expiry: ${contract.expiry}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: ${bgColor}; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600;">${contract.verdict}</span>
                                ${!isError ? `<div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">Score: ${contract.composite_score}</div>` : ''}
                            </div>
                        </div>
                        ${contract.error ? `<div style="font-size: 0.875rem; color: #EF4444; margin-top: 0.5rem;">Error: ${contract.error}</div>` : ''}
                    </div>
                `;
            });
        }

        // Build summary cards
        let contractsHTML = passedHTML;
        if (failedHTML) {
            contractsHTML += `
                <div style="margin-top: 2rem;">
                    <h3 style="color: var(--gray); font-size: 1.1rem; margin-bottom: 1rem;">Failed / Error Contracts (${failedContracts.length + errorContracts.length})</h3>
                    ${failedHTML}
                </div>
            `;
        }

        const html = `
            <div class="result-section">
                <h3>Analysis Summary</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="result-item">
                        <div class="result-item-label">Contracts Analyzed</div>
                        <div class="result-item-value">${totalAnalyzed}</div>
                    </div>
                    <div class="result-item" style="background: #D1FAE5;">
                        <div class="result-item-label">‚úÖ Passed</div>
                        <div class="result-item-value" style="color: #065F46;">${totalPassed}</div>
                    </div>
                    <div class="result-item" style="background: #FEE2E2;">
                        <div class="result-item-label">‚ö†Ô∏è Failed</div>
                        <div class="result-item-value" style="color: #991B1B;">${totalFailed}</div>
                    </div>
                    <div class="result-item" style="background: #FEE2E2;">
                        <div class="result-item-label">‚ùå Errors</div>
                        <div class="result-item-value" style="color: #991B1B;">${totalErrors}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">This Month Filter</div>
                        <div class="result-item-value">‚â•${volumeFilters.this_month}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Next Month Filter</div>
                        <div class="result-item-value">‚â•${volumeFilters.next_month}</div>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h3>${totalPassed} Passed Contracts (Click to Expand)</h3>
                <p style="color: var(--gray); margin-bottom: 1rem;">
                    Click on any contract to view the full Position Sizing & Risk Analysis UI (same as Verify Future Trade).
                </p>
                ${contractsHTML}
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="hideResults()">
                    ‚Üê Back to Triggers
                </button>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });

        // Store suggestion IDs globally for lazy loading
        window.futuresAlgoSuggestionIds = passedSuggestionIds;
        window.futuresAlgoContracts = passedContracts;

        console.log('Stored globally:', {
            suggestionIds: window.futuresAlgoSuggestionIds,
            contracts: window.futuresAlgoContracts.map(c => c.symbol)
        });
    }

    function openFullAnalysisInNewTab(contract) {
        // Create a new window/tab with the full analysis
        const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');

        if (!newWindow) {
            alert('Pop-up blocked! Please allow pop-ups for this site to view detailed analysis.');
            return;
        }

        // Build the complete HTML for the new tab
        const executionLog = contract.execution_log || [];
        const metrics = contract.metrics || {};
        const scores = contract.scores || {};

        // Build execution log HTML
        let logHTML = '';
        if (executionLog.length > 0) {
            logHTML = executionLog.map((log, index) => {
                let statusColor = '#2563EB';
                let statusIcon = '‚óè';
                let statusBg = '#2563EB';

                if (log.status === 'PASS' || log.status === 'success') {
                    statusColor = '#10B981';
                    statusIcon = '‚úì';
                    statusBg = '#10B981';
                } else if (log.status === 'FAIL' || log.status === 'fail') {
                    statusColor = '#EF4444';
                    statusIcon = '‚úó';
                    statusBg = '#EF4444';
                } else if (log.status === 'SKIP' || log.status === 'warning') {
                    statusColor = '#F59E0B';
                    statusIcon = '‚ö†';
                    statusBg = '#F59E0B';
                }

                let detailsHTML = '';
                if (log.details && Object.keys(log.details).length > 0) {
                    detailsHTML = '<div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.5rem; padding: 0.5rem; background: #F9FAFB; border-radius: 0.375rem; font-family: monospace; max-height: 150px; overflow-y: auto;">';
                    for (const [key, value] of Object.entries(log.details)) {
                        if (typeof value !== 'object') {
                            detailsHTML += `<div><strong>${key}:</strong> ${value}</div>`;
                        }
                    }
                    detailsHTML += '</div>';
                }

                return `
                    <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid #E5E7EB;">
                        <span style="flex-shrink: 0; background: ${statusBg}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${log.step}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1F2937; margin-bottom: 0.25rem;">${log.action}</div>
                            <div style="font-size: 0.875rem; color: #6B7280;">${log.message}</div>
                            ${detailsHTML}
                        </div>
                        <span style="flex-shrink: 0; color: ${statusColor}; font-size: 1.25rem;">${statusIcon}</span>
                    </div>
                `;
            }).join('');
        }

        const html = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Full Analysis: ${contract.symbol} - ${contract.expiry}</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        padding: 2rem;
                        background: #F3F4F6;
                        line-height: 1.6;
                    }
                    .container { max-width: 1200px; margin: 0 auto; }
                    .header {
                        background: linear-gradient(135deg, ${contract.verdict === 'PASS' ? '#10B981 0%, #059669 100%' : contract.verdict === 'ERROR' ? '#EF4444 0%, #DC2626 100%' : '#6B7280 0%, #4B5563 100%'});
                        color: white;
                        padding: 2rem;
                        border-radius: 0.75rem;
                        margin-bottom: 2rem;
                    }
                    .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
                    .header .verdict {
                        display: inline-block;
                        padding: 0.5rem 1rem;
                        background: rgba(255,255,255,0.2);
                        border-radius: 0.5rem;
                        font-weight: 600;
                        margin-top: 0.5rem;
                    }
                    .section {
                        background: white;
                        padding: 1.5rem;
                        border-radius: 0.75rem;
                        margin-bottom: 1.5rem;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    }
                    .section h2 {
                        font-size: 1.25rem;
                        color: #1F2937;
                        margin-bottom: 1rem;
                        padding-bottom: 0.5rem;
                        border-bottom: 2px solid #E5E7EB;
                    }
                    .grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 1rem;
                    }
                    .grid-item {
                        padding: 1rem;
                        background: #F9FAFB;
                        border-radius: 0.5rem;
                    }
                    .grid-item-label {
                        font-size: 0.75rem;
                        color: #6B7280;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin-bottom: 0.25rem;
                    }
                    .grid-item-value {
                        font-size: 1.125rem;
                        font-weight: 600;
                        color: #1F2937;
                    }
                    .print-btn {
                        background: #2563EB;
                        color: white;
                        padding: 0.75rem 1.5rem;
                        border: none;
                        border-radius: 0.5rem;
                        font-weight: 600;
                        cursor: pointer;
                        margin-top: 1rem;
                    }
                    .print-btn:hover { background: #1D4ED8; }
                    .position-input-group {
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        margin: 1rem 0;
                    }
                    .position-input-group label {
                        font-weight: 600;
                        color: #374151;
                    }
                    .position-input-group input[type="number"] {
                        width: 120px;
                        padding: 0.5rem;
                        border: 2px solid #E5E7EB;
                        border-radius: 0.5rem;
                        font-size: 1rem;
                        font-weight: 600;
                    }
                    .position-input-group input[type="number"]:focus {
                        outline: none;
                        border-color: #2563EB;
                    }
                    .pnl-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 1rem 0;
                    }
                    .pnl-table th {
                        background: #F3F4F6;
                        padding: 0.75rem;
                        text-align: left;
                        font-weight: 600;
                        color: #374151;
                        border-bottom: 2px solid #E5E7EB;
                    }
                    .pnl-table td {
                        padding: 0.75rem;
                        border-bottom: 1px solid #E5E7EB;
                    }
                    .pnl-table tr:hover {
                        background: #F9FAFB;
                    }
                    .pnl-positive {
                        color: #10B981;
                        font-weight: 600;
                    }
                    .pnl-negative {
                        color: #EF4444;
                        font-weight: 600;
                    }
                    .pnl-neutral {
                        color: #6B7280;
                        font-weight: 600;
                    }
                    .toggle-btn {
                        background: #F3F4F6;
                        color: #374151;
                        padding: 0.5rem 1rem;
                        border: none;
                        border-radius: 0.5rem;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        margin: 0.5rem 0;
                    }
                    .toggle-btn:hover {
                        background: #E5E7EB;
                    }
                    .collapsible-content {
                        display: none;
                        margin-top: 1rem;
                        padding: 1rem;
                        background: #F9FAFB;
                        border-radius: 0.5rem;
                    }
                    .collapsible-content.show {
                        display: block;
                    }
                    .averaging-level {
                        background: white;
                        padding: 1rem;
                        border-radius: 0.5rem;
                        margin-bottom: 1rem;
                        border-left: 4px solid #2563EB;
                    }
                    .order-btn {
                        background: #10B981;
                        color: white;
                        padding: 0.75rem 2rem;
                        border: none;
                        border-radius: 0.5rem;
                        font-weight: 600;
                        font-size: 1rem;
                        cursor: pointer;
                        margin-top: 1rem;
                    }
                    .order-btn:hover {
                        background: #059669;
                    }
                    .order-btn:disabled {
                        background: #9CA3AF;
                        cursor: not-allowed;
                    }
                    .order-status {
                        margin-top: 1rem;
                        padding: 1rem;
                        border-radius: 0.5rem;
                        display: none;
                    }
                    .order-status.show {
                        display: block;
                    }
                    .order-status.success {
                        background: #D1FAE5;
                        color: #065F46;
                        border: 1px solid #10B981;
                    }
                    .order-status.error {
                        background: #FEE2E2;
                        color: #991B1B;
                        border: 1px solid #EF4444;
                    }
                    .order-status.pending {
                        background: #FEF3C7;
                        color: #92400E;
                        border: 1px solid #F59E0B;
                    }
                    .loading-spinner {
                        display: inline-block;
                        width: 16px;
                        height: 16px;
                        border: 2px solid #E5E7EB;
                        border-top-color: #2563EB;
                        border-radius: 50%;
                        animation: spin 0.6s linear infinite;
                    }
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                    @media print {
                        body { background: white; padding: 0; }
                        .print-btn, .order-btn { display: none; }
                        .position-sizing-section { page-break-before: always; }
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <h1>${contract.symbol} - ${contract.expiry}</h1>
                        <div>Composite Score: ${contract.composite_score}/100 | Direction: ${contract.direction}</div>
                        <span class="verdict">${contract.verdict}</span>
                    </div>

                    <div class="section">
                        <h2>Contract Overview</h2>
                        <div class="grid">
                            <div class="grid-item">
                                <div class="grid-item-label">Symbol</div>
                                <div class="grid-item-value">${contract.symbol}</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Expiry</div>
                                <div class="grid-item-value">${contract.expiry}</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Composite Score</div>
                                <div class="grid-item-value">${contract.composite_score}/100</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Direction</div>
                                <div class="grid-item-value">${contract.direction}</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Spot Price</div>
                                <div class="grid-item-value">‚Çπ${contract.spot_price.toFixed(2)}</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Futures Price</div>
                                <div class="grid-item-value">‚Çπ${contract.futures_price.toFixed(2)}</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Basis</div>
                                <div class="grid-item-value">‚Çπ${contract.basis.toFixed(2)} (${contract.basis_pct.toFixed(2)}%)</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Volume</div>
                                <div class="grid-item-value">${contract.volume.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    ${logHTML ? `
                    <div class="section">
                        <h2>üìã Step-by-Step Analysis</h2>
                        <div style="background: #F9FAFB; border-radius: 0.5rem; padding: 1rem;">
                            ${logHTML}
                        </div>
                    </div>
                    ` : ''}

                    <div class="section">
                        <h2>Score Breakdown</h2>
                        <div class="grid">
                            <div class="grid-item">
                                <div class="grid-item-label">Basis</div>
                                <div class="grid-item-value">${scores.basis || 0}/10</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Open Interest</div>
                                <div class="grid-item-value">${scores.oi || 0}/15</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">DMA</div>
                                <div class="grid-item-value">${scores.dma || 0}/15</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Sector</div>
                                <div class="grid-item-value">${scores.sector || 0}/20</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Volume</div>
                                <div class="grid-item-value">${scores.volume || 0}/10</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Technical</div>
                                <div class="grid-item-value">${scores.technical || 0}/15</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Support/Resistance</div>
                                <div class="grid-item-value">${scores.sr || 0}/5</div>
                            </div>
                        </div>
                    </div>

                    <div class="section position-sizing-section" id="positionSizingSection">
                        <h2>üí∞ Position Sizing & Order Execution</h2>

                        <!-- Margin Information -->
                        <div style="background: #F9FAFB; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <h3 style="font-size: 1rem; color: #374151; margin-bottom: 0.75rem;">Margin Information</h3>
                            <div class="grid">
                                <div class="grid-item">
                                    <div class="grid-item-label">Margin per Lot</div>
                                    <div class="grid-item-value" id="marginPerLot">
                                        <span class="loading-spinner"></span> Loading...
                                    </div>
                                </div>
                                <div class="grid-item">
                                    <div class="grid-item-label">Available F&O Margin</div>
                                    <div class="grid-item-value" id="availableMargin">
                                        <span class="loading-spinner"></span> Loading...
                                    </div>
                                </div>
                                <div class="grid-item">
                                    <div class="grid-item-label">Usable Margin (50%)</div>
                                    <div class="grid-item-value" id="usableMargin">
                                        <span class="loading-spinner"></span> Loading...
                                    </div>
                                </div>
                                <div class="grid-item">
                                    <div class="grid-item-label">Max Affordable Lots</div>
                                    <div class="grid-item-value" id="maxLots">
                                        <span class="loading-spinner"></span> Loading...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lot Size Selector -->
                        <div style="background: white; padding: 1rem; border: 2px solid #E5E7EB; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <div class="position-input-group">
                                <label for="lotQuantity">Lot Quantity:</label>
                                <input type="number" id="lotQuantity" min="1" step="1" value="1"
                                       oninput="validateLotInput(this)"
                                       onchange="updatePositionSize(this.value)">
                                <span style="color: #6B7280;">Total Margin: <strong id="totalMargin">‚Çπ0</strong></span>
                                <span style="color: #6B7280;">Capital Utilization: <strong id="capitalUtil">0%</strong></span>
                            </div>
                        </div>

                        <!-- P&L Scenarios Table -->
                        <div style="margin-bottom: 1rem;">
                            <h3 style="font-size: 1rem; color: #374151; margin-bottom: 0.75rem;">P&L Scenarios</h3>
                            <table class="pnl-table" id="pnlTable">
                                <thead>
                                    <tr>
                                        <th>Price Change</th>
                                        <th>Exit Price</th>
                                        <th>P&L Amount</th>
                                        <th>P&L %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4" style="text-align: center; color: #6B7280;">
                                            <span class="loading-spinner"></span> Loading scenarios...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Averaging Strategy Collapsible -->
                        <div style="margin-bottom: 1rem;">
                            <button class="toggle-btn" onclick="toggleAveraging()">
                                <span id="averagingIcon">‚ñ∂</span> Averaging Strategy (Advanced)
                            </button>
                            <div class="collapsible-content" id="averagingContent">
                                <div id="averagingLevels">
                                    <div class="averaging-level">
                                        <h4 style="color: #2563EB; margin-bottom: 0.5rem;">Level 1: First Averaging</h4>
                                        <div class="grid">
                                            <div class="grid-item">
                                                <div class="grid-item-label">Trigger Price</div>
                                                <div class="grid-item-value" id="avg1Trigger">-</div>
                                            </div>
                                            <div class="grid-item">
                                                <div class="grid-item-label">Lots to Add</div>
                                                <div class="grid-item-value" id="avg1Lots">-</div>
                                            </div>
                                            <div class="grid-item">
                                                <div class="grid-item-label">Cumulative Average</div>
                                                <div class="grid-item-value" id="avg1Price">-</div>
                                            </div>
                                            <div class="grid-item">
                                                <div class="grid-item-label">New Target</div>
                                                <div class="grid-item-value" id="avg1Target">-</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="averaging-level">
                                        <h4 style="color: #2563EB; margin-bottom: 0.5rem;">Level 2: Second Averaging</h4>
                                        <div class="grid">
                                            <div class="grid-item">
                                                <div class="grid-item-label">Trigger Price</div>
                                                <div class="grid-item-value" id="avg2Trigger">-</div>
                                            </div>
                                            <div class="grid-item">
                                                <div class="grid-item-label">Lots to Add</div>
                                                <div class="grid-item-value" id="avg2Lots">-</div>
                                            </div>
                                            <div class="grid-item">
                                                <div class="grid-item-label">Cumulative Average</div>
                                                <div class="grid-item-value" id="avg2Price">-</div>
                                            </div>
                                            <div class="grid-item">
                                                <div class="grid-item-label">New Target</div>
                                                <div class="grid-item-value" id="avg2Target">-</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="averaging-level">
                                        <h4 style="color: #EF4444; margin-bottom: 0.5rem;">Level 3: Final Averaging (Stop Loss Level)</h4>
                                        <div class="grid">
                                            <div class="grid-item">
                                                <div class="grid-item-label">Trigger Price</div>
                                                <div class="grid-item-value" id="avg3Trigger">-</div>
                                            </div>
                                            <div class="grid-item">
                                                <div class="grid-item-label">Lots to Add</div>
                                                <div class="grid-item-value" id="avg3Lots">-</div>
                                            </div>
                                            <div class="grid-item">
                                                <div class="grid-item-label">Cumulative Average</div>
                                                <div class="grid-item-value" id="avg3Price">-</div>
                                            </div>
                                            <div class="grid-item">
                                                <div class="grid-item-label">Stop Loss</div>
                                                <div class="grid-item-value" id="avg3StopLoss">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Execution Section - REMOVED Place Order Button -->
                        <!-- Users should use "Take This Trade" button from suggestions instead -->
                        <div style="border-top: 2px solid #E5E7EB; padding-top: 1rem;">
                            <div class="order-status" id="orderStatus"></div>
                            <div style="padding: 1rem; background: #FEF3C7; border-left: 4px solid #F59E0B; margin-top: 1rem;">
                                <strong>Note:</strong> To place an order, use the <strong>"Take This Trade"</strong> button from the suggestion below after verification.
                            </div>
                        </div>
                    </div>

                    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Analysis</button>
                </div>
                <script>
                    // Store contract data globally for the new window
                    window.contractData = ${JSON.stringify(contract)};

                    // === ALL POSITION SIZING FUNCTIONS (embedded in new window) ===

                    // Helper function to get CSRF token
                    function getCookie(name) {
                        let cookieValue = null;
                        if (document.cookie && document.cookie !== '') {
                            const cookies = document.cookie.split(';');
                            for (let i = 0; i < cookies.length; i++) {
                                const cookie = cookies[i].trim();
                                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }

                    function showError(message) {
                        console.error('Position Sizing Error:', message);
                        alert('Error: ' + message);
                    }

                    async function fetchPositionSizing(contract) {
                        try {
                            // Extract symbol and expiry from contract object
                            let symbol = contract.symbol;
                            let expiry = contract.expiry_date || contract.expiry;  // Prefer YYYY-MM-DD format
                            let direction = contract.direction || 'LONG';

                            // Validate required fields
                            if (!symbol || !expiry) {
                                console.error('Missing required fields:', { symbol, expiry, contract });
                                throw new Error('Symbol and expiry are required');
                            }

                            console.log('Fetching position sizing for:', { symbol, expiry, direction });

                            const response = await fetch('/trading/api/calculate-position/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify({
                                    symbol: symbol,
                                    expiry: expiry,
                                    direction: direction,
                                    custom_lots: null
                                })
                            });

                            if (!response.ok) {
                                throw new Error(\`API error: \${response.status}\`);
                            }

                            const data = await response.json();

                            if (!data.success) {
                                throw new Error(data.error || 'Failed to calculate position sizing');
                            }

                            // Update margin information
                            if (document.getElementById('marginPerLot')) {
                                document.getElementById('marginPerLot').textContent = '‚Çπ' + (data.margin_per_lot || 0).toLocaleString();
                            }
                            if (document.getElementById('availableMargin')) {
                                document.getElementById('availableMargin').textContent = '‚Çπ' + (data.available_margin || 0).toLocaleString();
                            }
                            if (document.getElementById('usableMargin')) {
                                document.getElementById('usableMargin').textContent = '‚Çπ' + (data.usable_margin || 0).toLocaleString();
                            }
                            if (document.getElementById('maxLots')) {
                                document.getElementById('maxLots').textContent = data.max_lots || 1;
                            }

                            const lotInput = document.getElementById('lotQuantity');
                            if (lotInput) {
                                lotInput.value = data.suggested_lots || 1;
                                lotInput.max = data.max_lots || 100;
                            }

                            window.positionData = data;
                            await updatePositionSize(data.suggested_lots || 1);

                        } catch (error) {
                            console.error('Error fetching position sizing:', error);
                            showError('Failed to load position sizing: ' + error.message);
                        }
                    }

                    async function updatePositionSize(newLots) {
                        const lots = parseInt(newLots);
                        if (!lots || lots < 1) return;

                        const contract = window.contractData;
                        const positionData = window.positionData;

                        if (!positionData) {
                            console.error('Position data not loaded yet');
                            return;
                        }

                        const totalMargin = positionData.margin_per_lot * lots;
                        const capitalUtil = (totalMargin / positionData.usable_margin * 100).toFixed(1);

                        if (document.getElementById('totalMargin')) {
                            document.getElementById('totalMargin').textContent = '‚Çπ' + totalMargin.toLocaleString();
                        }
                        if (document.getElementById('capitalUtil')) {
                            document.getElementById('capitalUtil').textContent = capitalUtil + '%';
                        }

                        try {
                            const response = await fetch('/trading/api/calculate-pnl/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify({
                                    entry_price: contract.futures_price,
                                    lots: lots,
                                    lot_size: positionData.lot_size,
                                    direction: contract.direction
                                })
                            });

                            if (!response.ok) {
                                throw new Error(\`API error: \${response.status}\`);
                            }

                            const data = await response.json();

                            if (!data.success) {
                                throw new Error(data.error || 'Failed to calculate P&L');
                            }

                            if (data.scenarios) {
                                updatePnLTable(data.scenarios);
                            }

                            if (data.averaging_strategy) {
                                updateAveragingStrategy(data.averaging_strategy);
                            }

                        } catch (error) {
                            console.error('Error calculating P&L:', error);
                        }
                    }

                    function updatePnLTable(scenarios) {
                        const tbody = document.querySelector('#pnlTable tbody');
                        if (!tbody) return;

                        if (!scenarios || scenarios.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4">No scenarios available</td></tr>';
                            return;
                        }

                        tbody.innerHTML = scenarios.map(scenario => {
                            const pnl = scenario.pnl || 0;
                            const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                            const pnlSign = pnl >= 0 ? '+' : '';
                            const changePct = scenario.change_pct || 0;

                            return \`
                                <tr>
                                    <td><strong>\${changePct > 0 ? '+' : ''}\${changePct}%</strong></td>
                                    <td>‚Çπ\${(scenario.exit_price || 0).toFixed(2)}</td>
                                    <td class="\${pnlClass}">\${pnlSign}‚Çπ\${Math.abs(pnl).toLocaleString()}</td>
                                    <td class="\${pnlClass}">\${pnlSign}\${(scenario.pnl_pct || 0).toFixed(2)}%</td>
                                </tr>
                            \`;
                        }).join('');
                    }

                    function updateAveragingStrategy(strategy) {
                        if (!strategy || !strategy.levels) return;

                        strategy.levels.forEach((level, index) => {
                            const levelNum = level.level || (index + 1);

                            const triggerEl = document.getElementById('avg' + levelNum + 'Trigger');
                            const lotsEl = document.getElementById('avg' + levelNum + 'Lots');
                            const priceEl = document.getElementById('avg' + levelNum + 'Price');
                            const targetEl = document.getElementById('avg' + levelNum + 'Target');
                            const stopLossEl = document.getElementById('avg3StopLoss');

                            if (triggerEl) {
                                triggerEl.textContent = '‚Çπ' + (level.trigger_price || 0).toFixed(2);
                            }
                            if (lotsEl) {
                                lotsEl.textContent = level.lots_to_add || 0;
                            }
                            if (priceEl) {
                                priceEl.textContent = '‚Çπ' + (level.average_price || 0).toFixed(2);
                            }

                            if (levelNum < 3 && targetEl && level.targets) {
                                targetEl.textContent = '‚Çπ' + (level.targets.t1 || 0).toFixed(2);
                            } else if (levelNum === 3 && stopLossEl) {
                                stopLossEl.textContent = '‚Çπ' + (level.stop_loss || 0).toFixed(2);
                            }
                        });
                    }

                    function toggleAveraging() {
                        const content = document.getElementById('averagingContent');
                        const icon = document.getElementById('averagingIcon');

                        if (content.classList.contains('show')) {
                            content.classList.remove('show');
                            icon.textContent = '‚ñ∂';
                        } else {
                            content.classList.add('show');
                            icon.textContent = '‚ñº';
                        }
                    }

                    function validateLotInput(input) {
                        const positionData = window.positionData;
                        if (!positionData) return;

                        let value = parseInt(input.value);

                        if (isNaN(value) || value < 1) {
                            input.value = 1;
                            input.style.borderColor = '#EF4444';
                            input.style.backgroundColor = '#FEE2E2';
                            return;
                        }

                        if (input.value !== value.toString()) {
                            input.value = value;
                        }

                        const marginRequired = positionData.margin_per_lot * value;
                        const capitalUtil = (marginRequired / positionData.usable_margin * 100);

                        if (value > positionData.max_lots) {
                            input.style.borderColor = '#EF4444';
                            input.style.backgroundColor = '#FEE2E2';
                        } else if (capitalUtil > 80) {
                            input.style.borderColor = '#F97316';
                            input.style.backgroundColor = '#FED7AA';
                        } else if (capitalUtil > 50) {
                            input.style.borderColor = '#F59E0B';
                            input.style.backgroundColor = '#FEF3C7';
                        } else if (capitalUtil > 30) {
                            input.style.borderColor = '#84CC16';
                            input.style.backgroundColor = '#ECFCCB';
                        } else {
                            input.style.borderColor = '#10B981';
                            input.style.backgroundColor = '#D1FAE5';
                        }
                    }

                    async function placeOrder() {
                        const contract = window.contractData;
                        const positionData = window.positionData;
                        const lots = parseInt(document.getElementById('lotQuantity').value);

                        if (!lots || lots < 1) {
                            alert('Please enter a valid lot quantity (minimum 1)');
                            return;
                        }

                        if (positionData && lots > positionData.max_lots) {
                            alert(\`Lot quantity (\${lots}) exceeds maximum affordable lots (\${positionData.max_lots})\`);
                            return;
                        }

                        const marginRequired = positionData ? (positionData.margin_per_lot * lots) : 0;

                        const confirmationMessage = \`‚ö†Ô∏è CONFIRM ORDER PLACEMENT

Symbol: \${contract.symbol}
Expiry: \${contract.expiry || 'N/A'}
Direction: \${contract.direction}
Lots: \${lots}
Entry Price: ‚Çπ\${contract.futures_price.toFixed(2)}
Margin Required: ‚Çπ\${marginRequired.toLocaleString()}

This will place a REAL order with your broker.
Are you absolutely sure?\`;

                        if (!confirm(confirmationMessage)) {
                            return;
                        }

                        // Order placement logic here
                        alert('Order placement functionality will be implemented');
                    }

                    // Fetch position sizing data on load
                    window.addEventListener('load', function() {
                        fetchPositionSizing(window.contractData);
                    });
                <\/script>
            </body>
            </html>
        `;

        newWindow.document.write(html);
        newWindow.document.close();
    }

    // Position Sizing Functions (for the new window)
    async function fetchPositionSizing(contract) {
        try {
            // Ensure expiry is in YYYY-MM-DD format for API
            let expiry = contract.expiry_date || contract.expiry;  // Prefer YYYY-MM-DD format

            const response = await fetch('/trading/api/calculate-position/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    symbol: contract.symbol,
                    expiry: expiry,  // Use proper expiry format
                    direction: contract.direction,
                    custom_lots: null  // Let API suggest lots
                })
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();

            // Check for API success
            if (!data.success) {
                throw new Error(data.error || 'Failed to calculate position sizing');
            }

            // Update margin information
            if (document.getElementById('marginPerLot')) {
                document.getElementById('marginPerLot').textContent = '‚Çπ' + (data.margin_per_lot || 0).toLocaleString();
            }
            if (document.getElementById('availableMargin')) {
                document.getElementById('availableMargin').textContent = '‚Çπ' + (data.available_margin || 0).toLocaleString();
            }
            if (document.getElementById('usableMargin')) {
                document.getElementById('usableMargin').textContent = '‚Çπ' + (data.usable_margin || 0).toLocaleString();
            }
            if (document.getElementById('maxLots')) {
                document.getElementById('maxLots').textContent = data.max_lots || 1;
            }

            // Set default lot quantity to suggested lots
            const lotInput = document.getElementById('lotQuantity');
            if (lotInput) {
                lotInput.value = data.suggested_lots || 1;
                lotInput.max = data.max_lots || 100;
            }

            // Store data globally for later use
            window.positionData = data;

            // Update position size calculations
            await updatePositionSize(data.suggested_lots || 1);

        } catch (error) {
            console.error('Error fetching position sizing:', error);

            // Show user-friendly error message
            showError('Failed to load position sizing: ' + error.message);

            // Update UI with error states
            if (document.getElementById('marginPerLot')) {
                document.getElementById('marginPerLot').textContent = 'Error';
            }
            if (document.getElementById('availableMargin')) {
                document.getElementById('availableMargin').textContent = 'Error';
            }
            if (document.getElementById('usableMargin')) {
                document.getElementById('usableMargin').textContent = 'Error';
            }
            if (document.getElementById('maxLots')) {
                document.getElementById('maxLots').textContent = 'Error';
            }
        }
    }

    async function updatePositionSize(newLots) {
        const lots = parseInt(newLots);
        if (!lots || lots < 1) return;

        const contract = window.contractData;
        const positionData = window.positionData;

        if (!positionData) {
            console.error('Position data not loaded yet');
            return;
        }

        // Update total margin and capital utilization
        const totalMargin = positionData.margin_per_lot * lots;
        const capitalUtil = (totalMargin / positionData.usable_margin * 100).toFixed(1);

        if (document.getElementById('totalMargin')) {
            document.getElementById('totalMargin').textContent = '‚Çπ' + totalMargin.toLocaleString();
        }
        if (document.getElementById('capitalUtil')) {
            document.getElementById('capitalUtil').textContent = capitalUtil + '%';
        }

        try {
            // Fetch P&L scenarios
            const response = await fetch('/trading/api/calculate-pnl/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    entry_price: contract.futures_price,
                    lots: lots,
                    lot_size: positionData.lot_size,  // Add lot_size from position data
                    direction: contract.direction
                })
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();

            // Check for API success
            if (!data.success) {
                throw new Error(data.error || 'Failed to calculate P&L');
            }

            // Update P&L table
            if (data.scenarios) {
                updatePnLTable(data.scenarios);
            }

            // Update averaging strategy if available
            if (data.averaging_strategy) {
                updateAveragingStrategy(data.averaging_strategy);
            }

        } catch (error) {
            console.error('Error calculating P&L:', error);
        }
    }

    function updatePnLTable(scenarios) {
        const tbody = document.querySelector('#pnlTable tbody');

        if (!tbody) {
            console.error('P&L table tbody not found');
            return;
        }

        if (!scenarios || scenarios.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6B7280;">No scenarios available</td></tr>';
            return;
        }

        tbody.innerHTML = scenarios.map(scenario => {
            // API returns: pnl, pnl_pct, change_pct, exit_price
            const pnl = scenario.pnl || 0;
            const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
            const pnlSign = pnl >= 0 ? '+' : '';
            const changePct = scenario.change_pct || 0;

            return `
                <tr>
                    <td><strong>${changePct > 0 ? '+' : ''}${changePct}%</strong></td>
                    <td>‚Çπ${(scenario.exit_price || 0).toFixed(2)}</td>
                    <td class="${pnlClass}">${pnlSign}‚Çπ${Math.abs(pnl).toLocaleString()}</td>
                    <td class="${pnlClass}">${pnlSign}${(scenario.pnl_pct || 0).toFixed(2)}%</td>
                </tr>
            `;
        }).join('');
    }

    function updateAveragingStrategy(strategy) {
        if (!strategy || !strategy.levels) return;

        strategy.levels.forEach((level, index) => {
            const levelNum = level.level || (index + 1);

            // API returns: trigger_price, lots_to_add, average_price, targets{t1,t2,t3}, stop_loss
            const triggerEl = document.getElementById('avg' + levelNum + 'Trigger');
            const lotsEl = document.getElementById('avg' + levelNum + 'Lots');
            const priceEl = document.getElementById('avg' + levelNum + 'Price');
            const targetEl = document.getElementById('avg' + levelNum + 'Target');
            const stopLossEl = document.getElementById('avg3StopLoss');

            if (triggerEl) {
                triggerEl.textContent = '‚Çπ' + (level.trigger_price || 0).toFixed(2);
            }
            if (lotsEl) {
                lotsEl.textContent = level.lots_to_add || 0;
            }
            if (priceEl) {
                priceEl.textContent = '‚Çπ' + (level.average_price || 0).toFixed(2);
            }

            // For levels 1 and 2, show target. For level 3, show stop loss
            if (levelNum < 3 && targetEl && level.targets) {
                targetEl.textContent = '‚Çπ' + (level.targets.t1 || 0).toFixed(2);
            } else if (levelNum === 3 && stopLossEl) {
                stopLossEl.textContent = '‚Çπ' + (level.stop_loss || 0).toFixed(2);
            }
        });
    }

    function validateLotInput(input) {
        const positionData = window.positionData;
        if (!positionData) return;

        let value = parseInt(input.value);

        // Force integer
        if (isNaN(value) || value < 1) {
            input.value = 1;
            input.style.borderColor = '#EF4444';
            input.style.backgroundColor = '#FEE2E2';
            return;
        }

        // Round to integer if decimal
        if (input.value !== value.toString()) {
            input.value = value;
        }

        // Calculate capital utilization
        const marginRequired = positionData.margin_per_lot * value;
        const capitalUtil = (marginRequired / positionData.usable_margin * 100);

        // Color code based on risk level
        if (value > positionData.max_lots) {
            // Exceeds max - RED
            input.style.borderColor = '#EF4444';
            input.style.backgroundColor = '#FEE2E2';
        } else if (capitalUtil > 80) {
            // High risk (>80%) - ORANGE
            input.style.borderColor = '#F97316';
            input.style.backgroundColor = '#FED7AA';
        } else if (capitalUtil > 50) {
            // Moderate risk (>50%) - YELLOW
            input.style.borderColor = '#F59E0B';
            input.style.backgroundColor = '#FEF3C7';
        } else if (capitalUtil > 30) {
            // Low-moderate risk (>30%) - GREEN-YELLOW
            input.style.borderColor = '#84CC16';
            input.style.backgroundColor = '#ECFCCB';
        } else {
            // Safe (<30%) - GREEN
            input.style.borderColor = '#10B981';
            input.style.backgroundColor = '#D1FAE5';
        }
    }

    function showError(message, containerId = 'positionSizingSection') {
        const errorHTML = `
            <div class="error-banner" style="background: #FEE2E2; border-left: 4px solid #EF4444; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; animation: slideIn 0.3s ease-out;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <span style="font-size: 1.5rem; flex-shrink: 0;">‚ö†Ô∏è</span>
                    <div style="flex: 1;">
                        <strong style="color: #991B1B; display: block; margin-bottom: 0.25rem;">Error</strong>
                        <p style="margin: 0; color: #991B1B; font-size: 0.875rem;">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="flex-shrink: 0; background: transparent; border: none; color: #991B1B; cursor: pointer; font-size: 1.25rem; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">√ó</button>
                </div>
            </div>
        `;

        // Try to find the container
        let container = document.getElementById(containerId);
        if (!container) {
            // Fallback to body if container not found
            container = document.body;
        }

        // Insert at the top of container
        container.insertAdjacentHTML('afterbegin', errorHTML);

        // Auto-dismiss after 10 seconds
        setTimeout(() => {
            const errorBanner = container.querySelector('.error-banner');
            if (errorBanner) {
                errorBanner.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => errorBanner.remove(), 300);
            }
        }, 10000);
    }

    function toggleAveraging() {
        const content = document.getElementById('averagingContent');
        const icon = document.getElementById('averagingIcon');

        if (content.classList.contains('show')) {
            content.classList.remove('show');
            icon.textContent = '‚ñ∂';
        } else {
            content.classList.add('show');
            icon.textContent = '‚ñº';
        }
    }

    async function placeOrder() {
        const button = document.getElementById('placeOrderBtn');
        const statusDiv = document.getElementById('orderStatus');
        const contract = window.contractData;
        const positionData = window.positionData;
        const lots = parseInt(document.getElementById('lotQuantity').value);

        // Validate lots
        if (!lots || lots < 1) {
            alert('Please enter a valid lot quantity (minimum 1)');
            return;
        }

        if (positionData && lots > positionData.max_lots) {
            alert(`Lot quantity (${lots}) exceeds maximum affordable lots (${positionData.max_lots})`);
            return;
        }

        // Calculate margin required
        const marginRequired = positionData ? (positionData.margin_per_lot * lots) : 0;

        // FETCH CONTRACT DETAILS (including instrument token) BEFORE CONFIRMATION
        statusDiv.className = 'order-status pending show';
        statusDiv.textContent = 'Fetching contract details...';

        try {
            const expiryToVerify = contract.expiry_date || contract.expiry;
            const detailsResponse = await fetch(`/trading/api/get-contract-details/?symbol=${contract.symbol}&expiry=${expiryToVerify}`);
            const contractDetails = await detailsResponse.json();

            console.log('[DEBUG] Contract details from API:', contractDetails);

            if (!contractDetails.success) {
                alert(`Error: ${contractDetails.error}\n\nCannot verify contract. Order cancelled.`);
                statusDiv.className = 'order-status error show';
                statusDiv.textContent = contractDetails.error;
                button.disabled = false;
                button.innerHTML = 'üìà Place Order';
                return;
            }

            const instrument = contractDetails.instrument || {};

            // ENHANCED CONFIRMATION DIALOG WITH INSTRUMENT TOKEN FROM BREEZE
            const confirmationMessage = `
‚ö†Ô∏è CONFIRM FUTURES ORDER ‚ö†Ô∏è

Symbol: ${contract.symbol}
Company: ${instrument.company_name || contract.symbol}
Direction: ${contract.direction}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã CONTRACT VERIFICATION (BREEZE)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Instrument Token: ${instrument.token || 'N/A'}
Stock Code: ${instrument.stock_code || contract.symbol}
Expiry: ${contractDetails.expiry_formatted || contract.expiry || 'N/A'}
Lot Size: ${instrument.lot_size || contractDetails.lot_size}
Source: ${instrument.source || 'Unknown'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Lots: ${lots}
Quantity: ${lots * (positionData ? positionData.lot_size : contractDetails.lot_size)}

Entry Price: ‚Çπ${contract.futures_price.toFixed(2)}
Margin Required: ‚Çπ${marginRequired.toLocaleString()}

${contract.stop_loss ? `Stop Loss: ‚Çπ${contract.stop_loss}` : ''}
${contract.target ? `Target: ‚Çπ${contract.target}` : ''}

‚ö†Ô∏è This will place a REAL order with Breeze/ICICI.
Verify the Instrument Token matches your terminal.

Are you absolutely sure?
        `.trim();

            if (!confirm(confirmationMessage)) {
                console.log('Order placement cancelled by user');
                statusDiv.className = '';
                statusDiv.textContent = '';
                button.disabled = false;
                button.innerHTML = 'üìà Place Order';
                return;  // User cancelled
            }
        } catch (error) {
            console.error('[ERROR] Failed to fetch contract details:', error);
            alert(`Error fetching contract details: ${error.message}\n\nOrder cancelled for safety.`);
            statusDiv.className = 'order-status error show';
            statusDiv.textContent = 'Failed to verify contract';
            button.disabled = false;
            button.innerHTML = 'üìà Place Order';
            return;
        }

        // Disable button
        button.disabled = true;
        button.innerHTML = '<span class="loading-spinner"></span> Placing Order...';

        // Show pending status
        statusDiv.className = 'order-status pending show';
        statusDiv.textContent = 'Submitting order to broker...';

        try {
            // Debug logging to verify expiry being sent
            console.log('[DEBUG] Contract object:', contract);
            console.log('[DEBUG] Expiry fields:', {
                expiry_date: contract.expiry_date,
                expiry: contract.expiry
            });

            const expiryToSend = contract.expiry_date || contract.expiry;
            console.log('[DEBUG] Sending expiry:', expiryToSend);

            const response = await fetch('/trading/api/place-futures-order/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    symbol: contract.symbol,
                    expiry: expiryToSend,  // Use YYYY-MM-DD format if available
                    lots: lots,
                    direction: contract.direction,
                    entry_price: contract.futures_price
                })
            });

            const data = await response.json();

            // Log full response for debugging
            console.log('Full API Response:', data);

            if (!response.ok || !data.success) {
                // Display detailed error information
                let errorHtml = `<strong>‚ùå Order Failed!</strong><br>${data.error || 'Unknown error'}<br>`;

                // Add order details if available (even on error)
                if (data.order_details) {
                    errorHtml += `<br><strong>Order Details:</strong><br>`;
                    errorHtml += `Symbol: ${data.order_details.symbol || 'N/A'}<br>`;
                    if (data.order_details.stock_code) {
                        errorHtml += `Stock Code: <strong>${data.order_details.stock_code}</strong><br>`;
                    }
                }

                // Add SecurityMaster info if available
                if (data.security_master) {
                    errorHtml += `<br><strong>üìã SecurityMaster Info:</strong><br>`;
                    errorHtml += `<div style="background: #fff3cd; padding: 8px; border-radius: 4px; font-size: 12px; text-align: left;">`;
                    errorHtml += `Token: ${data.security_master.token}<br>`;
                    errorHtml += `Stock Code: <strong>${data.security_master.stock_code}</strong><br>`;
                    errorHtml += `Lot Size: ${data.security_master.lot_size}<br>`;
                    errorHtml += `Company: ${data.security_master.company_name}`;
                    errorHtml += `</div>`;
                }

                // Add debug info in collapsible section
                if (data.debug_info) {
                    errorHtml += `<br><details style="margin-top: 10px;">`;
                    errorHtml += `<summary style="cursor: pointer; font-weight: bold;">üîç Debug Info (click to expand)</summary>`;
                    errorHtml += `<pre style="text-align: left; font-size: 11px; background: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 200px; overflow: auto; margin-top: 5px;">`;
                    errorHtml += JSON.stringify(data.debug_info, null, 2);
                    errorHtml += `</pre>`;
                    errorHtml += `</details>`;
                }

                // Add Breeze response in collapsible section
                if (data.breeze_response) {
                    errorHtml += `<br><details style="margin-top: 10px;">`;
                    errorHtml += `<summary style="cursor: pointer; font-weight: bold;">üì° Breeze API Response (click to expand)</summary>`;
                    errorHtml += `<pre style="text-align: left; font-size: 11px; background: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 200px; overflow: auto; margin-top: 5px;">`;
                    errorHtml += JSON.stringify(data.breeze_response, null, 2);
                    errorHtml += `</pre>`;
                    errorHtml += `</details>`;
                }

                statusDiv.className = 'order-status error show';
                statusDiv.innerHTML = errorHtml;

                button.disabled = false;
                button.innerHTML = 'üìà Place Order';
                return;
            }

            // Show success status with batch info
            let successHtml = `<strong>‚úÖ Orders Placed Successfully!</strong><br>`;

            // Add batch summary if multiple batches
            if (data.total_batches && data.total_batches > 1) {
                successHtml += `<br><strong>üì¶ Batch Execution Summary:</strong><br>`;
                successHtml += `<div style="background: #e3f2fd; padding: 8px; border-radius: 4px; margin: 5px 0; font-size: 12px; text-align: left;">`;
                successHtml += `Total Batches: ${data.total_batches}<br>`;
                successHtml += `Successful: <strong style="color: green;">${data.successful_batches}</strong>`;
                if (data.failed_batches > 0) {
                    successHtml += ` | Failed: <strong style="color: red;">${data.failed_batches}</strong>`;
                }
                successHtml += `<br>Batch Size: ${data.order_details.batch_size} lots/order<br>`;
                successHtml += `Delay: ${data.order_details.delay_seconds} seconds between orders`;
                successHtml += `</div>`;

                // List all successful orders
                if (data.orders && data.orders.length > 0) {
                    successHtml += `<br><strong>‚úÖ Successful Orders:</strong><br>`;
                    successHtml += `<div style="font-size: 11px; text-align: left;">`;
                    data.orders.forEach(order => {
                        successHtml += `Batch ${order.batch}: Order <strong>${order.order_id}</strong> - ${order.lots} lots (${order.quantity} qty)<br>`;
                    });
                    successHtml += `</div>`;
                }

                // List failed orders if any
                if (data.failed_orders && data.failed_orders.length > 0) {
                    successHtml += `<br><strong>‚ùå Failed Orders:</strong><br>`;
                    successHtml += `<div style="font-size: 11px; color: red; text-align: left;">`;
                    data.failed_orders.forEach(order => {
                        successHtml += `Batch ${order.batch}: ${order.error}<br>`;
                    });
                    successHtml += `</div>`;
                }
            } else {
                // Single order (old format for backward compatibility)
                if (data.order_id) {
                    successHtml += `Order ID: <strong>${data.order_id}</strong><br>`;
                }
                if (data.status) {
                    successHtml += `Status: ${data.status}<br>`;
                }
            }

            successHtml += `<br>${data.message || ''}`;

            // Add order details
            if (data.order_details) {
                successHtml += `<br><br><strong>Order Details:</strong><br>`;
                successHtml += `Symbol: ${data.order_details.symbol}<br>`;
                successHtml += `Stock Code: <strong>${data.order_details.stock_code}</strong><br>`;
                successHtml += `Direction: ${data.order_details.direction}<br>`;
                successHtml += `Total: ${data.order_details.total_quantity} (${data.order_details.total_lots} lots √ó ${data.order_details.lot_size})<br>`;
                successHtml += `Entry Price: ‚Çπ${data.order_details.entry_price.toFixed(2)}<br>`;
                successHtml += `Expiry: ${data.order_details.expiry_date}`;
            }

            // Add SecurityMaster info if available
            if (data.security_master) {
                const source = data.security_master.source || 'security_master';
                const sourceLabel = source === 'breeze_api' ? 'üì° Breeze API' : 'üìã SecurityMaster';
                const sourceBg = source === 'breeze_api' ? '#fff3cd' : '#e8f5e9';  // Yellow for Breeze, green for SecurityMaster

                successHtml += `<br><br><strong>üìã Instrument Info (${sourceLabel}):</strong><br>`;
                successHtml += `<div style="background: ${sourceBg}; padding: 8px; border-radius: 4px; font-size: 12px; text-align: left;">`;

                if (source === 'breeze_api') {
                    successHtml += `‚ö†Ô∏è <em>Fetched from Breeze API (SecurityMaster unavailable)</em><br><br>`;
                }

                successHtml += `Token: ${data.security_master.token}<br>`;
                successHtml += `Stock Code: <strong>${data.security_master.stock_code}</strong><br>`;
                successHtml += `Lot Size: ${data.security_master.lot_size}<br>`;
                successHtml += `Company: ${data.security_master.company_name}`;
                successHtml += `</div>`;
            }

            // Add Breeze response details in collapsible section
            if (data.breeze_response) {
                successHtml += `<br><details style="margin-top: 10px;">`;
                successHtml += `<summary style="cursor: pointer; font-weight: bold;">üì° Breeze API Response (click to expand)</summary>`;
                successHtml += `<pre style="text-align: left; font-size: 11px; background: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 200px; overflow: auto; margin-top: 5px;">`;
                successHtml += JSON.stringify(data.breeze_response, null, 2);
                successHtml += `</pre>`;
                successHtml += `</details>`;
            }

            statusDiv.className = 'order-status success show';
            statusDiv.innerHTML = successHtml;

            // Start polling for order status
            if (data.order_id) {
                setTimeout(() => checkOrderStatus(data.order_id), 2000);
            }

        } catch (error) {
            console.error('Error placing order:', error);
            statusDiv.className = 'order-status error show';
            statusDiv.innerHTML = `
                <strong>Order Failed!</strong><br>
                ${error.message}
            `;

            // Re-enable button
            button.disabled = false;
            button.innerHTML = 'üìà Place Order';
        }
    }

    async function checkOrderStatus(orderId) {
        try {
            const response = await fetch('/api/order-status/' + orderId + '/', {
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to check order status');
            }

            const data = await response.json();
            const statusDiv = document.getElementById('orderStatus');

            // Update status display
            statusDiv.innerHTML = `
                <strong>Order Status Update</strong><br>
                Order ID: ${data.order_id}<br>
                Status: ${data.status}<br>
                ${data.filled_qty ? 'Filled Qty: ' + data.filled_qty + '<br>' : ''}
                ${data.price ? 'Price: ‚Çπ' + data.price + '<br>' : ''}
                ${data.message || ''}
            `;

            // Continue polling if order is still pending
            if (data.status === 'PENDING' || data.status === 'OPEN') {
                setTimeout(() => checkOrderStatus(orderId), 3000);
            } else if (data.status === 'COMPLETE' || data.status === 'FILLED') {
                statusDiv.className = 'order-status success show';
                // Re-enable button for new orders
                const button = document.getElementById('placeOrderBtn');
                button.disabled = false;
                button.innerHTML = 'üìà Place Order';
            } else if (data.status === 'REJECTED' || data.status === 'CANCELLED') {
                statusDiv.className = 'order-status error show';
                // Re-enable button
                const button = document.getElementById('placeOrderBtn');
                button.disabled = false;
                button.innerHTML = 'üìà Place Order';
            }

        } catch (error) {
            console.error('Error checking order status:', error);
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showFullAnalysis(contract) {
        // Display detailed execution log for this contract
        const executionLog = contract.execution_log || [];
        const metrics = contract.metrics || {};
        const scores = contract.scores || {};

        document.getElementById('resultTitle').textContent = `Full Analysis: ${contract.symbol}`;
        document.getElementById('resultBadge').textContent = contract.verdict;
        document.getElementById('resultBadge').className = 'result-badge ' + (contract.verdict === 'PASS' ? 'pass' : 'fail');

        // Build execution log HTML
        let logHTML = '';
        if (executionLog.length > 0) {
            logHTML = `
                <div class="result-section">
                    <h3>üìã Step-by-Step Analysis</h3>
                    <div style="background: var(--lighter); border-radius: var(--radius-md); padding: 1rem;">
                        ${executionLog.map((log, index) => {
                            let statusColor = 'var(--primary)';
                            let statusIcon = '‚óè';
                            let statusBg = 'var(--primary)';

                            if (log.status === 'PASS' || log.status === 'success') {
                                statusColor = 'var(--success)';
                                statusIcon = '‚úì';
                                statusBg = 'var(--success)';
                            } else if (log.status === 'FAIL' || log.status === 'fail') {
                                statusColor = 'var(--danger)';
                                statusIcon = '‚úó';
                                statusBg = 'var(--danger)';
                            } else if (log.status === 'SKIP' || log.status === 'warning') {
                                statusColor = 'var(--warning)';
                                statusIcon = '‚ö†';
                                statusBg = 'var(--warning)';
                            }

                            return `
                                <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid var(--gray-light);">
                                    <span style="flex-shrink: 0; background: ${statusBg}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${log.step}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--dark); margin-bottom: 0.25rem;">${log.action}</div>
                                        <div style="font-size: 0.875rem; color: var(--gray);">${log.message}</div>
                                        ${log.details && Object.keys(log.details).length > 0 ? `
                                            <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: var(--radius-sm); font-family: monospace; max-height: 150px; overflow-y: auto;">
                                                ${Object.entries(log.details).map(([key, value]) => {
                                                    if (typeof value === 'object') return '';
                                                    return `<div><strong>${key}:</strong> ${value}</div>`;
                                                }).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <span style="flex-shrink: 0; color: ${statusColor}; font-size: 1.25rem;">
                                        ${statusIcon}
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        const html = `
            <div class="result-section">
                <h3>Contract Overview</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Symbol</div>
                        <div class="result-item-value">${contract.symbol}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Expiry</div>
                        <div class="result-item-value">${contract.expiry}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Composite Score</div>
                        <div class="result-item-value">${contract.composite_score}/100</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Direction</div>
                        <div class="result-item-value">${contract.direction}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Spot Price</div>
                        <div class="result-item-value">‚Çπ${contract.spot_price.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Futures Price</div>
                        <div class="result-item-value">‚Çπ${contract.futures_price.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Basis</div>
                        <div class="result-item-value">‚Çπ${contract.basis.toFixed(2)} (${contract.basis_pct.toFixed(2)}%)</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Volume</div>
                        <div class="result-item-value">${contract.volume.toLocaleString()}</div>
                    </div>
                </div>
            </div>

            ${logHTML}

            <div class="result-section">
                <h3>Score Breakdown</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Basis</div>
                        <div class="result-item-value">${scores.basis || 0}/10</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Open Interest</div>
                        <div class="result-item-value">${scores.oi || 0}/15</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">DMA</div>
                        <div class="result-item-value">${scores.dma || 0}/15</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Sector</div>
                        <div class="result-item-value">${scores.sector || 0}/20</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Volume</div>
                        <div class="result-item-value">${scores.volume || 0}/10</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Technical</div>
                        <div class="result-item-value">${scores.technical || 0}/15</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Support/Resistance</div>
                        <div class="result-item-value">${scores.sr || 0}/5</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                ${contract.verdict === 'PASS' ? `
                    <button class="btn btn-success" onclick="verifyAndTrade('${contract.symbol}', '${contract.expiry_date}')">
                        ‚úÖ Run & Trade
                    </button>
                ` : ''}
                <button class="btn btn-secondary" onclick="hideResults()">
                    ‚Üê Back to Results
                </button>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    async function verifyAndTrade(symbol, expiryDate) {
        // Hide results panel first
        hideResults();

        // Populate the Verify Future Trade dropdown with this contract
        const contractValue = symbol + '|' + expiryDate;
        const contractSelect = document.getElementById('contractSelect');

        // Find and select the option
        let optionFound = false;
        for (let i = 0; i < contractSelect.options.length; i++) {
            if (contractSelect.options[i].value === contractValue) {
                contractSelect.selectedIndex = i;
                optionFound = true;
                break;
            }
        }

        if (!optionFound) {
            alert(`Contract ${symbol} (${expiryDate}) not found in dropdown. It may need to be refreshed.`);
            return;
        }

        // Scroll to Verify Future Trade card
        const verifyCard = document.querySelector('.trigger-card:nth-child(3)');
        if (verifyCard) {
            verifyCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Highlight the card briefly
            verifyCard.style.boxShadow = '0 0 20px rgba(37, 99, 235, 0.5)';
            verifyCard.style.transition = 'box-shadow 0.3s ease';
            setTimeout(() => {
                verifyCard.style.boxShadow = '';
            }, 2000);
        }

        // Wait a moment, then automatically trigger verification
        setTimeout(() => {
            const verifyBtn = document.getElementById('btnVerify');
            if (verifyBtn) {
                // Flash the button to draw attention
                verifyBtn.style.background = 'var(--success)';
                setTimeout(() => {
                    verifyBtn.style.background = '';
                    // Trigger the verification
                    verifyFutureTrade(verifyBtn);
                }, 500);
            }
        }, 1000);
    }

    function displayFuturesResult(data) {
        const candidate = data.candidate;
        const llm = data.llm_validation;

        document.getElementById('resultTitle').textContent = `Futures Opportunity: ${candidate.symbol}`;
        document.getElementById('resultBadge').textContent = candidate.direction.toUpperCase();
        document.getElementById('resultBadge').className = 'result-badge ' + (candidate.direction === 'BULLISH' ? 'pass' : 'fail');

        const html = `
            <div class="result-section">
                <h3>Trade Details</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Symbol</div>
                        <div class="result-item-value">${candidate.symbol}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Expiry Date</div>
                        <div class="result-item-value">${candidate.expiry || 'N/A'}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Direction</div>
                        <div class="result-item-value">${candidate.direction}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Entry Price</div>
                        <div class="result-item-value">‚Çπ${candidate.entry_price.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Stop Loss</div>
                        <div class="result-item-value">‚Çπ${candidate.stop_loss.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Target</div>
                        <div class="result-item-value">‚Çπ${candidate.target.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Composite Score</div>
                        <div class="result-item-value">${candidate.composite_score}/100</div>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h3>Algorithm Explanation</h3>
                <div class="explanation-box">
                    <h4>Why This Trade?</h4>
                    <p><strong>OI Analysis:</strong> ${candidate.oi_analysis?.buildup_type || 'Strong buildup detected'}</p>
                    <p><strong>Sector Strength:</strong> ${candidate.sector_analysis?.verdict || 'Sector aligned across timeframes'}</p>
                    <p><strong>Technical Setup:</strong> ${candidate.technical_analysis?.summary || 'Price at key support/resistance'}</p>
                    <p><strong>LLM Confidence:</strong> ${llm.confidence}% - ${llm.reasoning || 'Trade validated by AI'}</p>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="takeTrade('${candidate.symbol}', 'FUTURES')">
                    ‚úÖ Take This Trade
                </button>
                <button class="btn btn-secondary" onclick="hideResults()">
                    ‚ùå Reject
                </button>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    // 2. Run Nifty Strangle
    async function runNiftyStrangle(btn) {
        btn.disabled = true;
        document.getElementById('loadingStrangle').classList.add('active');
        document.getElementById('resultsPanel').classList.remove('active');

        try {
            const response = await fetch('{% url "trading:trigger_strangle" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            // Check for authentication error
            if (data.auth_required || (data.error && data.error.includes('Session key is expired'))) {
                // Show re-authentication modal
                showBreezeLoginModal({
                    type: 'nifty_strangle',
                    params: {}
                });
                return;
            }

            if (data.success) {
                console.log('Strangle data received:', data);
                displayStrangleResult(data);
            } else {
                // Check if it's a NO TRADE DAY with validation report
                if (data.is_no_trade_day && data.validation_report) {
                    displayNoTradeDay(data);
                } else {
                    displayError(data.error);
                }
            }
        } catch (error) {
            displayError('Network error: ' + error.message);
        } finally {
            btn.disabled = false;
            document.getElementById('loadingStrangle').classList.remove('active');
        }
    }

    // Build Position Sizing Summary Card - Simple visual card with all position info
    function buildPositionSizingSummaryCard(positionSizing) {
        if (!positionSizing) {
            return '';
        }

        const position = positionSizing.position || {};
        const marginData = positionSizing.margin_data || {};

        const callLots = position.call_lots || 0;
        const totalPremium = position.total_premium_collected || 0;
        const marginUtil = position.margin_utilization_percent || 0;
        const availableMargin = marginData.available_margin || 0;
        const usedMargin = marginData.used_margin || 0;
        const totalMargin = marginData.total_margin || 0;
        const marginPerLot = marginData.margin_per_lot || 0;

        const maxLots = marginPerLot > 0 ? Math.floor(availableMargin / marginPerLot) : 0;

        // Color code margin utilization
        let utilColor = '#D1FAE5';
        if (marginUtil > 60) utilColor = '#FEE2E2';
        else if (marginUtil > 40) utilColor = '#FEF3C7';

        return `
            <div class="result-section" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 2rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                <h3 style="color: white; margin-bottom: 1.5rem; font-size: 1.3rem;">
                    üìä Position Sizing Summary
                </h3>

                <!-- Main Position Info -->
                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem;">
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Recommended Lots</div>
                            <div style="font-size: 2rem; font-weight: 700;">${callLots} Lots</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Call & Put</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Premium Collected</div>
                            <div style="font-size: 2rem; font-weight: 700;">‚Çπ${totalPremium.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Max Profit</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Margin Utilization</div>
                            <div style="font-size: 2rem; font-weight: 700; color: ${utilColor};">${marginUtil.toFixed(1)}%</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Of available margin</div>
                        </div>
                    </div>
                </div>

                <!-- Margin Breakdown -->
                <div style="background: rgba(255,255,255,0.1); padding: 1.25rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                    <h4 style="color: white; font-size: 0.95rem; margin-bottom: 1rem; opacity: 0.9;">üí∞ Margin Breakdown</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; font-size: 0.85rem;">
                        <div>
                            <div style="opacity: 0.8; margin-bottom: 0.25rem;">Available Margin</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${availableMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8; margin-bottom: 0.25rem;">Used Margin</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${usedMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8; margin-bottom: 0.25rem;">Total Margin</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${totalMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8; margin-bottom: 0.25rem;">Margin per Lot</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${marginPerLot.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                        </div>
                    </div>
                </div>

                <!-- Calculation Logic -->
                <div style="background: rgba(255,255,255,0.08); padding: 1rem; border-radius: var(--radius-md); font-size: 0.85rem;">
                    <div style="opacity: 0.9; line-height: 1.6;">
                        <strong>üìê Calculation:</strong><br>
                        <div style="margin-top: 0.5rem; padding-left: 1rem;">
                            ‚Ä¢ Available Margin: ‚Çπ${availableMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}<br>
                            ‚Ä¢ Margin per Lot: ‚Çπ${marginPerLot.toLocaleString('en-IN', {maximumFractionDigits: 0})}<br>
                            ‚Ä¢ Max Lots Possible: ${maxLots} lots<br>
                            ‚Ä¢ <strong>50% Safety Rule:</strong> ${maxLots} √∑ 2 = <strong style="color: #D1FAE5;">${callLots} lots recommended</strong>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Build position sizing section with interactive lot adjustment
    function buildPositionSizingSection(positionSizing, strangle) {
        if (!positionSizing || !strangle) {
            console.warn('Position sizing data not available');
            return '';
        }

        const marginData = positionSizing.margin_data;
        const position = positionSizing.position;
        const pnl = positionSizing.pnl_analysis;

        // Extract initial position data
        const initial = {
            lots: position.call_lots || 0,
            total_quantity: (position.call_lots + position.put_lots) * position.lot_size || 0,
            margin_required: position.total_margin_required || 0,
            margin_utilization_percent: position.margin_utilization_percent || 0,
            premium_collected: position.total_premium_collected || 0,
            premium_per_lot: position.total_premium_collected / (position.call_lots || 1) || 0,
            rom_percent: (position.total_premium_collected / position.total_margin_required * 100) || 0
        };

        // Extract averaging scenarios (use initial_position as fallback for now)
        const averaging = positionSizing.averaging_scenarios || {
            attempt_1: { lots: 0, margin_required: 0, premium_collected: 0 },
            attempt_2: { lots: 0, margin_required: 0, premium_collected: 0 },
            attempt_3: { lots: 0, margin_required: 0, premium_collected: 0 },
            after_attempt_1: { total_lots: initial.lots },
            after_attempt_2: { total_lots: initial.lots },
            after_attempt_3: { total_lots: initial.lots },
            total_after_all_averaging: {
                total_lots: initial.lots,
                total_quantity: initial.total_quantity,
                margin_required: initial.margin_required,
                total_premium_collected: initial.premium_collected
            }
        };

        // Extract risk data
        const risk = {
            max_loss_at_5_percent: Math.abs(Math.min(
                pnl.at_5_percent_rise?.pnl || 0,
                pnl.at_5_percent_drop?.pnl || 0
            )),
            max_profit: position.max_profit || 0
        };

        // Helper function for color coding P&L
        const getPnlColor = (pnl) => pnl >= 0 ? '#D1FAE5' : '#FEE2E2';

        const html = `
            <div class="result-section" style="background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                <h3 style="color: white; margin-bottom: 1rem;">üìä Position Sizing & Risk Analysis</h3>

                <!-- Initial Position -->
                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; backdrop-filter: blur(10px);">
                    <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üéØ Recommended Initial Position</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Recommended Lots</div>
                            <div style="font-size: 1.75rem; font-weight: 700;">${initial.lots}</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">${initial.total_quantity} qty</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Margin Required</div>
                            <div style="font-size: 1.75rem; font-weight: 700;">‚Çπ${(initial.margin_required / 1000).toFixed(0)}K</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">${initial.margin_utilization_percent.toFixed(1)}% used</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Premium Collected</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: #D1FAE5;">‚Çπ${initial.premium_collected.toFixed(0)}</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">per lot: ‚Çπ${initial.premium_per_lot.toFixed(0)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Return on Margin</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: #FEF3C7;">${initial.rom_percent.toFixed(2)}%</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">if held to expiry</div>
                        </div>
                    </div>

                    <!-- Interactive Lot Adjustment -->
                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">
                            Adjust Number of Lots
                        </label>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button onclick="adjustLots(-1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: var(--radius-md); font-size: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚àí</button>
                            <input type="number" id="lotsInput" value="1" data-lots="${initial.lots}" min="1" max="50"
                                   onchange="updatePositionCalculations()"
                                   style="flex: 1; background: rgba(255,255,255,0.9); border: none; padding: 0.75rem; border-radius: var(--radius-md); font-size: 1.25rem; font-weight: 700; text-align: center; color: #1F2937;">
                            <button onclick="adjustLots(1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: var(--radius-md); font-size: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">+</button>
                        </div>
                        <div id="adjustedCalculations" style="margin-top: 1rem; font-size: 0.875rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                                <span>Total Quantity:</span>
                                <span id="adjQuantity" style="font-weight: 700;">${initial.total_quantity}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                                <span>Margin Required:</span>
                                <span id="adjMargin" style="font-weight: 700;">‚Çπ${initial.margin_required.toFixed(0)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                                <span>Premium Collected:</span>
                                <span id="adjPremium" style="font-weight: 700; color: #D1FAE5;">‚Çπ${initial.premium_collected.toFixed(0)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span>Return on Margin:</span>
                                <span id="adjROM" style="font-weight: 700; color: #FEF3C7;">${initial.rom_percent.toFixed(2)}%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Averaging Scenarios -->
                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; backdrop-filter: blur(10px);">
                    <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üîÑ Averaging Down Scenarios (20-50-50 Protocol)</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <!-- Attempt 1 -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                üìç Attempt 1 (20% Balance)
                            </div>
                            <div style="font-size: 0.75rem; margin-bottom: 0.5rem;">
                                <div style="opacity: 0.8;">Trigger: Position -1%</div>
                                <div style="opacity: 0.8;">Entry: Current premiums</div>
                            </div>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Additional Lots:</span>
                                    <span style="font-weight: 700;">${averaging.attempt_1.lots}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Margin:</span>
                                    <span style="font-weight: 700;">‚Çπ${(averaging.attempt_1.margin_required / 1000).toFixed(0)}K</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                                    <span>Total So Far:</span>
                                    <span style="font-weight: 700; color: #D1FAE5;">${averaging.after_attempt_1.total_lots} lots</span>
                                </div>
                            </div>
                        </div>

                        <!-- Attempt 2 -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                üìç Attempt 2 (50% Balance)
                            </div>
                            <div style="font-size: 0.75rem; margin-bottom: 0.5rem;">
                                <div style="opacity: 0.8;">Trigger: Position -1% again</div>
                                <div style="opacity: 0.8;">Entry: Current premiums</div>
                            </div>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Additional Lots:</span>
                                    <span style="font-weight: 700;">${averaging.attempt_2.lots}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Margin:</span>
                                    <span style="font-weight: 700;">‚Çπ${(averaging.attempt_2.margin_required / 1000).toFixed(0)}K</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                                    <span>Total So Far:</span>
                                    <span style="font-weight: 700; color: #D1FAE5;">${averaging.after_attempt_2.total_lots} lots</span>
                                </div>
                            </div>
                        </div>

                        <!-- Attempt 3 -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                üìç Attempt 3 (50% Balance)
                            </div>
                            <div style="font-size: 0.75rem; margin-bottom: 0.5rem;">
                                <div style="opacity: 0.8;">Trigger: Position -1% again</div>
                                <div style="opacity: 0.8;">Entry: Current premiums</div>
                            </div>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Additional Lots:</span>
                                    <span style="font-weight: 700;">${averaging.attempt_3.lots}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Margin:</span>
                                    <span style="font-weight: 700;">‚Çπ${(averaging.attempt_3.margin_required / 1000).toFixed(0)}K</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                                    <span>Total So Far:</span>
                                    <span style="font-weight: 700; color: #D1FAE5;">${averaging.total_after_all_averaging.total_lots} lots</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Final Position Summary -->
                    <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: var(--radius-md);">
                        <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">
                            üìà After All Averaging Attempts
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem;">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">Total Lots</div>
                                <div style="font-size: 1.25rem; font-weight: 700;">${averaging.total_after_all_averaging.total_lots}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">Total Quantity</div>
                                <div style="font-size: 1.25rem; font-weight: 700;">${averaging.total_after_all_averaging.total_quantity}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">Total Margin</div>
                                <div style="font-size: 1.25rem; font-weight: 700;">‚Çπ${((averaging.total_after_all_averaging.margin_required || averaging.total_after_all_averaging.total_margin_required || 0) / 1000).toFixed(0)}K</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">Total Premium</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: #D1FAE5;">‚Çπ${(averaging.total_after_all_averaging.total_premium_collected || 0).toFixed(0)}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- P&L Analysis -->
                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                    <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üí∞ P&L at Key Price Levels</h4>

                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.1);">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.2);">Price Level</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.2);">Nifty Price</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.2);">P&L</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.2);">ROI %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pnl.at_resistance_1 ? `
                                <tr style="background: rgba(255,255,255,0.05);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">üìà Resistance 1</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.at_resistance_1.nifty_price.toFixed(2)}</td>
                                    <td id="pnlR1" style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: ${getPnlColor(pnl.at_resistance_1.pnl)};">‚Çπ${pnl.at_resistance_1.pnl.toFixed(0)}</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">${pnl.at_resistance_1.roi_percent.toFixed(2)}%</td>
                                </tr>
                                ` : ''}
                                ${pnl.at_5_percent_rise ? `
                                <tr style="background: rgba(255,255,255,0.05);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">üìà +5% Rise</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.at_5_percent_rise.nifty_price.toFixed(2)}</td>
                                    <td id="pnlRise5" style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: ${getPnlColor(pnl.at_5_percent_rise.pnl)};">‚Çπ${pnl.at_5_percent_rise.pnl.toFixed(0)}</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">${pnl.at_5_percent_rise.roi_percent.toFixed(2)}%</td>
                                </tr>
                                ` : ''}
                                ${pnl.breakeven_upper ? `
                                <tr style="background: rgba(255,255,255,0.08);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">‚öñÔ∏è Upper Breakeven</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.breakeven_upper.nifty_price.toFixed(2)}</td>
                                    <td style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: #FEF3C7;">‚Çπ0</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">0.00%</td>
                                </tr>
                                ` : ''}
                                ${pnl.breakeven_lower ? `
                                <tr style="background: rgba(255,255,255,0.08);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">‚öñÔ∏è Lower Breakeven</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.breakeven_lower.nifty_price.toFixed(2)}</td>
                                    <td style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: #FEF3C7;">‚Çπ0</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">0.00%</td>
                                </tr>
                                ` : ''}
                                ${pnl.at_support_1 ? `
                                <tr style="background: rgba(255,255,255,0.05);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">üìâ Support 1</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.at_support_1.nifty_price.toFixed(2)}</td>
                                    <td id="pnlS1" style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: ${getPnlColor(pnl.at_support_1.pnl)};">‚Çπ${pnl.at_support_1.pnl.toFixed(0)}</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">${pnl.at_support_1.roi_percent.toFixed(2)}%</td>
                                </tr>
                                ` : ''}
                                ${pnl.at_5_percent_drop ? `
                                <tr style="background: rgba(255,255,255,0.05);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">üìâ -5% Drop</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.at_5_percent_drop.nifty_price.toFixed(2)}</td>
                                    <td id="pnlDrop5" style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: ${getPnlColor(pnl.at_5_percent_drop.pnl)};">‚Çπ${pnl.at_5_percent_drop.pnl.toFixed(0)}</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">${pnl.at_5_percent_drop.roi_percent.toFixed(2)}%</td>
                                </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: var(--radius-md); font-size: 0.75rem; opacity: 0.9;">
                        <div style="margin-bottom: 0.5rem;">
                            <strong>üí° Note:</strong> P&L calculated with ${averaging.total_after_all_averaging.total_lots} lots (after all averaging attempts)
                        </div>
                        <div>
                            <strong>üìä Risk Range:</strong> Max Loss: ‚Çπ${risk.max_loss_at_5_percent.toFixed(0)} | Max Profit: ‚Çπ${risk.max_profit.toFixed(0)} (if both expire worthless)
                        </div>
                    </div>
                </div>

            </div>
        `;

        // Store position sizing data for later use
        if (positionSizing && strangle) {
            const psData = document.createElement('div');
            psData.id = 'positionSizingData';
            psData.style.display = 'none';
            psData.textContent = JSON.stringify(positionSizing);

            const sData = document.createElement('div');
            sData.id = 'strangleData';
            sData.style.display = 'none';
            sData.textContent = JSON.stringify({
                call_strike: strangle.call_strike,
                put_strike: strangle.put_strike,
                call_premium: strangle.call_premium,
                put_premium: strangle.put_premium,
                total_premium: strangle.total_premium
            });

            // We'll append these after setting innerHTML and update the lots input
            setTimeout(() => {
                const resultContent = document.getElementById('resultContent');
                if (resultContent) {
                    resultContent.appendChild(psData);
                    resultContent.appendChild(sData);

                    // Update the lots input with the actual value from data attribute
                    const lotsInput = document.getElementById('lotsInput');
                    if (lotsInput && lotsInput.dataset.lots) {
                        lotsInput.value = lotsInput.dataset.lots;
                    }
                }
            }, 0);
        }

        return html;
    }

    function displayStrangleResult(data) {
        console.log('displayStrangleResult called with:', data);
        const strangle = data.strangle;
        const reasoning = strangle.reasoning;
        const executionLog = strangle.execution_log || [];
        console.log('Position sizing data:', data.strangle?.position_sizing);

        document.getElementById('resultTitle').textContent = 'Nifty Strangle Position';
        document.getElementById('resultBadge').textContent = 'SELL STRANGLE';
        document.getElementById('resultBadge').className = 'result-badge pass';

        // Build execution log HTML
        let logHTML = '';
        if (executionLog.length > 0) {
            logHTML = `
                <div class="result-section">
                    <h3>üìã Execution Log</h3>
                    <div style="background: var(--lighter); border-radius: var(--radius-md); padding: 1rem;">
                        ${executionLog.map((log, index) => `
                            <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-light);">
                                <span style="flex-shrink: 0; background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${log.step}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--dark); margin-bottom: 0.25rem;">${log.action}</div>
                                    <div style="font-size: 0.875rem; color: var(--gray);">${log.message}</div>
                                    ${log.details ? `<div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem; font-family: monospace;">${JSON.stringify(log.details, null, 2).substring(0, 200)}${JSON.stringify(log.details).length > 200 ? '...' : ''}</div>` : ''}
                                </div>
                                <span style="flex-shrink: 0; color: var(--success); font-size: 1.25rem;">‚úì</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Build market validation report section
        let validationHTML = '';
        if (strangle.validation_report && strangle.validation_report.validation_results) {
            const validation = strangle.validation_report;
            const results = validation.validation_results || [];

            // Determine overall color based on verdict
            let verdictColor = '#10B981'; // Green (success)
            let verdictBg = '#D1FAE5';
            if (validation.overall_verdict.includes('NO TRADE')) {
                verdictColor = '#EF4444'; // Red (fail)
                verdictBg = '#FEE2E2';
            } else if (validation.overall_verdict.includes('CAUTION')) {
                verdictColor = '#F59E0B'; // Orange (warning)
                verdictBg = '#FEF3C7';
            }

            validationHTML = `
                <div class="result-section" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                    <h3 style="color: white; margin-bottom: 1rem;">üõ°Ô∏è Market Condition Validation</h3>

                    <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; backdrop-filter: blur(10px);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Overall Verdict</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">${validation.overall_verdict}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Status</div>
                                <div style="display: inline-block; background: ${verdictBg}; color: ${verdictColor}; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 600; font-size: 0.875rem;">
                                    ${validation.trade_allowed ? '‚úì ALLOWED' : '‚úó BLOCKED'}
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 0.875rem; opacity: 0.95; line-height: 1.6;">
                            ${validation.verdict_reason}
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #D1FAE5;">${validation.status_summary.PASS || 0}</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">PASSED</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #FEF3C7;">${validation.status_summary.WARNING || 0}</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">WARNINGS</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #FEE2E2;">${validation.status_summary.FAIL || 0}</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">FAILED</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #E5E7EB;">${validation.status_summary.SKIP || 0}</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">SKIPPED</div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                        <h4 style="color: white; font-size: 0.9rem; margin-bottom: 0.75rem; opacity: 0.9;">Detailed Validation Checks</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${results.map((result, idx) => {
                                let statusIcon = '‚úì';
                                let statusColor = '#D1FAE5';
                                if (result.status === 'FAIL') {
                                    statusIcon = '‚úó';
                                    statusColor = '#FEE2E2';
                                } else if (result.status === 'WARNING') {
                                    statusIcon = '‚ö†';
                                    statusColor = '#FEF3C7';
                                } else if (result.status === 'SKIP') {
                                    statusIcon = '‚óã';
                                    statusColor = '#E5E7EB';
                                }

                                return `
                                    <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: var(--radius-sm); border-left: 3px solid ${statusColor};">
                                        <div style="display: flex; align-items: start; gap: 0.75rem;">
                                            <span style="font-size: 1.25rem; color: ${statusColor};">${statusIcon}</span>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; margin-bottom: 0.25rem; font-size: 0.875rem;">${result.check}</div>
                                                <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.5rem;">${result.message}</div>
                                                ${Object.keys(result.details).length > 0 ? `
                                                    <div style="font-size: 0.7rem; opacity: 0.8; font-family: monospace; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: var(--radius-sm); max-height: 100px; overflow-y: auto;">
                                                        ${Object.entries(result.details).map(([key, value]) => {
                                                            if (typeof value === 'object') return '';
                                                            return `<div><strong>${key}:</strong> ${typeof value === 'number' ? value.toFixed(2) : value}</div>`;
                                                        }).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <span style="font-weight: 600; font-size: 0.75rem; color: ${statusColor};">${result.status}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Build delta details section
        let deltaHTML = '';
        if (strangle.delta_details) {
            const delta = strangle.delta_details;
            const breakdown = delta.delta_breakdown || {};
            const calcLog = delta.calculation_log || [];

            deltaHTML = `
                <div class="result-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                    <h3 style="color: white; margin-bottom: 1rem;">üéØ Smart Delta Calculation</h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Base Delta</div>
                            <div style="font-size: 1.75rem; font-weight: 700;">${delta.base_delta.toFixed(2)}%</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">${strangle.days_to_expiry} days expiry</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Adjusted Delta</div>
                            <div style="font-size: 1.75rem; font-weight: 700;">${delta.adjusted_delta.toFixed(3)}%</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">After ${Object.keys(breakdown).length} adjustments</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Strike Distance</div>
                            <div style="font-size: 1.75rem; font-weight: 700;">${delta.strike_distance.toFixed(0)}</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">points from spot</div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; backdrop-filter: blur(10px);">
                        <h4 style="color: white; font-size: 0.9rem; margin-bottom: 0.75rem; opacity: 0.9;">Delta Adjustment Factors</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">
                            ${Object.entries(breakdown).map(([key, value]) => `
                                <div style="background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: var(--radius-sm);">
                                    <div style="font-size: 0.75rem; opacity: 0.8;">${key.replace('_multiplier', '').replace(/_/g, ' ').toUpperCase()}</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;">${value.toFixed(2)}x</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${calcLog.length > 0 ? `
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <h4 style="color: white; font-size: 0.9rem; margin-bottom: 0.75rem; opacity: 0.9;">Calculation Steps</h4>
                            <div style="max-height: 250px; overflow-y: auto; font-size: 0.85rem;">
                                ${calcLog.map((step, idx) => `
                                    <div style="padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${step.factor}</div>
                                        <div style="opacity: 0.9;">${step.reason}</div>
                                        ${step.value !== undefined && step.value !== null ? `<div style="opacity: 0.8; font-size: 0.75rem; margin-top: 0.25rem;">Value: ${typeof step.value === 'number' ? step.value.toFixed(2) : step.value} | Multiplier: ${step.multiplier}x</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Extract position sizing data for direct template insertion
        console.log('=== POSITION SIZING DATA DEBUG ===');
        console.log('Full data object:', data);
        console.log('data.strangle.position_sizing:', data.strangle?.position_sizing);

        const psPosition = data.strangle?.position_sizing?.position || {};
        const psMarginData = data.strangle?.position_sizing?.margin_data || {};

        console.log('psPosition:', psPosition);
        console.log('psMarginData:', psMarginData);

        const psCallLots = psPosition.call_lots || 0;
        const psTotalPremium = psPosition.total_premium_collected || 0;
        const psMarginUtil = psPosition.margin_utilization_percent || 0;
        const psAvailableMargin = psMarginData.available_margin || 0;
        const psUsedMargin = psMarginData.used_margin || 0;
        const psTotalMargin = psMarginData.total_margin || 0;
        const psMarginPerLot = psMarginData.margin_per_lot || 0;
        const psMaxLots = psMarginPerLot > 0 ? Math.floor(psAvailableMargin / psMarginPerLot) : 0;

        console.log('Extracted values:', {
            psCallLots, psTotalPremium, psMarginUtil,
            psAvailableMargin, psUsedMargin, psTotalMargin, psMarginPerLot, psMaxLots
        });

        // Color code margin utilization
        let psUtilColor = '#D1FAE5';
        if (psMarginUtil > 60) psUtilColor = '#FEE2E2';
        else if (psMarginUtil > 40) psUtilColor = '#FEF3C7';

        // Store position sizing data globally for refresh
        window.currentStrangleData = data;

        let positionSizingHTML = '';
        try {
            if (data.strangle?.position_sizing) {
                positionSizingHTML = buildPositionSizingSection(data.strangle.position_sizing, strangle);
                console.log('Position sizing HTML generated successfully');
            }
        } catch (error) {
            console.error('Error building position sizing section:', error);
            positionSizingHTML = '<div class="result-section"><p style="color: red;">Error loading position sizing. See console for details.</p></div>';
        }

        const html = `
            ${logHTML}
            ${validationHTML}
            ${deltaHTML}

            <div class="result-section">
                <h3>Position Details</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Underlying</div>
                        <div class="result-item-value">${strangle.underlying}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Current Price</div>
                        <div class="result-item-value">‚Çπ${strangle.current_price.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">India VIX</div>
                        <div class="result-item-value">${strangle.vix}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Expiry Date</div>
                        <div class="result-item-value">${strangle.expiry_date}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Days to Expiry</div>
                        <div class="result-item-value">${strangle.days_to_expiry} days</div>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h3>Strikes & Premiums</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Call Strike</div>
                        <div class="result-item-value">${strangle.call_strike} CE</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Call Premium</div>
                        <div class="result-item-value">‚Çπ${strangle.call_premium.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Put Strike</div>
                        <div class="result-item-value">${strangle.put_strike} PE</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Put Premium</div>
                        <div class="result-item-value">‚Çπ${strangle.put_premium.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Total Premium</div>
                        <div class="result-item-value">‚Çπ${strangle.total_premium.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Margin Required</div>
                        <div class="result-item-value">‚Çπ${strangle.margin_required.toFixed(0)}</div>
                    </div>
                </div>
            </div>

            <!-- Position Sizing Summary Card -->
            <div class="result-section" id="positionSummaryCard" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 2rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="color: white; font-size: 1.3rem; margin: 0;">
                        üìä Position Sizing Summary
                    </h3>
                    <button onclick="refreshPositionSummary()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                        üîÑ Refresh Data
                    </button>
                </div>

                <!-- Main Position Info -->
                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem;">
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Recommended Lots</div>
                            <div style="font-size: 2rem; font-weight: 700;">${psCallLots} Lots</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Call & Put</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Premium Collected</div>
                            <div style="font-size: 2rem; font-weight: 700;">‚Çπ${psTotalPremium.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Max Profit</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Margin Utilization</div>
                            <div style="font-size: 2rem; font-weight: 700; color: ${psUtilColor};">${psMarginUtil.toFixed(1)}%</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Of available margin</div>
                        </div>
                    </div>
                </div>

                <!-- Margin Breakdown -->
                <div style="background: rgba(255,255,255,0.1); padding: 1.25rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                    <h4 style="color: white; font-size: 0.95rem; margin-bottom: 1rem; opacity: 0.9;">üí∞ Margin Breakdown</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; font-size: 0.85rem;">
                        <div>
                            <div style="opacity: 0.8; margin-bottom: 0.25rem;">Available Margin</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${psAvailableMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8; margin-bottom: 0.25rem;">Used Margin</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${psUsedMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8; margin-bottom: 0.25rem;">Total Margin</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${psTotalMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8; margin-bottom: 0.25rem;">Margin per Lot</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${psMarginPerLot.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                        </div>
                    </div>
                </div>

                <!-- Calculation Logic -->
                <div style="background: rgba(255,255,255,0.08); padding: 1rem; border-radius: var(--radius-md); font-size: 0.85rem;">
                    <div style="opacity: 0.9; line-height: 1.6;">
                        <strong>üìê Calculation:</strong><br>
                        <div style="margin-top: 0.5rem; padding-left: 1rem;">
                            ‚Ä¢ Available Margin: ‚Çπ${psAvailableMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}<br>
                            ‚Ä¢ Margin per Lot: ‚Çπ${psMarginPerLot.toLocaleString('en-IN', {maximumFractionDigits: 0})}<br>
                            ‚Ä¢ Max Lots Possible: ${psMaxLots} lots<br>
                            ‚Ä¢ <strong>50% Safety Rule:</strong> ${psMaxLots} √∑ 2 = <strong style="color: #D1FAE5;">${psCallLots} lots recommended</strong>
                        </div>
                    </div>
                </div>
            </div>

            ${positionSizingHTML}

            <div class="result-section">
                <h3>Strategy Explanation</h3>
                <div class="explanation-box">
                    <h4>Why This Strangle?</h4>
                    <p><strong>Strike Selection:</strong> ${reasoning.strike_selection}</p>
                    <p><strong>Risk Profile:</strong> ${reasoning.risk_profile}</p>
                    <p><strong>Entry Logic:</strong> ${reasoning.entry_logic}</p>
                    <p><strong>Exit Strategy:</strong> ${reasoning.exit_strategy}</p>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="takeTradeSuggestion(${strangle.suggestion_id})">
                    ‚úÖ Take This Trade
                </button>
                <button class="btn btn-secondary" onclick="rejectTradeSuggestion(${strangle.suggestion_id})">
                    ‚ùå Reject
                </button>
                <button class="btn btn-info" onclick="viewSuggestionHistory()">
                    üìã View History
                </button>
            </div>

            <!-- Suggestion ID Badge -->
            <div style="text-align: center; margin-top: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(59, 130, 246, 0.3);">
                <span style="font-size: 0.85rem; color: #6B7280;">Suggestion ID: <strong style="color: #3B82F6;">#${strangle.suggestion_id}</strong></span>
                <span style="margin-left: 1rem; font-size: 0.85rem; color: #6B7280;">Status: <strong style="color: #10B981;">SUGGESTED</strong></span>
                <span style="margin-left: 1rem; font-size: 0.85rem; color: #6B7280;">Expires: 24 hours</span>
            </div>
        `;

        // Store suggestion_id globally
        window.currentSuggestionId = strangle.suggestion_id;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    // Refresh Position Sizing Summary with latest data
    function refreshPositionSummary() {
        console.log('=== REFRESH POSITION SUMMARY ===');

        if (!window.currentStrangleData) {
            console.error('No strangle data available to refresh');
            alert('No position data available. Please generate a strangle position first.');
            return;
        }

        const data = window.currentStrangleData;
        console.log('Refreshing with data:', data);
        console.log('data.strangle.position_sizing:', data.strangle?.position_sizing);

        const positionSizing = data.strangle?.position_sizing;
        if (!positionSizing) {
            console.error('position_sizing is missing from data');
            alert('Position sizing data is missing. Please regenerate the strangle position.');
            return;
        }

        const position = positionSizing.position || {};
        const marginData = positionSizing.margin_data || {};

        console.log('position:', position);
        console.log('marginData:', marginData);

        // Extract values with defaults
        const callLots = position.call_lots || 0;
        const totalPremium = position.total_premium_collected || 0;
        const marginUtil = position.margin_utilization_percent || 0;
        const availableMargin = marginData.available_margin || 0;
        const usedMargin = marginData.used_margin || 0;
        const totalMargin = marginData.total_margin || 0;
        const marginPerLot = marginData.margin_per_lot || 0;
        const maxLots = marginPerLot > 0 ? Math.floor(availableMargin / marginPerLot) : 0;

        console.log('Extracted values:', {
            callLots, totalPremium, marginUtil, availableMargin,
            usedMargin, totalMargin, marginPerLot, maxLots
        });

        // Update the Position Sizing Summary card by rebuilding it
        const card = document.getElementById('positionSummaryCard');
        if (!card) {
            console.error('Position summary card not found in DOM');
            return;
        }

        // Rebuild the entire card with fresh data
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: white; font-size: 1.3rem; margin: 0;">
                    üìä Position Sizing Summary
                </h3>
                <button onclick="refreshPositionSummary()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                    üîÑ Refresh Data
                </button>
            </div>

            <!-- Main Position Info -->
            <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem;">
                    <div>
                        <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Recommended Lots</div>
                        <div style="font-size: 2rem; font-weight: 700;">${callLots} Lots</div>
                        <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Call & Put</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Premium Collected</div>
                        <div style="font-size: 2rem; font-weight: 700;">‚Çπ${totalPremium.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                        <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Maximum Profit</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Margin Utilization</div>
                        <div style="font-size: 2rem; font-weight: 700;">${marginUtil.toFixed(1)}%</div>
                        <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Of Available</div>
                    </div>
                </div>
            </div>

            <!-- Margin Breakdown -->
            <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                <h4 style="color: white; font-size: 1rem; margin: 0 0 1rem 0; opacity: 0.95;">üí∞ Margin Breakdown</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div>
                        <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">Available Margin</div>
                        <div style="font-size: 1.25rem; font-weight: 600;">‚Çπ${availableMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">Used Margin</div>
                        <div style="font-size: 1.25rem; font-weight: 600;">‚Çπ${usedMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">Total Margin</div>
                        <div style="font-size: 1.25rem; font-weight: 600;">‚Çπ${totalMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">Margin per Lot</div>
                        <div style="font-size: 1.25rem; font-weight: 600;">‚Çπ${marginPerLot.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                    </div>
                </div>
            </div>

            <!-- Calculation Logic -->
            <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: var(--radius-md); border-left: 4px solid rgba(255,255,255,0.5);">
                <h4 style="color: white; font-size: 1rem; margin: 0 0 1rem 0; opacity: 0.95;">üßÆ Calculation Logic</h4>
                <div style="font-size: 0.85rem; line-height: 1.8; opacity: 0.95;">
                    <strong>How we calculated ${callLots} lots:</strong><br>
                    ‚Ä¢ Available Margin: ‚Çπ${availableMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}<br>
                    ‚Ä¢ Margin per Lot: ‚Çπ${marginPerLot.toLocaleString('en-IN', {maximumFractionDigits: 0})}<br>
                    ‚Ä¢ Max Lots Possible: ${maxLots} lots<br>
                    ‚Ä¢ <strong>50% Safety Rule:</strong> ${maxLots} √∑ 2 = <strong style="color: #D1FAE5;">${callLots} lots recommended</strong>
                </div>
            </div>
        `;

        console.log('Position summary card refreshed successfully');
        alert('Position summary refreshed successfully!');
    }

    // Fetch and display margin data from Neo API
    async function fetchMarginData() {
        try {
            const response = await fetch('/trading/api/get-margins/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });

            const result = await response.json();

            if (result.success && result.data) {
                updateMarginDisplay(result.data);
            } else {
                showMarginError(result.error || 'Failed to fetch margin data');
            }

        } catch (error) {
            console.error('Error fetching margin data:', error);
            showMarginError('Network error: ' + error.message);
        }
    }

    // Update margin display with fetched data
    function updateMarginDisplay(data) {
        // Store margin data globally for later use
        window.lastMarginData = data;

        // Update Available Margin
        const availableMargin = document.getElementById('availableMarginValue');
        if (availableMargin) {
            availableMargin.innerHTML = `<strong style="color: var(--success);">‚Çπ${data.available_margin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</strong>`;
        }

        // Update Used Margin
        const usedMargin = document.getElementById('usedMarginValue');
        if (usedMargin) {
            usedMargin.innerHTML = `<strong style="color: var(--danger);">‚Çπ${data.used_margin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</strong>`;
        }

        // Update Total Margin
        const totalMargin = document.getElementById('totalMarginValue');
        if (totalMargin) {
            totalMargin.innerHTML = `<strong>‚Çπ${data.total_margin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</strong>`;
        }

        // Update Collateral Value
        const collateral = document.getElementById('collateralValue');
        if (collateral) {
            collateral.innerHTML = `<strong>‚Çπ${data.collateral.toLocaleString('en-IN', {maximumFractionDigits: 0})}</strong>`;
        }

        // Update Margin Utilization with color coding
        const utilization = document.getElementById('marginUtilization');
        if (utilization) {
            const pct = data.margin_utilization_pct;
            let color = 'var(--success)';
            if (pct > 80) {
                color = 'var(--danger)';
            } else if (pct > 60) {
                color = 'var(--warning)';
            }
            utilization.innerHTML = `<strong style="color: ${color};">${pct}%</strong>`;
        }

        // Update Last Updated
        const lastUpdated = document.getElementById('marginLastUpdated');
        if (lastUpdated) {
            lastUpdated.textContent = data.last_updated;
        }

        // Update lot calculation with TOTAL MARGIN (not available_margin which is collateral)
        // Total Margin = funds available for new positions
        updateLotCalculationWithMargin(data.total_margin);
    }

    // Update lot calculation display with position sizing data
    function updateLotCalculation(positionSizing, strangle) {
        console.log('updateLotCalculation called with:', { positionSizing, strangle });

        if (!positionSizing) {
            console.warn('Position sizing data is null/undefined');
            return;
        }

        // Extract from the correct structure
        const position = positionSizing.position || {};
        const marginData = positionSizing.margin_data || {};

        console.log('Position object:', position);
        console.log('Margin data object:', marginData);

        // Extract values from correct fields
        const recommendedLots = position.call_lots || 0;
        const marginPerLot = marginData.margin_per_lot || 0;
        const availableMargin = marginData.available_margin || 0;
        const maxProfit = position.total_premium_collected || 0;
        const totalMarginRequired = position.total_margin_required || 0;

        console.log('Extracted values:', {
            recommendedLots,
            marginPerLot,
            availableMargin,
            maxProfit,
            totalMarginRequired
        });

        if (recommendedLots === 0) {
            console.warn('Recommended lots is 0, cannot calculate');
            return;
        }

        // Update recommendation
        const lotRecommendation = document.getElementById('lotRecommendation');
        if (lotRecommendation) {
            lotRecommendation.textContent = `${recommendedLots} Lots`;
        }

        // Update margin per lot
        const calcMarginPerLot = document.getElementById('calcMarginPerLot');
        if (calcMarginPerLot) {
            calcMarginPerLot.innerHTML = `<strong>‚Çπ${marginPerLot.toLocaleString('en-IN', {maximumFractionDigits: 0})}</strong>`;
        }

        // Update final lots
        const calcFinalLots = document.getElementById('calcFinalLots');
        if (calcFinalLots) {
            calcFinalLots.innerHTML = `<strong style="color: #10B981;">${recommendedLots}</strong>`;
        }

        // Store data for when margin API returns (to complete the calculation)
        window.currentPositionData = {
            recommendedLots: recommendedLots,
            marginPerLot: marginPerLot,
            availableMargin: availableMargin,
            maxProfit: maxProfit,
            totalMarginRequired: totalMarginRequired
        };

        console.log('Stored currentPositionData:', window.currentPositionData);

        // If we already have margin data from API, update immediately with TOTAL MARGIN
        if (window.lastMarginData && window.lastMarginData.total_margin) {
            console.log('Margin data already available, updating immediately with total_margin:', window.lastMarginData.total_margin);
            updateLotCalculationWithMargin(window.lastMarginData.total_margin);
        } else if (availableMargin > 0) {
            // Use the available margin from position sizing as fallback
            console.log('Using available margin from position sizing data:', availableMargin);
            updateLotCalculationWithMargin(availableMargin);
        } else {
            console.warn('No margin data available yet, will update when margin API returns');
        }
    }

    // Update lot calculation with margin data (called after margin API returns)
    function updateLotCalculationWithMargin(totalMarginAvailable) {
        // IMPORTANT: Use Total Margin (not collateral) for calculations
        // Total Margin = Available funds that can be used for new positions
        const actualAvailableMargin = window.lastMarginData ? window.lastMarginData.total_margin : totalMarginAvailable;

        console.log('updateLotCalculationWithMargin called');
        console.log('Total Margin (actual available):', actualAvailableMargin);
        console.log('Current position data:', window.currentPositionData);

        const calcAvailableMargin = document.getElementById('calcAvailableMargin');
        if (calcAvailableMargin) {
            calcAvailableMargin.innerHTML = `<strong>‚Çπ${actualAvailableMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}</strong>`;
        }

        // If we have position data, recalculate
        if (window.currentPositionData && window.currentPositionData.marginPerLot > 0) {
            const marginPerLot = window.currentPositionData.marginPerLot;
            const recommendedLots = window.currentPositionData.recommendedLots;
            const maxProfit = window.currentPositionData.maxProfit;

            console.log('‚úÖ Position data available, calculating lots...');
            console.log('marginPerLot:', marginPerLot);
            console.log('recommendedLots:', recommendedLots);
            console.log('maxProfit:', maxProfit);

            // Calculate using 50% of TOTAL MARGIN (not collateral)
            const safeMargin = actualAvailableMargin * 0.5;
            const maxLotsPossible = Math.floor(actualAvailableMargin / marginPerLot);
            const recommendedWithSafety = Math.floor(maxLotsPossible / 2); // 50% rule

            console.log('‚úÖ Calculation results:', {
                actualAvailableMargin,
                marginPerLot,
                maxLotsPossible,
                recommendedWithSafety,
                safeMargin
            });

            const calcMaxLots = document.getElementById('calcMaxLots');
            if (calcMaxLots) {
                console.log('‚úÖ Updating calcMaxLots element');
                calcMaxLots.innerHTML = `<strong>${maxLotsPossible}</strong> lots (@ ‚Çπ${marginPerLot.toLocaleString('en-IN', {maximumFractionDigits: 0})}/lot)`;
            } else {
                console.error('‚ùå calcMaxLots element not found!');
            }

            // Update reasoning with max profit
            const lotReasoning = document.getElementById('lotReasoning');
            if (lotReasoning && maxProfit) {
                const rom = ((maxProfit / (recommendedLots * marginPerLot)) * 100).toFixed(2);

                lotReasoning.innerHTML = `
                    The system recommends <strong>${recommendedLots} lots</strong> which uses only <strong>50% of your total margin</strong> (‚Çπ${safeMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}).
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.95;">
                        <strong>Calculation:</strong> Total Margin (‚Çπ${actualAvailableMargin.toLocaleString('en-IN', {maximumFractionDigits: 0})}) √∑ Margin per Lot (‚Çπ${marginPerLot.toLocaleString('en-IN', {maximumFractionDigits: 0})}) = ${maxLotsPossible} max lots<br>
                        Applying 50% safety factor: ${maxLotsPossible} √∑ 2 = <strong>${recommendedWithSafety} lots recommended</strong>
                    </div>
                    <div style="margin-top: 0.5rem; opacity: 0.9;">
                        This conservative approach maintains sufficient margin buffer for potential averaging down opportunities (up to 3 attempts using 20-50-50 protocol) and manages risk effectively.
                    </div>
                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2);">
                        <strong>üí∞ Maximum Profit Potential:</strong> ‚Çπ${maxProfit.toLocaleString('en-IN', {maximumFractionDigits: 0})}
                        <span style="opacity: 0.9;">(${rom}% Return on Margin)</span>
                    </div>
                `;
            }
        } else {
            // If position data is not available yet, just show that we have margin data
            console.warn('Position data not yet available, waiting for position sizing calculation');
        }
    }

    // Show margin error
    function showMarginError(errorMsg) {
        const errorText = `<span style="color: var(--danger);">‚ùå ${errorMsg}</span>`;

        ['availableMarginValue', 'usedMarginValue', 'totalMarginValue', 'collateralValue', 'marginUtilization'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = errorText;
            }
        });

        const lastUpdated = document.getElementById('marginLastUpdated');
        if (lastUpdated) {
            lastUpdated.innerHTML = errorText;
        }
    }

    // Refresh margins button handler
    async function refreshMargins() {
        // Show loading state
        ['availableMarginValue', 'usedMarginValue', 'totalMarginValue', 'collateralValue', 'marginUtilization', 'marginLastUpdated'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = '<span class="loading-spinner"></span> Loading...';
            }
        });

        // Fetch fresh data
        await fetchMarginData();
    }

    // Display NO TRADE DAY with validation report
    function displayNoTradeDay(data) {
        const validation = data.validation_report;
        const executionLog = data.execution_log || [];

        document.getElementById('resultTitle').textContent = '‚õî NO TRADE DAY';
        document.getElementById('resultBadge').textContent = 'BLOCKED';
        document.getElementById('resultBadge').className = 'result-badge fail';

        // Build execution log
        let logHTML = '';
        if (executionLog.length > 0) {
            logHTML = `
                <div class="result-section">
                    <h3>üìã Execution Log</h3>
                    <div style="background: var(--lighter); border-radius: var(--radius-md); padding: 1rem;">
                        ${executionLog.map((log, index) => {
                            const statusIcon = log.status === 'success' ? '‚úì' : (log.status === 'fail' ? '‚úó' : '‚ö†');
                            const statusColor = log.status === 'success' ? 'var(--success)' : (log.status === 'fail' ? 'var(--error)' : 'var(--warning)');
                            return `
                                <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-light);">
                                    <span style="flex-shrink: 0; background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${log.step}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--dark); margin-bottom: 0.25rem;">${log.action}</div>
                                        <div style="font-size: 0.875rem; color: var(--gray);">${log.message}</div>
                                    </div>
                                    <span style="flex-shrink: 0; color: ${statusColor}; font-size: 1.25rem;">${statusIcon}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // Build validation report (reuse same structure)
        const results = validation.validation_results || [];
        let verdictColor = '#EF4444'; // Red (fail)
        let verdictBg = '#FEE2E2';

        const html = `
            ${logHTML}

            <div class="result-section" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                <h3 style="color: white; margin-bottom: 1rem;">üõ°Ô∏è Market Condition Validation</h3>

                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; backdrop-filter: blur(10px);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Overall Verdict</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${validation.overall_verdict}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Status</div>
                            <div style="display: inline-block; background: ${verdictBg}; color: ${verdictColor}; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 600; font-size: 0.875rem;">
                                ‚úó BLOCKED
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 0.875rem; opacity: 0.95; line-height: 1.6;">
                        ${validation.verdict_reason}
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #D1FAE5;">${validation.status_summary.PASS || 0}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">PASSED</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #FEF3C7;">${validation.status_summary.WARNING || 0}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">WARNINGS</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #FEE2E2;">${validation.status_summary.FAIL || 0}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">FAILED</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #E5E7EB;">${validation.status_summary.SKIP || 0}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">SKIPPED</div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                    <h4 style="color: white; font-size: 0.9rem; margin-bottom: 0.75rem; opacity: 0.9;">Detailed Validation Checks</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${results.map((result, idx) => {
                            let statusIcon = '‚úì';
                            let statusColor = '#D1FAE5';
                            if (result.status === 'FAIL') {
                                statusIcon = '‚úó';
                                statusColor = '#FEE2E2';
                            } else if (result.status === 'WARNING') {
                                statusIcon = '‚ö†';
                                statusColor = '#FEF3C7';
                            } else if (result.status === 'SKIP') {
                                statusIcon = '‚óã';
                                statusColor = '#E5E7EB';
                            }

                            return `
                                <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: var(--radius-sm); border-left: 3px solid ${statusColor};">
                                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                                        <span style="font-size: 1.25rem; color: ${statusColor};">${statusIcon}</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; margin-bottom: 0.25rem; font-size: 0.875rem;">${result.check}</div>
                                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.5rem;">${result.message}</div>
                                            ${Object.keys(result.details).length > 0 ? `
                                                <div style="font-size: 0.7rem; opacity: 0.8; font-family: monospace; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: var(--radius-sm); max-height: 100px; overflow-y: auto;">
                                                    ${Object.entries(result.details).map(([key, value]) => {
                                                        if (typeof value === 'object') return '';
                                                        return `<div><strong>${key}:</strong> ${typeof value === 'number' ? value.toFixed(2) : value}</div>`;
                                                    }).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                        <span style="font-weight: 600; font-size: 0.75rem; color: ${statusColor};">${result.status}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>

            <div class="result-section" style="background: var(--lighter); padding: 1.5rem; border-radius: var(--radius-md);">
                <h3 style="color: var(--error); margin-bottom: 1rem;">‚ö†Ô∏è Trading Blocked</h3>
                <p style="color: var(--gray); line-height: 1.6; margin-bottom: 1rem;">
                    The system has detected unfavorable market conditions that do not meet the entry criteria for a Nifty Strangle position.
                    Trading has been automatically blocked to protect capital.
                </p>
                <p style="color: var(--gray); line-height: 1.6;">
                    <strong>Reason:</strong> ${data.error}
                </p>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="hideResults()">
                    ‚Üê Back
                </button>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    // 3. Verify Future Trade
    async function verifyFutureTrade(btn) {
        const contractValue = document.getElementById('contractSelect').value;
        if (!contractValue) {
            alert('Please select a futures contract');
            return;
        }

        // Parse contract value to get display name
        const selectedOption = document.getElementById('contractSelect').selectedOptions[0];
        const displayText = selectedOption.text;

        btn.disabled = true;
        document.getElementById('loadingVerify').classList.add('active');
        document.getElementById('verifyingStock').textContent = displayText;
        document.getElementById('resultsPanel').classList.remove('active');

        try {
            const formData = new FormData();
            formData.append('contract', contractValue);

            const response = await fetch('{% url "trading:verify_trade" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                displayVerificationResult(data);
            } else {
                // Show execution log even on error for debugging
                if (data.execution_log && data.execution_log.length > 0) {
                    displayVerificationResult({
                        ...data,
                        passed: false,
                        symbol: data.symbol || 'Unknown',
                        expiry: data.expiry || 'Unknown',
                        contract_display: data.contract_display || 'Unknown',
                        analysis: {
                            direction: 'NEUTRAL',
                            composite_score: 0,
                            contract_price: 0,
                            spot_price: 0,
                            position_details: {}
                        },
                        verdict: 'FAIL',
                        reason: data.error || 'Analysis failed - see steps for details'
                    });
                } else {
                    displayError(data.error);
                }
            }
        } catch (error) {
            displayError('Network error: ' + error.message);
        } finally {
            btn.disabled = false;
            document.getElementById('loadingVerify').classList.remove('active');
        }
    }

    // Indian number formatting (lakhs and crores)
    function formatIndianNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return '0';

        num = Math.round(num);
        const numStr = Math.abs(num).toString();
        const isNegative = num < 0;

        if (numStr.length <= 3) {
            return (isNegative ? '-' : '') + numStr;
        }

        // Indian numbering: first group of 3, then groups of 2
        const lastThree = numStr.substring(numStr.length - 3);
        const otherNumbers = numStr.substring(0, numStr.length - 3);

        const formatted = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ',') + ',' + lastThree;
        return (isNegative ? '-' : '') + formatted;
    }

    function displayVerificationResult(data) {
        const analysis = data.analysis;
        const llm = data.llm_validation;
        const posDetails = analysis.position_details || {};
        const executionLog = data.execution_log || [];
        const positionSizing = data.position_sizing;

        document.getElementById('resultTitle').textContent = `Verification: ${data.contract_display}`;
        document.getElementById('resultBadge').textContent = data.verdict;
        document.getElementById('resultBadge').className = 'result-badge ' + (data.passed ? 'pass' : 'fail');

        // Build execution log HTML (similar to strangle)
        let logHTML = '';
        if (executionLog.length > 0) {
            logHTML = `
                <div class="result-section">
                    <h3>üìã Step-by-Step Analysis</h3>
                    <div style="background: var(--lighter); border-radius: var(--radius-md); padding: 1rem;">
                        ${executionLog.map((log, index) => `
                            <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid var(--gray-light);">
                                <span style="flex-shrink: 0; background: ${log.status === 'PASS' ? 'var(--success)' : log.status === 'FAIL' ? 'var(--danger)' : 'var(--primary)'}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${log.step}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--dark); margin-bottom: 0.25rem;">${log.action}</div>
                                    <div style="font-size: 0.875rem; color: var(--gray);">${log.message}</div>
                                    ${log.details && Object.keys(log.details).length > 0 ? `
                                        <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: var(--radius-sm); font-family: monospace; max-height: 150px; overflow-y: auto;">
                                            ${Object.entries(log.details).map(([key, value]) => {
                                                if (typeof value === 'object') return '';
                                                return `<div><strong>${key}:</strong> ${value}</div>`;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <span style="flex-shrink: 0; color: ${log.status === 'PASS' ? 'var(--success)' : log.status === 'FAIL' ? 'var(--danger)' : 'var(--warning)'}; font-size: 1.25rem;">
                                    ${log.status === 'PASS' ? '‚úì' : log.status === 'FAIL' ? '‚úó' : '‚óè'}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Build Interactive Position Sizing Section for FUTURES
        let positionSizingCardHTML = '';
        if (positionSizing) {
            const position = positionSizing.position || {};
            const marginData = positionSizing.margin_data || {};

            const recommendedLots = position.recommended_lots || 1;
            const totalMarginRequired = position.total_margin_required || 0;
            const entryValue = position.entry_value || 0;
            const marginUtil = position.margin_utilization_percent || 0;
            const availableMargin = marginData.available_margin || 0;
            const usedMargin = marginData.used_margin || totalMarginRequired;
            const totalMargin = marginData.total_margin || availableMargin;
            const marginPerLot = marginData.margin_per_lot || 0;
            const maxLotsPossible = marginData.max_lots_possible || 0;

            const futuresPrice = analysis.contract_price || analysis.entry_price || 0;
            const lotSize = posDetails.lot_size || 0;
            const stopLoss = analysis.stop_loss || 0;
            const target = analysis.target || 0;
            const direction = analysis.direction || 'LONG';

            // Calculate risk/reward per lot
            const riskPerLot = Math.abs(futuresPrice - stopLoss) * lotSize;
            const rewardPerLot = Math.abs(target - futuresPrice) * lotSize;

            // Color code margin utilization
            let utilColor = '#D1FAE5';
            if (marginUtil > 60) utilColor = '#FEE2E2';
            else if (marginUtil > 40) utilColor = '#FEF3C7';

            // Store futures data in global variable for JS access
            window.futuresPositionData = {
                recommendedLots,
                marginPerLot,
                availableMargin,
                futuresPrice,
                lotSize,
                riskPerLot,
                rewardPerLot,
                stopLoss,
                target,
                direction
            };

            positionSizingCardHTML = `
                <div class="result-section" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 2rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                    <h3 style="color: white; margin-bottom: 1.5rem; font-size: 1.3rem;">
                        üìä Position Sizing & Risk Analysis
                    </h3>

                    <!-- Main Position Info with Interactive Slider -->
                    <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                        <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üéØ Initial Position (50% of Available Margin)</h4>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md);">
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Recommended Lots</div>
                                <div style="font-size: 1.5rem; font-weight: 700;" id="futuresRecommendedLots">${recommendedLots}</div>
                                <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.25rem;">${lotSize * recommendedLots} shares</div>
                                <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.15rem; word-break: break-all;" id="futuresTotalStockValue">‚Çπ${formatIndianNumber(lotSize * recommendedLots * futuresPrice)}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md);">
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Margin Required</div>
                                <div style="font-size: 1.2rem; font-weight: 700; word-break: break-all;" id="futuresMarginRequired">‚Çπ${formatIndianNumber(totalMarginRequired)}</div>
                                <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.25rem;"><span id="futuresMarginUtil">${marginUtil.toFixed(1)}</span>% used</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md);">
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Entry Value</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #FEF3C7; word-break: break-all;" id="futuresEntryValue">‚Çπ${formatIndianNumber(futuresPrice * lotSize * recommendedLots)}</div>
                                <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.25rem;">@ ‚Çπ${futuresPrice.toFixed(2)}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md);">
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Max Risk</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #FEE2E2; word-break: break-all;" id="futuresMaxRisk">‚Çπ${formatIndianNumber(riskPerLot * recommendedLots)}</div>
                                <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.25rem;">to SL @ ‚Çπ${stopLoss.toFixed(2)}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md);">
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Max Profit</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #D1FAE5; word-break: break-all;" id="futuresMaxProfit">‚Çπ${formatIndianNumber(rewardPerLot * recommendedLots)}</div>
                                <div style="font-size: 0.65rem; opacity: 0.8; margin-top: 0.25rem;">at Target @ ‚Çπ${target.toFixed(2)}</div>
                            </div>
                        </div>

                        <!-- Interactive Lot Adjustment Slider -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1.25rem; border-radius: var(--radius-md);">
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">
                                üéöÔ∏è Adjust Number of Lots
                            </label>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <button onclick="adjustFuturesLots(-1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: var(--radius-md); font-size: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚àí</button>
                                <input type="range" id="futuresLotsSlider" min="1" max="${maxLotsPossible || 20}" value="${recommendedLots}"
                                       oninput="updateFuturesCalculations(this.value)"
                                       style="flex: 1; height: 8px; border-radius: 4px; outline: none; -webkit-appearance: none; background: rgba(255,255,255,0.3);">
                                <button onclick="adjustFuturesLots(1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: var(--radius-md); font-size: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">+</button>
                                <input type="number" id="futuresLotsInput" value="${recommendedLots}" min="1" max="${maxLotsPossible || 20}"
                                       onchange="updateFuturesCalculations(this.value)"
                                       style="width: 80px; background: rgba(255,255,255,0.9); border: none; padding: 0.5rem; border-radius: var(--radius-md); font-size: 1.1rem; font-weight: 700; text-align: center; color: #1F2937;">
                            </div>
                            <div style="margin-top: 1rem; font-size: 0.75rem; opacity: 0.8; text-align: center;">
                                Max lots with 50% margin: ${maxLotsPossible} lots | Available Margin: ‚Çπ${(availableMargin / 100000).toFixed(1)}L
                            </div>
                        </div>

                        <!-- Margin Breakdown from Breeze API -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1.25rem; border-radius: var(--radius-md); margin-top: 1rem;">
                            <h4 style="color: white; font-size: 0.95rem; margin-bottom: 1rem; opacity: 0.9;">üí∞ Margin Breakdown (Breeze API)</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; font-size: 0.85rem;">
                                <div>
                                    <div style="opacity: 0.8; margin-bottom: 0.25rem;">Available Margin</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="futuresAvailableMargin">‚Çπ${formatIndianNumber(availableMargin)}</div>
                                </div>
                                <div>
                                    <div style="opacity: 0.8; margin-bottom: 0.25rem;">Used Margin</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="futuresUsedMargin">‚Çπ${formatIndianNumber(totalMarginRequired)}</div>
                                </div>
                                <div>
                                    <div style="opacity: 0.8; margin-bottom: 0.25rem;">Total Margin</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="futuresTotalMargin">‚Çπ${formatIndianNumber(totalMargin)}</div>
                                </div>
                                <div>
                                    <div style="opacity: 0.8; margin-bottom: 0.25rem;">Margin per Lot</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="futuresMarginPerLotDisplay">‚Çπ${formatIndianNumber(marginPerLot)}</div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; font-size: 0.75rem; opacity: 0.8; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: var(--radius-sm);">
                                <strong>üìê 50% Safety Rule:</strong> Initial position uses ‚Çπ${formatIndianNumber(availableMargin * 0.5)} (50% of available). Remaining 50% reserved for averaging (2 more positions).
                            </div>
                        </div>
                    </div>

                    <!-- Averaging Strategy -->
                    <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                        <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üîÑ Averaging Strategy (3 Levels)</h4>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                            <!-- Level 1: Initial Position -->
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                                <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                    üìç Level 1: Entry
                                </div>
                                <div style="font-size: 0.75rem; margin-bottom: 0.5rem; opacity: 0.8;">
                                    Price: ‚Çπ${futuresPrice.toFixed(2)}<br>
                                    Lots: <span id="avg1Lots">${recommendedLots}</span>
                                </div>
                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Margin:</span>
                                        <span style="font-weight: 700;" id="avg1Margin">‚Çπ${formatIndianNumber(marginPerLot * recommendedLots)}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Level 2: First Averaging -->
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                                <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                    üìç Level 2: -2% Averaging
                                </div>
                                <div style="font-size: 0.75rem; margin-bottom: 0.5rem; opacity: 0.8;">
                                    Price: ‚Çπ${(futuresPrice * 0.98).toFixed(2)}<br>
                                    Add Lots: <span id="avg2Lots">${Math.ceil(recommendedLots * 0.5)}</span>
                                </div>
                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                        <span>Add Margin:</span>
                                        <span style="font-weight: 700;" id="avg2Margin">‚Çπ${formatIndianNumber(marginPerLot * Math.ceil(recommendedLots * 0.5))}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Total Lots:</span>
                                        <span style="font-weight: 700; color: #D1FAE5;" id="avg2Total">${recommendedLots + Math.ceil(recommendedLots * 0.5)}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Level 3: Second Averaging -->
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                                <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                    üìç Level 3: -4% Averaging
                                </div>
                                <div style="font-size: 0.75rem; margin-bottom: 0.5rem; opacity: 0.8;">
                                    Price: ‚Çπ${(futuresPrice * 0.96).toFixed(2)}<br>
                                    Add Lots: <span id="avg3Lots">${Math.ceil(recommendedLots * 0.5)}</span>
                                </div>
                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                        <span>Add Margin:</span>
                                        <span style="font-weight: 700;" id="avg3Margin">‚Çπ${formatIndianNumber(marginPerLot * Math.ceil(recommendedLots * 0.5))}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Total Lots:</span>
                                        <span style="font-weight: 700; color: #D1FAE5;" id="avg3Total">${recommendedLots + Math.ceil(recommendedLots * 0.5) * 2}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: rgba(255,255,255,0.08); padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem; font-size: 0.85rem;">
                            <strong>üí° Strategy:</strong> Start with <span id="avgSummaryInitial">${recommendedLots}</span> lots. If price drops, add 50% more lots at -2% and -4% levels to average down your entry price while managing risk.
                        </div>
                    </div>

                    <!-- P&L Scenarios -->
                    <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md);">
                        <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üí∞ P&L Scenarios (Initial Position)</h4>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem;">
                            <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                                <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At Target (+${((target - futuresPrice) / futuresPrice * 100).toFixed(1)}%)</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D1FAE5;" id="pnlTarget">‚Çπ${formatIndianNumber(rewardPerLot * recommendedLots)}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                                <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At +2%</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D1FAE5;" id="pnlPlus2">‚Çπ${formatIndianNumber(futuresPrice * 0.02 * lotSize * recommendedLots)}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                                <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At +1%</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D1FAE5;" id="pnlPlus1">‚Çπ${formatIndianNumber(futuresPrice * 0.01 * lotSize * recommendedLots)}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                                <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At -1%</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #FEE2E2;" id="pnlMinus1">-‚Çπ${formatIndianNumber(futuresPrice * 0.01 * lotSize * recommendedLots)}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                                <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At -2%</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #FEE2E2;" id="pnlMinus2">-‚Çπ${formatIndianNumber(futuresPrice * 0.02 * lotSize * recommendedLots)}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: var(--radius-md); text-align: center;">
                                <div style="font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.25rem;">At Stop Loss (${((stopLoss - futuresPrice) / futuresPrice * 100).toFixed(1)}%)</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #FEE2E2;" id="pnlStopLoss">-‚Çπ${formatIndianNumber(riskPerLot * recommendedLots)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Take Trade Button HTML (always shown if position sizing exists)
        let takeTradeButtonHTML = '';
        if (positionSizing) {
            const recommendedLots = positionSizing.position?.recommended_lots || 1;
            const stockSymbol = data.stock_symbol || '';
            const futuresPrice = positionSizing.margin_data?.futures_price || 0;
            const direction = positionSizing.direction || 'buy';
            const suggestionId = data.suggestion_id || 0;

            // Store suggestion ID globally for easy access
            window.currentSuggestionId = suggestionId;

            takeTradeButtonHTML = `
                <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem; text-align: center;">
                    <button
                        onclick="console.log('Button clicked! SuggestionId:', ${suggestionId}); takeFuturesTradeFromServer(${suggestionId}, this);"
                        style="background: white; color: #2563eb; border: none; padding: 1rem 2rem; border-radius: var(--radius-md); font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); ${!suggestionId ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                        onmouseover="if(${suggestionId}) { this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'; }"
                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';"
                        id="takeFuturesTradeBtn"
                        ${!suggestionId ? 'disabled title="No suggestion saved - trade must PASS to save suggestion"' : ''}>
                        üöÄ Take This Trade ${suggestionId ? `(#${suggestionId})` : '(No Suggestion)'}
                    </button>
                    <div style="margin-top: 1rem; font-size: 0.85rem; opacity: 0.9;">
                        ${suggestionId ? `Place ${direction.toUpperCase()} order for ${stockSymbol} | <span id="displayLots">${recommendedLots}</span> lots @ ‚Çπ${futuresPrice.toFixed(2)}` : 'Trade must PASS verification to enable order placement'}
                    </div>
                </div>
            `;
        }

        const html = `
            ${logHTML}

            <div class="result-section">
                <h3>Verdict: ${data.passed ? '‚úÖ PASS' : '‚ùå FAIL'}</h3>
                <p>${data.reason}</p>
            </div>

            ${positionSizingCardHTML}
            ${takeTradeButtonHTML}

            <div class="result-section">
                <h3>Contract Details</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Symbol</div>
                        <div class="result-item-value">${data.symbol}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Expiry Date</div>
                        <div class="result-item-value">${data.expiry}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Futures Price</div>
                        <div class="result-item-value">‚Çπ${(analysis.contract_price || analysis.entry_price).toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Lot Size</div>
                        <div class="result-item-value">${analysis.lot_size || 'N/A'}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Trading Volume</div>
                        <div class="result-item-value">${analysis.traded_volume || 'N/A'} contracts</div>
                    </div>
                    ${analysis.basis ? `
                    <div class="result-item">
                        <div class="result-item-label">Basis</div>
                        <div class="result-item-value">‚Çπ${analysis.basis.toFixed(2)}</div>
                    </div>
                    ` : ''}
                </div>
            </div>

            <div class="result-section">
                <h3>Trade Analysis</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Direction</div>
                        <div class="result-item-value">${analysis.direction}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Entry Price</div>
                        <div class="result-item-value">‚Çπ${(analysis.contract_price || analysis.entry_price).toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Stop Loss</div>
                        <div class="result-item-value">‚Çπ${analysis.stop_loss.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Target</div>
                        <div class="result-item-value">‚Çπ${analysis.target.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Composite Score</div>
                        <div class="result-item-value">${analysis.composite_score}/100</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">LLM Confidence</div>
                        <div class="result-item-value">${llm.confidence}%</div>
                    </div>
                </div>
            </div>

            ${posDetails.lot_size ? `
            <div class="result-section">
                <h3>Position Details (Per Lot)</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Position Size</div>
                        <div class="result-item-value">${posDetails.lot_size} shares/lot</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Entry Value</div>
                        <div class="result-item-value">‚Çπ${posDetails.entry_value.toFixed(0)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Risk Amount</div>
                        <div class="result-item-value">‚Çπ${posDetails.risk_amount.toFixed(0)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Reward Amount</div>
                        <div class="result-item-value">‚Çπ${posDetails.reward_amount.toFixed(0)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Risk:Reward</div>
                        <div class="result-item-value">1:${posDetails.risk_reward_ratio}</div>
                    </div>
                </div>
            </div>
            ` : ''}

            <div class="result-section">
                <h3>Detailed Explanation</h3>
                <div class="explanation-box">
                    <h4>Why This Trade?</h4>
                    <p><strong>OI Analysis:</strong> ${analysis.oi_analysis || 'Buildup analysis complete'}</p>
                    <p><strong>Sector Analysis:</strong> ${analysis.sector_analysis || 'Sector alignment verified'}</p>
                    <p><strong>Technical Setup:</strong> ${analysis.technical_setup || 'Technical indicators analyzed'}</p>
                    <p><strong>LLM Confidence ${llm.confidence}%:</strong> ${llm.reasoning || 'AI validation complete'}</p>
                </div>
            </div>

            ${data.passed ? `
                <div class="action-buttons">
                    <div style="padding: 1rem; background: #FEF3C7; border-left: 4px solid #F59E0B; margin-bottom: 1rem;">
                        <strong>Note:</strong> To place an order, save this as a suggestion using the button above, then use the <strong>"Take This Trade"</strong> button.
                    </div>
                    <button class="btn btn-secondary" onclick="hideResults()">
                        Close
                    </button>
                </div>
            ` : `
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="hideResults()">
                        Close
                    </button>
                </div>
            `}
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });

        // Attach event listener to Take Trade button if it exists
        const takeTradeBtn = document.getElementById('takeFuturesTradeBtn');
        if (takeTradeBtn && data.suggestion_id) {
            console.log('‚úÖ Attaching event listener to Take Trade button, suggestion_id:', data.suggestion_id);
            // Remove any existing onclick to avoid double-firing
            takeTradeBtn.onclick = null;
            // Add clean event listener
            takeTradeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('üöÄ Take Trade button clicked via event listener! SuggestionId:', data.suggestion_id);
                takeFuturesTradeFromServer(data.suggestion_id, e.currentTarget);
            });
        } else {
            console.log('‚ö†Ô∏è Take Trade button setup failed. Button exists:', !!takeTradeBtn, 'SuggestionId:', data.suggestion_id);
        }
    }

    function displayError(message) {
        document.getElementById('resultTitle').textContent = 'Error';
        document.getElementById('resultBadge').textContent = 'ERROR';
        document.getElementById('resultBadge').className = 'result-badge fail';

        const html = `
            <div class="error-message">
                ${message}
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="hideResults()">Close</button>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    function hideResults() {
        document.getElementById('resultsPanel').classList.remove('active');
    }

    // Trade Suggestion Management Functions

    async function takeTradeSuggestion(suggestionId) {
        // Fetch suggestion details first to determine type
        console.log('[DEBUG] takeTradeSuggestion called with ID:', suggestionId);
        try {
            const fetchResponse = await fetch(`/trading/api/suggestions/${suggestionId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });

            console.log('[DEBUG] Fetch response status:', fetchResponse.status);
            const fetchResult = await fetchResponse.json();
            console.log('[DEBUG] Fetch result:', fetchResult);

            if (!fetchResult.success) {
                alert('‚ùå Failed to fetch suggestion details: ' + (fetchResult.error || 'Unknown error'));
                return;
            }

            const suggestion = fetchResult.suggestion;
            console.log('[DEBUG] Suggestion data:', suggestion);
            console.log('[DEBUG] suggestion_type:', suggestion.suggestion_type);
            console.log('[DEBUG] instrument:', suggestion.instrument);

            // Check if this is a Nifty Strangle suggestion
            if (suggestion.suggestion_type === 'OPTIONS' && suggestion.instrument === 'NIFTY') {
                console.log('[DEBUG] ‚úÖ Nifty Strangle detected - using simple confirmation dialog');

                // Extract data
                const callStrike = parseFloat(suggestion.call_strike);
                const putStrike = parseFloat(suggestion.put_strike);
                const callPremium = parseFloat(suggestion.call_premium);
                const putPremium = parseFloat(suggestion.put_premium);
                const totalPremium = parseFloat(suggestion.total_premium);
                const recommendedLots = parseInt(suggestion.recommended_lots);
                const marginPerLot = parseFloat(suggestion.margin_per_lot);
                const marginRequired = parseFloat(suggestion.margin_required);
                const marginAvailable = parseFloat(suggestion.margin_available);
                const spotPrice = parseFloat(suggestion.spot_price);
                const expiryDate = suggestion.expiry_date;
                const daysToExpiry = suggestion.days_to_expiry;
                const vix = parseFloat(suggestion.vix);

                // Format expiry date and build call symbol for lot size lookup
                const expiry = new Date(expiryDate);
                const day = expiry.getDate().toString().padStart(2, '0');
                const month = expiry.toLocaleDateString('en-US', {month: 'short'}).toUpperCase();
                const expiryStr = day + month;
                const callSymbol = `NIFTY${expiryStr}${callStrike}CE`;

                // Fetch lot size AND instrument tokens dynamically from Neo API
                console.log('[DEBUG] Fetching lot size and instrument tokens for', callSymbol);

                // Build PUT symbol early for API call
                const putSymbol = `NIFTY${expiryStr}${putStrike}PE`;

                // Fetch lot size for CALL (also gets instrument token)
                Promise.all([
                    fetch(`/trading/api/get-lot-size/?trading_symbol=${callSymbol}`).then(r => r.json()),
                    fetch(`/trading/api/get-lot-size/?trading_symbol=${putSymbol}`).then(r => r.json())
                ])
                    .then(([callData, putData]) => {
                        if (!callData.success || !putData.success) {
                            console.error('[ERROR] Failed to fetch contract data');
                            alert('Failed to fetch contract details. Using defaults.');
                            continueWithConfirmation(75, {}, {});
                            return;
                        }

                        const lotSize = callData.lot_size;
                        console.log('[DEBUG] ‚úÖ Lot size fetched:', lotSize);
                        console.log('[DEBUG] ‚úÖ CALL token:', callData.instrument_token);
                        console.log('[DEBUG] ‚úÖ PUT token:', putData.instrument_token);

                        continueWithConfirmation(lotSize, callData, putData);
                    })
                    .catch(error => {
                        console.error('[ERROR] Error fetching contract data:', error);
                        alert('Error fetching contract details. Using defaults.');
                        continueWithConfirmation(75, {}, {});
                    });

                // Function to continue with confirmation after contract data is fetched
                function continueWithConfirmation(lotSize, callContractData, putContractData) {
                    // Calculate order details
                    const totalQuantity = recommendedLots * lotSize;
                    const ordersPerLeg = Math.ceil(recommendedLots / 20);
                    const totalOrders = ordersPerLeg * 2;
                    const estimatedTime = (ordersPerLeg - 1) * 20;
                    const totalPremiumCollection = (callPremium + putPremium) * totalQuantity;

                    // Extract instrument tokens from contract data
                    const callToken = callContractData.instrument_token || 'N/A';
                    const putToken = putContractData.instrument_token || 'N/A';
                    const callExpiry = callContractData.expiry || expiryDate;
                    const putExpiry = putContractData.expiry || expiryDate;

                    // Create enhanced confirmation with checkboxes
                    const confirmationHTML = `
                        <div style="max-width: 700px; margin: 0 auto; padding: 20px; font-family: monospace;">
                            <h2 style="color: #EF4444; text-align: center; margin-bottom: 20px;">
                                ‚ö†Ô∏è CONFIRM STRANGLE TRADE ‚ö†Ô∏è
                            </h2>

                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div><strong>Suggestion ID:</strong> #${suggestionId}</div>
                                    <div><strong>Strategy:</strong> Nifty SHORT Strangle</div>
                                    <div><strong>Spot Price:</strong> ‚Çπ${spotPrice.toLocaleString('en-IN', {maximumFractionDigits: 2})}</div>
                                    <div><strong>Expiry:</strong> ${expiryDate} (${daysToExpiry} days)</div>
                                    <div><strong>VIX:</strong> ${vix.toFixed(2)}</div>
                                    <div><strong>Lots:</strong> ${recommendedLots}</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="background: #E0F2FE; border-left: 4px solid #0284C7; padding: 15px;">
                                    <h3 style="margin-top: 0; color: #0C4A6E;">üìã CALL CONTRACT</h3>
                                    <div style="font-size: 0.9em;">
                                        <div><strong>Strike:</strong> ${callStrike}</div>
                                        <div><strong>Premium:</strong> ‚Çπ${callPremium.toFixed(2)}</div>
                                        <div><strong>Symbol:</strong> ${callSymbol}</div>
                                        <div style="background: white; padding: 5px; margin-top: 5px; border-radius: 4px;">
                                            <strong>Token:</strong> <span style="color: #0284C7;">${callToken}</span>
                                        </div>
                                        <div><strong>Expiry:</strong> ${callExpiry}</div>
                                    </div>
                                </div>

                                <div style="background: #FEE2E2; border-left: 4px solid #DC2626; padding: 15px;">
                                    <h3 style="margin-top: 0; color: #991B1B;">üìã PUT CONTRACT</h3>
                                    <div style="font-size: 0.9em;">
                                        <div><strong>Strike:</strong> ${putStrike}</div>
                                        <div><strong>Premium:</strong> ‚Çπ${putPremium.toFixed(2)}</div>
                                        <div><strong>Symbol:</strong> ${putSymbol}</div>
                                        <div style="background: white; padding: 5px; margin-top: 5px; border-radius: 4px;">
                                            <strong>Token:</strong> <span style="color: #DC2626;">${putToken}</span>
                                        </div>
                                        <div><strong>Expiry:</strong> ${putExpiry}</div>
                                    </div>
                                </div>
                            </div>

                            <div style="background: #F0FDF4; border-left: 4px solid #16A34A; padding: 15px; margin-bottom: 20px;">
                                <h3 style="margin-top: 0; color: #14532D;">üí∞ TRADE ECONOMICS</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div><strong>Total Quantity:</strong> ${totalQuantity} (${recommendedLots} √ó ${lotSize})</div>
                                    <div><strong>Premium Collection:</strong> ‚Çπ${totalPremiumCollection.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                                    <div><strong>Margin Required:</strong> ‚Çπ${marginRequired.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                                    <div><strong>Margin Available:</strong> ‚Çπ${marginAvailable.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                                    <div><strong>Margin Utilization:</strong> ${((marginRequired / marginAvailable) * 100).toFixed(1)}%</div>
                                    <div><strong>Max Loss:</strong> Unlimited (Short Strangle)</div>
                                </div>
                            </div>

                            <div style="background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 15px; margin-bottom: 20px;">
                                <h3 style="margin-top: 0; color: #92400E;">‚è±Ô∏è EXECUTION DETAILS</h3>
                                <div>
                                    <div><strong>Total Orders:</strong> ${totalOrders} (${ordersPerLeg} CALL + ${ordersPerLeg} PUT)</div>
                                    <div><strong>Order Spacing:</strong> 20 seconds between orders</div>
                                    <div><strong>Estimated Time:</strong> ~${estimatedTime} seconds</div>
                                    <div><strong>Broker:</strong> Kotak Neo</div>
                                </div>
                            </div>

                            <div style="background: #FEE2E2; border-left: 4px solid #EF4444; padding: 15px; margin-bottom: 20px;">
                                <h3 style="margin-top: 0; color: #991B1B;">‚ö†Ô∏è RISK DISCLOSURE</h3>
                                <div style="margin-bottom: 15px;">
                                    <p style="margin: 5px 0;">Please confirm the following by checking each box:</p>
                                </div>
                                <div style="margin-left: 20px;">
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                            <input type="checkbox" id="strangle-verify-strikes" style="margin-right: 8px; margin-top: 2px;">
                                            <span>I verify the <strong>CALL strike (${callStrike})</strong> and <strong>PUT strike (${putStrike})</strong> are correct</span>
                                        </label>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                            <input type="checkbox" id="strangle-verify-tokens" style="margin-right: 8px; margin-top: 2px;">
                                            <span>I confirm the <strong>instrument tokens</strong> and <strong>expiry (${expiryDate})</strong> are as intended</span>
                                        </label>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                            <input type="checkbox" id="strangle-understand-strategy" style="margin-right: 8px; margin-top: 2px;">
                                            <span>I understand this is a <strong>SHORT STRANGLE</strong> with <strong>unlimited risk</strong> potential</span>
                                        </label>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                            <input type="checkbox" id="strangle-accept-risk" style="margin-right: 8px; margin-top: 2px;">
                                            <span>I understand this will place <strong>${totalOrders} REAL ORDERS</strong> with my broker and I accept the financial risk</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 20px;">
                                <button id="strangle-confirm-btn" disabled
                                        style="padding: 12px 30px; background: #ccc; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: not-allowed; margin-right: 10px;">
                                    Confirm Strangle Order
                                </button>
                                <button id="strangle-cancel-btn"
                                        style="padding: 12px 30px; background: #6B7280; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    `;

                    // Create modal for confirmation
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow: auto;';
                    modal.innerHTML = confirmationHTML;
                    document.body.appendChild(modal);

                    // Setup checkbox validation
                    const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
                    const confirmBtn = modal.querySelector('#strangle-confirm-btn');
                    const cancelBtn = modal.querySelector('#strangle-cancel-btn');

                    const validateCheckboxes = () => {
                        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                        if (allChecked) {
                            confirmBtn.disabled = false;
                            confirmBtn.style.background = '#10B981';
                            confirmBtn.style.cursor = 'pointer';
                        } else {
                            confirmBtn.disabled = true;
                            confirmBtn.style.background = '#ccc';
                            confirmBtn.style.cursor = 'not-allowed';
                        }
                    };

                    checkboxes.forEach(cb => cb.addEventListener('change', validateCheckboxes));

                    // Handle confirmation
                    confirmBtn.addEventListener('click', () => {
                        modal.remove();
                        console.log('[DEBUG] User confirmed with all checkboxes, executing strangle orders...');
                        executeStrangleOrdersDirect(suggestionId, recommendedLots);
                    });

                    // Handle cancellation
                    cancelBtn.addEventListener('click', () => {
                        modal.remove();
                        console.log('[DEBUG] User cancelled the strangle order');
                    });
                }

                return; // Don't proceed with the old confirm dialog
            } else {
                console.log('[DEBUG] ‚ùå Condition NOT matched. suggestion_type:', suggestion.suggestion_type, 'instrument:', suggestion.instrument);
            }

            // For non-strangle suggestions, use simple confirm dialog
            if (!confirm('Are you sure you want to TAKE this trade suggestion?')) {
                return;
            }

            const response = await fetch('/trading/api/suggestions/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: new URLSearchParams({
                    'suggestion_id': suggestionId,
                    'action': 'TAKE',
                    'user_notes': 'Trade taken from manual triggers page'
                })
            });

            const result = await response.json();

            if (result.success) {
                alert('‚úÖ Trade suggestion marked as TAKEN! Proceed with actual trade execution.');
                // Update the status badge in the UI
                updateSuggestionStatusBadge('TAKEN', 'purple');
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            console.error('Error taking trade suggestion:', error);
            alert('Network error: ' + error.message);
        }
    }

    async function executeStrangleOrdersDirect(suggestionId, totalLots) {
        console.log('[EXECUTE] Starting strangle order execution...');
        console.log('[EXECUTE] Suggestion ID:', suggestionId, 'Total Lots:', totalLots);

        try {
            // Call the execute endpoint
            const response = await fetch('/trading/trigger/execute-strangle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: new URLSearchParams({
                    'suggestion_id': suggestionId,
                    'total_lots': totalLots
                })
            });

            console.log('[EXECUTE] Response status:', response.status);
            const result = await response.json();
            console.log('[EXECUTE] Response data:', result);

            if (result.success) {
                const summary = result.batch_result.summary;
                alert(`‚úÖ STRANGLE ORDERS EXECUTED!

Total Orders Placed: ${summary.total_orders_placed}
Call Orders Success: ${summary.call_success_count}
Put Orders Success: ${summary.put_success_count}
Call Orders Failed: ${summary.call_failed_count}
Put Orders Failed: ${summary.put_failed_count}

Call Symbol: ${result.call_symbol}
Put Symbol: ${result.put_symbol}
Total Lots: ${result.total_lots}

${result.message || ''}`);
            } else {
                alert(`‚ùå STRANGLE ORDER FAILED:

${result.error || 'Unknown error'}

Please check the logs for details.`);
            }
        } catch (error) {
            console.error('[EXECUTE] Error:', error);
            alert(`‚ùå ERROR:

${error.message}

Please check your connection and try again.`);
        }
    }

    async function rejectTradeSuggestion(suggestionId) {
        const reason = prompt('Why are you rejecting this suggestion? (optional)');

        try {
            const response = await fetch('/trading/api/suggestions/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: new URLSearchParams({
                    'suggestion_id': suggestionId,
                    'action': 'REJECT',
                    'user_notes': reason || 'Rejected from manual triggers page'
                })
            });

            const result = await response.json();

            if (result.success) {
                alert('‚ùå Trade suggestion rejected.');
                updateSuggestionStatusBadge('REJECTED', 'gray');
                // Optionally hide the results panel
                setTimeout(() => hideResults(), 1500);
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            console.error('Error rejecting trade suggestion:', error);
            alert('Network error: ' + error.message);
        }
    }

    function updateSuggestionStatusBadge(status, color) {
        // Update the status display in the suggestion ID badge
        const statusElements = document.querySelectorAll('strong');
        for (let elem of statusElements) {
            if (elem.textContent === 'SUGGESTED') {
                elem.textContent = status;
                elem.style.color = getColorForStatus(color);
                break;
            }
        }
    }

    function getColorForStatus(colorName) {
        const colors = {
            'blue': '#3B82F6',
            'purple': '#8B5CF6',
            'orange': '#F59E0B',
            'gray': '#6B7280',
            'green': '#10B981',
            'red': '#EF4444',
            'yellow': '#FBBF24'
        };
        return colors[colorName] || colors.gray;
    }

    async function viewSuggestionHistory() {
        try {
            const response = await fetch('/trading/api/suggestions/?limit=20', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });

            const result = await response.json();

            if (result.success) {
                displaySuggestionHistory(result.suggestions);
            } else {
                alert('Error loading history: ' + result.error);
            }
        } catch (error) {
            console.error('Error fetching suggestion history:', error);
            alert('Network error: ' + error.message);
        }
    }

    function displaySuggestionHistory(suggestions) {
        if (!suggestions || suggestions.length === 0) {
            alert('No suggestion history found.');
            return;
        }

        let historyHTML = `
            <div style="max-height: 600px; overflow-y: auto;">
                <h2 style="margin-bottom: 1.5rem;">Trade Suggestion History</h2>
                <div style="display: grid; gap: 1rem;">
        `;

        for (const sugg of suggestions) {
            const statusColor = getColorForStatus(sugg.status_color);
            const isProfitable = sugg.realized_pnl && sugg.realized_pnl > 0;
            const pnlDisplay = sugg.realized_pnl ?
                `<div style="font-size: 0.9rem; color: ${isProfitable ? '#10B981' : '#EF4444'}; font-weight: 600;">
                    P&L: ‚Çπ${sugg.realized_pnl.toLocaleString('en-IN')} (${sugg.return_on_margin?.toFixed(2)}% ROM)
                </div>` : '';

            historyHTML += `
                <div style="border: 1px solid #E5E7EB; border-radius: var(--radius-md); padding: 1rem; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                        <div>
                            <span style="font-size: 0.75rem; color: #6B7280;">ID: #${sugg.id}</span>
                            <h4 style="margin: 0.25rem 0; font-size: 1.1rem;">${sugg.instrument} ${sugg.suggestion_type}</h4>
                            <span style="font-size: 0.85rem; color: #6B7280;">${sugg.strategy}</span>
                        </div>
                        <div style="text-align: right;">
                            <span style="display: inline-block; padding: 0.25rem 0.75rem; background: ${statusColor}; color: white; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600;">
                                ${sugg.status}
                            </span>
                            <div style="font-size: 0.7rem; color: #6B7280; margin-top: 0.25rem;">${sugg.created_at}</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; font-size: 0.85rem;">
                        ${sugg.call_strike && sugg.put_strike ? `
                            <div><strong>Strikes:</strong> C${sugg.call_strike} / P${sugg.put_strike}</div>
                            <div><strong>Premium:</strong> ‚Çπ${sugg.total_premium?.toLocaleString('en-IN')}</div>
                        ` : ''}
                        <div><strong>Lots:</strong> ${sugg.recommended_lots}</div>
                        <div><strong>Margin:</strong> ‚Çπ${sugg.margin_required?.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                        ${sugg.days_to_expiry ? `<div><strong>DTE:</strong> ${sugg.days_to_expiry} days</div>` : ''}
                    </div>

                    ${pnlDisplay}

                    ${sugg.user_notes ? `
                        <div style="margin-top: 0.75rem; padding: 0.5rem; background: #F9FAFB; border-radius: var(--radius-sm); font-size: 0.8rem; color: #6B7280;">
                            <strong>Notes:</strong> ${sugg.user_notes}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        historyHTML += `
                </div>
                <div style="margin-top: 1.5rem; text-align: center;">
                    <button class="btn btn-secondary" onclick="hideResults()">Close</button>
                </div>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = historyHTML;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    // Position sizing lot adjustment functions
    function adjustLots(delta) {
        const input = document.getElementById('lotsInput');
        if (!input) return;

        const currentValue = parseInt(input.value) || 1;
        const newValue = Math.max(1, Math.min(50, currentValue + delta));
        input.value = newValue;
        updatePositionCalculations();
    }

    function updatePositionCalculations() {
        const input = document.getElementById('lotsInput');
        if (!input) return;

        const lots = parseInt(input.value) || 1;

        // Get stored position sizing data from JSON script tags
        const psElement = document.getElementById('positionSizingData');
        const strangleElement = document.getElementById('strangleData');

        if (!psElement || !strangleElement) {
            console.error('Position sizing data not available');
            return;
        }

        const ps = JSON.parse(psElement.textContent);
        const strangle = JSON.parse(strangleElement.textContent);
        const LOT_SIZE = 50; // NIFTY lot size

        // Recalculate initial position metrics
        const quantity = lots * LOT_SIZE;
        const premiumPerLot = strangle.total_premium * LOT_SIZE;
        const premiumCollected = lots * premiumPerLot;

        // Margin per lot (30% of higher strike)
        const higherStrike = Math.max(strangle.call_strike, strangle.put_strike);
        const marginPerLot = higherStrike * LOT_SIZE * 0.30;
        const marginRequired = lots * marginPerLot;

        // Return on margin
        const rom = (premiumCollected / marginRequired) * 100;

        // Update displayed values
        document.getElementById('adjQuantity').textContent = quantity.toLocaleString();
        document.getElementById('adjMargin').textContent = '‚Çπ' + marginRequired.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        document.getElementById('adjPremium').textContent = '‚Çπ' + premiumCollected.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        document.getElementById('adjROM').textContent = rom.toFixed(2) + '%';

        // Recalculate P&L at key levels with new lot count
        // This is based on full averaging scenario, so multiply by ratio
        const originalLots = ps.initial_position.lots;
        const originalTotalLots = ps.averaging_scenarios.total_after_all_averaging.total_lots;
        const lotMultiplier = lots / originalLots;
        const newTotalLots = Math.round(originalTotalLots * lotMultiplier);

        // Update P&L values
        const pnl = ps.pnl_analysis;

        if (pnl.at_resistance_1 && document.getElementById('pnlR1')) {
            const newPnl = pnl.at_resistance_1.pnl * lotMultiplier;
            document.getElementById('pnlR1').textContent = '‚Çπ' + newPnl.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('pnlR1').style.color = newPnl >= 0 ? '#D1FAE5' : '#FEE2E2';
        }

        if (pnl.at_5_percent_rise && document.getElementById('pnlRise5')) {
            const newPnl = pnl.at_5_percent_rise.pnl * lotMultiplier;
            document.getElementById('pnlRise5').textContent = '‚Çπ' + newPnl.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('pnlRise5').style.color = newPnl >= 0 ? '#D1FAE5' : '#FEE2E2';
        }

        if (pnl.at_support_1 && document.getElementById('pnlS1')) {
            const newPnl = pnl.at_support_1.pnl * lotMultiplier;
            document.getElementById('pnlS1').textContent = '‚Çπ' + newPnl.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('pnlS1').style.color = newPnl >= 0 ? '#D1FAE5' : '#FEE2E2';
        }

        if (pnl.at_5_percent_drop && document.getElementById('pnlDrop5')) {
            const newPnl = pnl.at_5_percent_drop.pnl * lotMultiplier;
            document.getElementById('pnlDrop5').textContent = '‚Çπ' + newPnl.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('pnlDrop5').style.color = newPnl >= 0 ? '#D1FAE5' : '#FEE2E2';
        }

        // Store the adjusted lot count for order placement
        window.adjustedLots = lots;
    }

    // Futures-specific lot adjustment functions
    function adjustFuturesLots(delta) {
        const slider = document.getElementById('futuresLotsSlider');
        const input = document.getElementById('futuresLotsInput');
        if (!slider || !input) return;

        const currentValue = parseInt(input.value) || 1;
        const maxLots = parseInt(slider.max) || 20;
        const newValue = Math.max(1, Math.min(maxLots, currentValue + delta));

        slider.value = newValue;
        input.value = newValue;
        updateFuturesCalculations(newValue);
    }

    function updateFuturesCalculations(lots) {
        lots = parseInt(lots) || 1;

        // Sync slider and input
        const slider = document.getElementById('futuresLotsSlider');
        const input = document.getElementById('futuresLotsInput');
        if (slider) slider.value = lots;
        if (input) input.value = lots;

        // Get stored futures position data
        const data = window.futuresPositionData;
        if (!data) {
            console.error('Futures position data not available');
            return;
        }

        const { marginPerLot, availableMargin, futuresPrice, lotSize, riskPerLot, rewardPerLot } = data;

        // Recalculate position metrics
        const totalMarginRequired = marginPerLot * lots;
        const marginUtil = (totalMarginRequired / availableMargin) * 100;
        const entryValue = futuresPrice * lotSize * lots;
        const maxRisk = riskPerLot * lots;
        const maxProfit = rewardPerLot * lots;

        // Update main position display
        document.getElementById('futuresRecommendedLots').textContent = lots;
        document.getElementById('futuresRecommendedLots').nextElementSibling.textContent = `${lotSize * lots} shares`;
        document.getElementById('futuresTotalStockValue').textContent = `‚Çπ${formatIndianNumber(lotSize * lots * futuresPrice)}`;
        document.getElementById('futuresMarginRequired').textContent = `‚Çπ${formatIndianNumber(totalMarginRequired)}`;
        document.getElementById('futuresMarginUtil').textContent = marginUtil.toFixed(1);
        document.getElementById('futuresEntryValue').textContent = `‚Çπ${formatIndianNumber(entryValue)}`;
        document.getElementById('futuresMaxRisk').textContent = `‚Çπ${formatIndianNumber(maxRisk)}`;
        document.getElementById('futuresMaxProfit').textContent = `‚Çπ${formatIndianNumber(maxProfit)}`;

        // Update margin breakdown
        if (document.getElementById('futuresUsedMargin')) {
            document.getElementById('futuresUsedMargin').textContent = `‚Çπ${formatIndianNumber(totalMarginRequired)}`;
        }

        // Update averaging levels
        const avg2Lots = Math.ceil(lots * 0.5);
        const avg3Lots = Math.ceil(lots * 0.5);

        document.getElementById('avg1Lots').textContent = lots;
        document.getElementById('avg1Margin').textContent = `‚Çπ${formatIndianNumber(marginPerLot * lots)}`;

        document.getElementById('avg2Lots').textContent = avg2Lots;
        document.getElementById('avg2Margin').textContent = `‚Çπ${formatIndianNumber(marginPerLot * avg2Lots)}`;
        document.getElementById('avg2Total').textContent = lots + avg2Lots;

        document.getElementById('avg3Lots').textContent = avg3Lots;
        document.getElementById('avg3Margin').textContent = `‚Çπ${formatIndianNumber(marginPerLot * avg3Lots)}`;
        document.getElementById('avg3Total').textContent = lots + avg2Lots + avg3Lots;

        document.getElementById('avgSummaryInitial').textContent = lots;

        // Update P&L scenarios
        document.getElementById('pnlTarget').textContent = `‚Çπ${formatIndianNumber(rewardPerLot * lots)}`;
        document.getElementById('pnlPlus2').textContent = `‚Çπ${formatIndianNumber(futuresPrice * 0.02 * lotSize * lots)}`;
        document.getElementById('pnlPlus1').textContent = `‚Çπ${formatIndianNumber(futuresPrice * 0.01 * lotSize * lots)}`;
        document.getElementById('pnlMinus1').textContent = `-‚Çπ${formatIndianNumber(futuresPrice * 0.01 * lotSize * lots)}`;
        document.getElementById('pnlMinus2').textContent = `-‚Çπ${formatIndianNumber(futuresPrice * 0.02 * lotSize * lots)}`;
        document.getElementById('pnlStopLoss').textContent = `-‚Çπ${formatIndianNumber(riskPerLot * lots)}`;

        // Update Take Trade button display
        if (document.getElementById('displayLots')) {
            document.getElementById('displayLots').textContent = lots;
        }

        // Store adjusted lots for order placement
        window.adjustedFuturesLots = lots;
    }

    async function takeFuturesTradeFromServer(suggestionId, buttonElement) {
        console.log('takeFuturesTradeFromServer called with suggestionId:', suggestionId);
        console.log('Button element:', buttonElement);

        if (!suggestionId) {
            alert('‚ùå ERROR: No suggestion ID found. Please verify the trade again.');
            return;
        }

        // Disable button and show loading
        const btn = buttonElement;
        if (!btn) {
            console.error('Button not found!');
            alert('‚ùå ERROR: Button not found');
            return;
        }

        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Loading...';
        btn.style.opacity = '0.6';

        try {
            console.log('Fetching suggestion data from:', `/trading/api/suggestions/${suggestionId}/`);

            // Fetch suggestion data from server
            const fetchResponse = await fetch(`/trading/api/suggestions/${suggestionId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });

            console.log('Fetch response status:', fetchResponse.status);

            const fetchResult = await fetchResponse.json();
            console.log('Fetch result:', fetchResult);

            if (!fetchResult.success) {
                throw new Error(fetchResult.error || 'Failed to fetch suggestion data');
            }

            const suggestion = fetchResult.suggestion;
            console.log('Suggestion data:', suggestion);

            // Use adjusted lots from slider if available, otherwise use recommended
            const finalLots = window.adjustedFuturesLots || suggestion.recommended_lots;

            // Get current price from suggestion (this is the critical futures price)
            const futuresPrice = parseFloat(suggestion.futures_price) || parseFloat(suggestion.spot_price);
            const stopLoss = parseFloat(suggestion.stop_loss);
            const target = parseFloat(suggestion.target);
            const stockSymbol = suggestion.stock_symbol;
            const direction = suggestion.direction.toLowerCase();

            console.log('Trade details:', { stockSymbol, direction, finalLots, futuresPrice, stopLoss, target });

            // First fetch contract details including instrument token
            btn.innerHTML = '‚è≥ Fetching contract details...';

            // Get expiry from suggestion (it should be in YYYY-MM-DD format)
            const expiry = suggestion.expiry || suggestion.expiry_date;
            console.log('[DEBUG] Fetching contract details for:', stockSymbol, 'expiry:', expiry);

            let instrumentToken = 'N/A';
            let expiryFormatted = expiry;
            let companyName = '';
            let lotSize = suggestion.lot_size || 125;

            try {
                // Fetch contract details with instrument token from SecurityMaster
                const detailsResponse = await fetch(`/trading/api/get-contract-details/?symbol=${stockSymbol}&expiry=${expiry}`);
                const contractDetails = await detailsResponse.json();

                if (contractDetails.success) {
                    instrumentToken = contractDetails.instrument?.token || 'N/A';
                    expiryFormatted = contractDetails.expiry_formatted || expiry;
                    companyName = contractDetails.instrument?.company_name || '';
                    lotSize = contractDetails.instrument?.lot_size || lotSize;
                    console.log('[DEBUG] ‚úÖ Contract details fetched:', { instrumentToken, expiryFormatted, companyName, lotSize });
                } else {
                    console.log('[WARNING] Could not fetch contract details:', contractDetails.error);
                }
            } catch (error) {
                console.error('[ERROR] Failed to fetch contract details:', error);
            }

            // Create enhanced confirmation with checkboxes
            const confirmationHTML = `
                <div style="max-width: 600px; margin: 0 auto; padding: 20px; font-family: monospace;">
                    <h2 style="color: #EF4444; text-align: center; margin-bottom: 20px;">
                        ‚ö†Ô∏è CONFIRM FUTURES TRADE ‚ö†Ô∏è
                    </h2>

                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>Suggestion ID:</strong> #${suggestionId}</div>
                            <div><strong>Stock:</strong> ${stockSymbol}</div>
                            <div><strong>Direction:</strong> <span style="color: ${direction === 'long' ? '#10B981' : '#EF4444'}; font-weight: bold;">${direction.toUpperCase()}</span></div>
                            <div><strong>Expiry:</strong> ${expiryFormatted}</div>
                            <div><strong>Lots:</strong> ${finalLots}</div>
                            <div><strong>Lot Size:</strong> ${lotSize}</div>
                            <div><strong>Total Quantity:</strong> ${finalLots * lotSize}</div>
                            <div><strong>Entry Price:</strong> ‚Çπ${futuresPrice.toFixed(2)}</div>
                            <div><strong>Stop Loss:</strong> ‚Çπ${stopLoss.toFixed(2)}</div>
                            <div><strong>Target:</strong> ‚Çπ${target.toFixed(2)}</div>
                        </div>
                    </div>

                    <div style="background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 15px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: #92400E;">üìã CONTRACT VERIFICATION</h3>
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center;">
                            <strong>Instrument Token:</strong>
                            <span style="font-family: monospace; background: white; padding: 4px 8px; border-radius: 4px;">${instrumentToken}</span>
                            ${companyName ? `<strong>Company:</strong><span>${companyName}</span>` : ''}
                            <strong>Source:</strong>
                            <span>${instrumentToken !== 'N/A' ? 'Breeze SecurityMaster' : 'Not Available'}</span>
                        </div>
                    </div>

                    <div style="background: #DBEAFE; border-left: 4px solid #2563EB; padding: 15px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: #1E40AF;">üí∞ MARGIN REQUIREMENTS</h3>
                        <div>
                            <div><strong>Margin Required:</strong> ‚Çπ${formatIndianNumber(suggestion.margin_per_lot * finalLots)}</div>
                            <div><strong>Margin Available:</strong> ‚Çπ${formatIndianNumber(suggestion.margin_available)}</div>
                            <div><strong>Margin Utilization:</strong> ${((suggestion.margin_per_lot * finalLots / suggestion.margin_available) * 100).toFixed(1)}%</div>
                        </div>
                    </div>

                    <div style="background: #FEE2E2; border-left: 4px solid #EF4444; padding: 15px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: #991B1B;">‚ö†Ô∏è RISK DISCLOSURE</h3>
                        <div style="margin-bottom: 15px;">
                            <p style="margin: 5px 0;">Please confirm the following by checking each box:</p>
                        </div>
                        <div style="margin-left: 20px;">
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                    <input type="checkbox" id="futures-verify-symbol" style="margin-right: 8px; margin-top: 2px;">
                                    <span>I verify the <strong>symbol (${stockSymbol})</strong> and <strong>expiry (${expiryFormatted})</strong> are correct</span>
                                </label>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                    <input type="checkbox" id="futures-verify-direction" style="margin-right: 8px; margin-top: 2px;">
                                    <span>I confirm the <strong>direction (${direction.toUpperCase()})</strong> and <strong>lots (${finalLots})</strong> are as intended</span>
                                </label>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                    <input type="checkbox" id="futures-verify-levels" style="margin-right: 8px; margin-top: 2px;">
                                    <span>I have reviewed the <strong>entry (‚Çπ${futuresPrice.toFixed(2)})</strong>, <strong>SL (‚Çπ${stopLoss.toFixed(2)})</strong>, and <strong>target (‚Çπ${target.toFixed(2)})</strong></span>
                                </label>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                    <input type="checkbox" id="futures-understand-risk" style="margin-right: 8px; margin-top: 2px;">
                                    <span>I understand this will place a <strong>REAL ORDER</strong> with my broker and I accept the financial risk</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button id="futures-confirm-btn" disabled
                                style="padding: 12px 30px; background: #ccc; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: not-allowed; margin-right: 10px;">
                            Confirm Order
                        </button>
                        <button id="futures-cancel-btn"
                                style="padding: 12px 30px; background: #6B7280; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;

            // Create modal for confirmation
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow: auto;';
            modal.innerHTML = confirmationHTML;
            document.body.appendChild(modal);

            // Setup checkbox validation
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
            const confirmBtn = modal.querySelector('#futures-confirm-btn');
            const cancelBtn = modal.querySelector('#futures-cancel-btn');

            const validateCheckboxes = () => {
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                if (allChecked) {
                    confirmBtn.disabled = false;
                    confirmBtn.style.background = '#10B981';
                    confirmBtn.style.cursor = 'pointer';
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.style.background = '#ccc';
                    confirmBtn.style.cursor = 'not-allowed';
                }
            };

            checkboxes.forEach(cb => cb.addEventListener('change', validateCheckboxes));

            // Handle confirmation
            const handleConfirm = async () => {
                modal.remove();
                btn.innerHTML = '‚è≥ Placing Order...';
                console.log('User confirmed with all checkboxes, placing order...');
                return true;
            };

            // Handle cancellation
            const handleCancel = () => {
                modal.remove();
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.opacity = '1';
                console.log('User cancelled the order');
                return false;
            };

            // Wait for user response
            const userConfirmed = await new Promise((resolve) => {
                confirmBtn.addEventListener('click', () => resolve(handleConfirm()));
                cancelBtn.addEventListener('click', () => resolve(handleCancel()));
            });

            if (!userConfirmed) {
                return;
            }

            // Update button to show placing order
            btn.innerHTML = '‚è≥ Placing Order...';
            console.log('User confirmed, placing order...');

            // Prepare order data with expiry
            const orderData = {
                stock_symbol: stockSymbol,
                direction: direction,
                lots: finalLots,
                price: futuresPrice,
                stop_loss: stopLoss,
                target: target,
                expiry: expiry  // CRITICAL: Include expiry to ensure correct contract selection
            };
            console.log('Order data (with expiry):', orderData);

            // Place the order
            const response = await fetch('/trading/api/place-futures-order/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(orderData)
            });

            console.log('Order response status:', response.status);
            const result = await response.json();
            console.log('Order result:', result);

            if (result.success) {
                alert(`‚úÖ SUCCESS!

Order placed successfully!
Order ID: ${result.order_id}
Stock: ${stockSymbol}
Expiry: ${expiryFormatted}
Token: ${instrumentToken}
Direction: ${direction.toUpperCase()}
Lots: ${finalLots}
Price: ‚Çπ${futuresPrice.toFixed(2)}
Status: ${result.status}

${result.message || ''}`);

                // Change button to show success
                btn.innerHTML = '‚úÖ Trade Placed!';
                btn.style.background = '#10b981';
                btn.style.color = 'white';
            } else {
                alert(`‚ùå ERROR placing order:

${result.error}

Please check your Breeze connection and try again.`);

                // Reset button
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.opacity = '1';
            }
        } catch (error) {
            console.error('Error placing futures order:', error);
            alert(`‚ùå ERROR:

${error.message}

Please check your connection and try again.`);

            // Reset button
            btn.disabled = false;
            btn.innerHTML = originalText;
            btn.style.opacity = '1';
        }
    }

    function takeTrade(symbol, type) {
        // Prepare trade data for manual execution
        const tradeData = {
            algorithm_type: type === 'futures' ? 'futures' : 'strangle',
            instrument: symbol,
            direction: 'LONG',  // Will be determined by algorithm
            analysis_summary: `Manual trade trigger for ${symbol} via ${type} algorithm`
        };

        // Include adjusted lots if available (from position sizing)
        if (window.adjustedLots) {
            tradeData.lots = window.adjustedLots;
        }

        // Submit to preparation page for 4-checkbox confirmation
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "trading:prepare_manual_execution" %}';

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);

        const dataInput = document.createElement('input');
        dataInput.type = 'hidden';
        dataInput.name = 'trade_data';
        dataInput.value = JSON.stringify(tradeData);
        form.appendChild(dataInput);

        document.body.appendChild(form);
        form.submit();
    }

    function placeOrder(symbol, expiry, direction, entryPrice, stopLoss, target, lotSize) {
        // Calculate margin required (simplified)
        const positionValue = entryPrice * lotSize;
        const marginRequired = positionValue * 0.20; // Assume 20% margin

        // Prepare detailed trade data
        const tradeData = {
            algorithm_type: 'futures',
            instrument: symbol,
            direction: direction,
            entry_price: entryPrice,
            stop_loss: stopLoss,
            target: target,
            quantity: lotSize,
            expiry_date: expiry,
            margin_required: marginRequired,
            analysis_summary: `Manual futures trade: ${symbol} ${direction} @ ‚Çπ${entryPrice.toFixed(2)}`
        };

        // Submit to confirmation page with 4-checkbox safety protocol
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "trading:prepare_manual_execution" %}';

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);

        const dataInput = document.createElement('input');
        dataInput.type = 'hidden';
        dataInput.name = 'trade_data';
        dataInput.value = JSON.stringify(tradeData);
        form.appendChild(dataInput);

        document.body.appendChild(form);
        form.submit();
    }
</script>

<!-- Include Strangle Confirmation Modal -->
{% include 'trading/strangle_confirmation_modal.html' %}

{% endblock %}

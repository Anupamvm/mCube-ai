{% extends "core/master_base.html" %}
{% load static %}

{% block title %}View Active Trades - mCube Trading{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: var(--white);
        padding: 2rem 0;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-sm);
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0 0 0.5rem 0;
    }

    .page-subtitle {
        color: var(--gray);
        margin: 0;
    }

    .broker-section {
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
    }

    .table-container {
        overflow-x: auto;
        margin-top: 1rem;
    }

    .broker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--lighter);
    }

    .broker-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .broker-icon {
        font-size: 2rem;
    }

    .broker-actions {
        display: flex;
        gap: 0.75rem;
    }

    .refresh-btn {
        padding: 0.5rem 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .refresh-btn:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
    }

    .refresh-btn:disabled {
        background: var(--gray-light);
        cursor: not-allowed;
        transform: none;
    }

    .average-btn {
        padding: 0.5rem 1rem;
        background: #10b981;
        color: white;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .average-btn:hover {
        background: #059669;
        transform: translateY(-1px);
    }

    .average-btn:disabled {
        background: var(--gray-light);
        cursor: not-allowed;
        transform: none;
    }

    .positions-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .positions-table th {
        background: var(--lighter);
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        color: var(--dark);
        font-size: 0.875rem;
        border-bottom: 2px solid var(--gray-light);
    }

    .positions-table td {
        padding: 1rem 0.75rem;
        border-bottom: 1px solid var(--lighter);
        font-size: 0.875rem;
    }

    .positions-table tbody tr:hover {
        background: var(--lighter);
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-md);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-active {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-closed {
        background: #E5E7EB;
        color: #374151;
    }

    .direction-long {
        color: #10B981;
        font-weight: 600;
    }

    .direction-short {
        color: #EF4444;
        font-weight: 600;
    }

    .direction-neutral {
        color: #6366F1;
        font-weight: 600;
    }

    .pnl-positive {
        color: #10B981;
        font-weight: 600;
    }

    .pnl-negative {
        color: #EF4444;
        font-weight: 600;
    }

    .pnl-neutral {
        color: var(--gray);
        font-weight: 600;
    }

    .close-btn {
        padding: 0.5rem 1rem;
        background: #EF4444;
        color: white;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .close-btn:hover {
        background: #DC2626;
        transform: translateY(-1px);
    }

    .close-btn:disabled {
        background: var(--gray-light);
        cursor: not-allowed;
        transform: none;
    }

    .no-positions {
        text-align: center;
        padding: 3rem;
        color: var(--gray);
    }

    .no-positions-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem;
        color: var(--gray);
    }

    .loading-spinner::before {
        content: "";
        width: 40px;
        height: 40px;
        border: 4px solid var(--lighter);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 1rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Close Position Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: var(--radius-lg);
        padding: 2rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        margin-bottom: 1.5rem;
    }

    .modal-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0 0 0.5rem 0;
    }

    .modal-header p {
        color: var(--gray);
        margin: 0;
        font-size: 0.875rem;
    }

    .modal-body {
        margin-bottom: 1.5rem;
    }

    .modal-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .modal-info-item {
        background: var(--lighter);
        padding: 1rem;
        border-radius: var(--radius-md);
    }

    .modal-info-label {
        font-size: 0.75rem;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .modal-info-value {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--dark);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-secondary {
        background: #EF4444;
        color: white;
        border: 1px solid #DC2626;
    }

    .btn-secondary:hover {
        background: #DC2626;
        border-color: #B91C1C;
    }

    .btn-secondary:disabled {
        background: #F87171;
        color: white;
        border-color: #EF4444;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .btn-danger {
        background: #EF4444;
        color: white;
    }

    .btn-danger:hover {
        background: #DC2626;
        transform: translateY(-1px);
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .progress-message {
        background: #DBEAFE;
        color: #1E40AF;
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-top: 1rem;
        font-size: 0.875rem;
        text-align: center;
    }

    .error-message {
        background: #FEE2E2;
        color: #991B1B;
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-top: 1rem;
        font-size: 0.875rem;
    }

    .success-message {
        background: #D1FAE5;
        color: #065F46;
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-top: 1rem;
        font-size: 0.875rem;
    }

    .warning-message {
        background: #FEF3C7;
        color: #92400E;
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-top: 1rem;
        font-size: 0.875rem;
    }

    /* Average Position Modal Styles */
    .average-modal-content {
        background: white;
        border-radius: var(--radius-lg);
        padding: 0;
        max-width: 900px;
        width: 95%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .average-modal-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .average-modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .average-modal-close {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .average-modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .average-modal-body {
        padding: 2rem;
    }

    .score-card {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #3b82f6;
    }

    .score-header {
        color: #1f2937;
        margin-bottom: 15px;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .score-total {
        background: white;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        text-align: center;
    }

    .score-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 5px 0;
    }

    .score-components {
        background: white;
        padding: 15px;
        border-radius: 6px;
    }

    .score-bar-container {
        margin-bottom: 12px;
    }

    .score-bar-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
        font-size: 0.8rem;
    }

    .score-bar-track {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .score-bar-fill {
        height: 100%;
        transition: width 0.3s;
    }

    .score-description {
        font-size: 0.7rem;
        color: #9ca3af;
        margin-top: 2px;
    }

    .position-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .position-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .position-label {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 5px;
    }

    .position-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
    }

    .position-subvalue {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 3px;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">Active Trades</h1>
        <p class="page-subtitle">Monitor and manage your active positions across all broker accounts</p>
    </div>
</div>

<div class="container">
    <!-- Breeze Positions -->
    <div class="broker-section" id="breezeSection">
        <div class="broker-header">
            <h2 class="broker-title">
                <span class="broker-icon">üåä</span>
                ICICI Breeze Positions
            </h2>
            <div class="broker-actions">
                <button class="average-btn" onclick="showAverageModal('breeze')" id="averageBreezeBtn">
                    üìà Average Position
                </button>
                <button class="refresh-btn" onclick="refreshPositions('breeze')" id="refreshBreezeBtn">
                    üîÑ Refresh
                </button>
            </div>
        </div>
        <div id="breezePositions">
            <div class="loading-spinner">Loading Breeze positions...</div>
        </div>
    </div>

    <!-- Neo Positions -->
    <div class="broker-section" id="neoSection">
        <div class="broker-header">
            <h2 class="broker-title">
                <span class="broker-icon">üöÄ</span>
                Kotak Neo Positions
            </h2>
            <div class="broker-actions">
                <button class="average-btn" onclick="showAverageModal('neo')" id="averageNeoBtn">
                    üìà Average Position
                </button>
                <button class="refresh-btn" onclick="refreshPositions('neo')" id="refreshNeoBtn">
                    üîÑ Refresh
                </button>
            </div>
        </div>
        <div id="neoPositions">
            <div class="loading-spinner">Loading Neo positions...</div>
        </div>
    </div>
</div>

<!-- Close Position Modal -->
<div class="modal-overlay" id="closePositionModal" onclick="handleOverlayClick(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>‚ö†Ô∏è Close Position</h2>
            <p>Are you sure you want to close this position? This action cannot be undone.</p>
        </div>
        <div class="modal-body">
            <!-- Confirmation Section -->
            <div id="modalConfirmSection">
                <div class="modal-info-grid" id="modalPositionInfo"></div>
                <div id="modalMessages"></div>
            </div>

            <!-- Progress Section (hidden initially) -->
            <div id="modalProgressSection" style="display: none;">
                <h3 style="font-size: 1.125rem; margin-bottom: 1rem;">
                    <span id="progress-spinner">üîÑ</span> Closing Position...
                </h3>

                <!-- Overall Progress Bar -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem;">
                        <strong>Overall Progress</strong>
                        <span id="overall-progress-text">0/0 batches</span>
                    </div>
                    <div style="background: #E5E7EB; border-radius: 8px; height: 30px; overflow: hidden;">
                        <div id="overall-progress-bar"
                             style="width: 0%; height: 100%; background: linear-gradient(90deg, #10B981, #059669); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem; transition: width 0.3s ease;">
                            <span id="overall-progress-percent">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Current Batch Info -->
                <div style="background: #EFF6FF; border: 1px solid #BFDBFE; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem;">
                        <div>
                            <strong>Current Batch:</strong> <span id="current-batch-number">-</span>
                        </div>
                        <div>
                            <strong>Lots:</strong> <span id="current-batch-lots">-</span>
                        </div>
                        <div>
                            <strong>Qty:</strong> <span id="current-batch-qty">-</span>
                        </div>
                    </div>
                </div>

                <!-- Status Log -->
                <div id="batch-status-log"
                     style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.75rem; background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; padding: 0.75rem;">
                    <div style="color: #6B7280; font-style: italic;">Waiting for execution to start...</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()" id="modalCancelBtn">Cancel</button>
            <button class="btn btn-danger" onclick="confirmClosePosition()" id="modalConfirmBtn">
                Close Position
            </button>
        </div>
    </div>
</div>

<!-- Average Position Modal -->
<div class="modal-overlay" id="averagePositionModal" onclick="handleAverageOverlayClick(event)">
    <div class="average-modal-content" onclick="event.stopPropagation()">
        <div class="average-modal-header">
            <h2>üìà Average Position Recommendation</h2>
            <button class="average-modal-close" onclick="closeAverageModal()">‚úï</button>
        </div>
        <div class="average-modal-body" id="averageModalBody">
            <div class="loading-spinner">Loading recommendations...</div>
        </div>
    </div>
</div>

<script>
let currentPosition = null;
let isOrderProcessing = false;
let closeExecutionState = {
    isRunning: false,
    pollInterval: null,
    sessionId: null,
    broker: null,
    symbol: null
};

// Load positions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPositions('breeze');
    loadPositions('neo');

    // Add ESC key handler to close modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !isOrderProcessing) {
            const modal = document.getElementById('closePositionModal');
            if (modal.classList.contains('active')) {
                closeModal();
            }
        }
    });
});

// Load positions for a broker
async function loadPositions(broker) {
    const container = document.getElementById(`${broker}Positions`);
    container.innerHTML = '<div class="loading-spinner">Loading positions...</div>';

    try {
        const response = await fetch(`/trading/api/get-positions/?broker=${broker}`);
        const data = await response.json();

        if (data.success) {
            displayPositions(broker, data.positions);
        } else {
            container.innerHTML = `<div class="error-message">Error: ${data.error}</div>`;
        }
    } catch (error) {
        console.error(`Error loading ${broker} positions:`, error);
        container.innerHTML = `<div class="error-message">Failed to load positions. Please try again.</div>`;
    }
}

// Refresh positions
function refreshPositions(broker) {
    const btn = document.getElementById(`refresh${broker.charAt(0).toUpperCase() + broker.slice(1)}Btn`);
    btn.disabled = true;
    btn.textContent = '‚è≥ Loading...';

    loadPositions(broker).finally(() => {
        btn.disabled = false;
        btn.textContent = 'üîÑ Refresh';
    });
}

// Display positions in table
function displayPositions(broker, positions) {
    const container = document.getElementById(`${broker}Positions`);

    if (!positions || positions.length === 0) {
        container.innerHTML = `
            <div class="no-positions">
                <div class="no-positions-icon">üì≠</div>
                <p>No active positions found</p>
            </div>
        `;
        return;
    }

    const tableHTML = `
        <div class="table-container">
        <table class="positions-table">
            <thead>
                <tr>
                    <th>Action</th>
                    <th>Symbol</th>
                    <th>Direction</th>
                    <th>Qty</th>
                    <th>Avg Price</th>
                    <th>LTP</th>
                    <th>Unrealized P&L</th>
                    <th>Realized P&L</th>
                    <th>Total P&L</th>
                    <th>P&L %</th>
                </tr>
            </thead>
            <tbody>
                ${positions.map(pos => `
                    <tr>
                        <td>
                            <button class="close-btn" onclick="showCloseModal('${broker}', '${pos.symbol}', ${JSON.stringify(pos).replace(/"/g, '&quot;')})">Close</button>
                        </td>
                        <td><strong>${pos.symbol}</strong><br><small style="color: var(--gray);">${pos.product}</small></td>
                        <td><span class="direction-${pos.direction.toLowerCase()}">${pos.direction}</span></td>
                        <td>${pos.quantity}</td>
                        <td>‚Çπ${parseFloat(pos.average_price).toFixed(2)}</td>
                        <td>${pos.ltp ? '‚Çπ' + parseFloat(pos.ltp).toFixed(2) : '<span style="color: var(--gray);">N/A</span>'}</td>
                        <td class="${getPnLClass(pos.unrealized_pnl)}">
                            ‚Çπ${parseFloat(pos.unrealized_pnl).toFixed(2)}
                        </td>
                        <td class="${getPnLClass(pos.realized_pnl)}">
                            ‚Çπ${parseFloat(pos.realized_pnl).toFixed(2)}
                        </td>
                        <td class="${getPnLClass(pos.total_pnl)}">
                            <strong>‚Çπ${parseFloat(pos.total_pnl).toFixed(2)}</strong>
                        </td>
                        <td class="${getPnLClass(pos.unrealized_pnl)}">
                            ${parseFloat(pos.pnl_percentage).toFixed(2)}%
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        </div>
    `;

    container.innerHTML = tableHTML;
}

// Get P&L CSS class
function getPnLClass(pnl) {
    const value = parseFloat(pnl);
    if (value > 0) return 'pnl-positive';
    if (value < 0) return 'pnl-negative';
    return 'pnl-neutral';
}

// Show close position modal
function showCloseModal(broker, symbol, posData) {
    currentPosition = { broker, symbol, posData };

    const modal = document.getElementById('closePositionModal');
    const modalInfo = document.getElementById('modalPositionInfo');
    const modalMessages = document.getElementById('modalMessages');

    modalMessages.innerHTML = '';

    const pos = posData;
    modalInfo.innerHTML = `
        <div class="modal-info-item">
            <div class="modal-info-label">Symbol</div>
            <div class="modal-info-value">${pos.symbol}</div>
        </div>
        <div class="modal-info-item">
            <div class="modal-info-label">Product</div>
            <div class="modal-info-value">${pos.product}</div>
        </div>
        <div class="modal-info-item">
            <div class="modal-info-label">Direction</div>
            <div class="modal-info-value">${pos.direction}</div>
        </div>
        <div class="modal-info-item">
            <div class="modal-info-label">Quantity</div>
            <div class="modal-info-value">${pos.quantity}</div>
        </div>
        <div class="modal-info-item">
            <div class="modal-info-label">Avg Price</div>
            <div class="modal-info-value">‚Çπ${parseFloat(pos.average_price).toFixed(2)}</div>
        </div>
        <div class="modal-info-item">
            <div class="modal-info-label">LTP</div>
            <div class="modal-info-value">${pos.ltp ? '‚Çπ' + parseFloat(pos.ltp).toFixed(2) : 'N/A'}</div>
        </div>
        <div class="modal-info-item">
            <div class="modal-info-label">Unrealized P&L</div>
            <div class="modal-info-value ${getPnLClass(pos.unrealized_pnl)}">
                ‚Çπ${parseFloat(pos.unrealized_pnl).toFixed(2)} (${parseFloat(pos.pnl_percentage).toFixed(2)}%)
            </div>
        </div>
        <div class="modal-info-item">
            <div class="modal-info-label">Total P&L</div>
            <div class="modal-info-value ${getPnLClass(pos.total_pnl)}">
                <strong>‚Çπ${parseFloat(pos.total_pnl).toFixed(2)}</strong>
            </div>
        </div>
    `;
    modal.classList.add('active');
}

// Handle overlay click (close modal when clicking outside)
function handleOverlayClick(event) {
    // Only close if clicked on overlay itself, not when order is processing
    if (event.target.id === 'closePositionModal' && !isOrderProcessing) {
        closeModal();
    }
}

// Close modal
function closeModal() {
    // Don't allow closing while order is processing (unless explicitly stopped)
    if (isOrderProcessing) {
        console.log('Cannot close modal while processing orders. Use Stop button instead.');
        return;
    }

    const modal = document.getElementById('closePositionModal');
    const modalMessages = document.getElementById('modalMessages');
    const confirmBtn = document.getElementById('modalConfirmBtn');
    const cancelBtn = document.getElementById('modalCancelBtn');

    // Reset modal state
    modal.classList.remove('active');
    modalMessages.innerHTML = '';

    // Reset buttons to default state
    confirmBtn.textContent = 'Close Position';
    confirmBtn.disabled = false;
    confirmBtn.onclick = confirmClosePosition;

    cancelBtn.textContent = 'Cancel';
    cancelBtn.disabled = false;
    cancelBtn.onclick = closeModal;

    currentPosition = null;
    isOrderProcessing = false;

    // Stop progress polling if running
    if (closeExecutionState.pollInterval) {
        clearInterval(closeExecutionState.pollInterval);
        closeExecutionState.pollInterval = null;
    }
    closeExecutionState.isRunning = false;
}

// Progress tracking functions
function showProgressSection() {
    document.getElementById('modalConfirmSection').style.display = 'none';
    document.getElementById('modalProgressSection').style.display = 'block';
}

function hideProgressSection() {
    document.getElementById('modalConfirmSection').style.display = 'block';
    document.getElementById('modalProgressSection').style.display = 'none';
}

function addLogEntry(message, type = 'info') {
    const log = document.getElementById('batch-status-log');
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
        'info': '#3B82F6',
        'success': '#10B981',
        'warning': '#F59E0B',
        'error': '#EF4444'
    };

    const color = colors[type] || colors['info'];
    const entry = document.createElement('div');
    entry.style.color = color;
    entry.style.marginBottom = '4px';
    entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

function updateProgressUI(progress) {
    const { batches_completed, total_batches, current_batch, is_cancelled, is_complete, is_success } = progress;

    // Update overall progress
    const overallPercent = total_batches > 0 ? (batches_completed / total_batches) * 100 : 0;
    document.getElementById('overall-progress-bar').style.width = overallPercent + '%';
    document.getElementById('overall-progress-percent').textContent = Math.round(overallPercent) + '%';
    document.getElementById('overall-progress-text').textContent = `${batches_completed}/${total_batches} batches`;

    // Update current batch info
    if (current_batch) {
        document.getElementById('current-batch-number').textContent = `${current_batch.batch_num}/${total_batches}`;
        document.getElementById('current-batch-lots').textContent = current_batch.lots || '-';
        document.getElementById('current-batch-qty').textContent = current_batch.quantity || '-';
    }

    // Check if cancelled or complete
    if (is_cancelled || is_complete) {
        closeExecutionState.isRunning = false;
        if (closeExecutionState.pollInterval) {
            clearInterval(closeExecutionState.pollInterval);
            closeExecutionState.pollInterval = null;
        }

        if (is_cancelled) {
            addLogEntry('üõë Execution interrupted by user', 'warning');
        }

        // Reset processing flag
        isOrderProcessing = false;

        // If cancelled, immediately close modal and refresh
        if (is_cancelled) {
            const broker = currentPosition.broker;
            closeModal();
            loadPositions(broker);

            // Reset confirm button display
            const confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.style.display = '';
        } else {
            // If completed (not cancelled), show close button and auto-close after 2 seconds
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.getElementById('modalCancelBtn');

            confirmBtn.style.display = 'none';
            cancelBtn.textContent = 'Close';
            cancelBtn.disabled = false;
            cancelBtn.onclick = closeModal;
            cancelBtn.style.background = '';
            cancelBtn.style.cursor = '';

            // Auto-close after 2 seconds
            setTimeout(() => {
                if (currentPosition) {
                    const broker = currentPosition.broker;
                    closeModal();
                    loadPositions(broker);
                    confirmBtn.style.display = '';
                }
            }, 2000);
        }
    }
}

function startProgressPolling() {
    if (closeExecutionState.pollInterval) {
        clearInterval(closeExecutionState.pollInterval);
    }

    closeExecutionState.pollInterval = setInterval(() => {
        if (!closeExecutionState.isRunning) {
            clearInterval(closeExecutionState.pollInterval);
            return;
        }

        const broker = closeExecutionState.broker;
        const symbol = closeExecutionState.symbol;

        fetch(`/trading/api/close-position-progress/${broker}/${encodeURIComponent(symbol)}/`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateProgressUI(data.progress);

                    // Add log entries for new batches
                    if (data.progress.last_log_message) {
                        addLogEntry(data.progress.last_log_message, data.progress.last_log_type || 'info');
                    }

                    // Check if execution is complete
                    if (data.progress.is_complete) {
                        closeExecutionState.isRunning = false;
                        clearInterval(closeExecutionState.pollInterval);

                        if (data.progress.is_success) {
                            addLogEntry('‚úÖ Position closed successfully', 'success');
                        } else {
                            addLogEntry('‚ùå Position closing failed', 'error');
                        }
                    }
                }
            })
            .catch(err => {
                console.error('Error polling progress:', err);
            });
    }, 1500); // Poll every 1.5 seconds
}

async function stopOrderPlacement() {
    if (!currentPosition) {
        console.error('No position available');
        return;
    }

    // Show confirmation dialog
    if (!confirm('‚ö†Ô∏è Are you sure you want to interrupt order execution?\n\nThis will stop placing any remaining batches.')) {
        return;
    }

    const cancelBtn = document.getElementById('modalCancelBtn');
    const pos = currentPosition.posData;
    const broker = currentPosition.broker;

    addLogEntry('üõë Sending interrupt signal...', 'warning');

    try {
        // Call the cancel API to set the cancellation flag
        const response = await fetch('/trading/api/cancel-order-placement/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                broker: broker,
                symbol: pos.symbol
            })
        });

        const data = await response.json();
        if (data.success) {
            console.log('Cancellation requested successfully');
            addLogEntry('‚úÖ Interrupt signal sent successfully', 'success');
            addLogEntry('‚è≥ Waiting for current batch to complete...', 'info');

            // Disable and update the Stop button
            cancelBtn.disabled = true;
            cancelBtn.textContent = '‚úì Interrupted';
            cancelBtn.style.background = '#6B7280';
            cancelBtn.style.cursor = 'not-allowed';
        } else {
            console.error('Failed to request cancellation:', data.error);
            addLogEntry('‚ùå Failed to interrupt: ' + data.error, 'error');
            alert('Failed to interrupt execution: ' + data.error);
        }
    } catch (error) {
        console.error('Error requesting cancellation:', error);
        addLogEntry('‚ùå Network error during interrupt', 'error');
        alert('Network error while trying to interrupt');
    }
}

// Confirm close position
async function confirmClosePosition() {
    if (!currentPosition) return;

    const confirmBtn = document.getElementById('modalConfirmBtn');
    const cancelBtn = document.getElementById('modalCancelBtn');
    const modalMessages = document.getElementById('modalMessages');

    // Set processing flag to prevent accidental closing
    isOrderProcessing = true;

    confirmBtn.disabled = true;
    confirmBtn.textContent = '‚è≥ Closing...';

    // Change Cancel button to Stop button (enabled immediately with red background)
    cancelBtn.textContent = 'üõë Stop';
    cancelBtn.disabled = false;
    cancelBtn.onclick = stopOrderPlacement;
    cancelBtn.style.background = '#EF4444';
    cancelBtn.style.color = 'white';

    const pos = currentPosition.posData;
    const broker = currentPosition.broker;

    // Switch to progress view
    showProgressSection();
    addLogEntry('üöÄ Starting position closure...', 'info');
    addLogEntry(`Closing ${pos.symbol} on ${broker === 'breeze' ? 'ICICI Breeze' : 'Kotak Neo'}`, 'info');

    // Start progress polling
    closeExecutionState.isRunning = true;
    closeExecutionState.broker = broker;
    closeExecutionState.symbol = pos.symbol;
    startProgressPolling();

    try {
        // Call the close_live_position API (this starts async execution)
        const response = await fetch('/trading/api/close-live-position/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                broker: broker,
                symbol: pos.symbol,
                quantity: pos.net_quantity_shares,  // Use shares for closing
                exchange: pos.exchange,
                product: pos.product,
                direction: pos.direction
            })
        });

        const data = await response.json();

        // Stop polling
        closeExecutionState.isRunning = false;
        if (closeExecutionState.pollInterval) {
            clearInterval(closeExecutionState.pollInterval);
        }

        if (data.success) {
            // Success - final status will come from progress polling
            const wasCancelled = data.cancelled || false;
            if (wasCancelled) {
                addLogEntry(`‚ö†Ô∏è ${data.message || 'Position partially closed'}`, 'warning');
            } else {
                addLogEntry(`‚úÖ ${data.message || 'Position closed successfully'}`, 'success');
            }

            // Reset processing flag to allow closing
            isOrderProcessing = false;

            // Change buttons
            cancelBtn.textContent = 'Close';
            cancelBtn.disabled = false;
            cancelBtn.onclick = closeModal;
            confirmBtn.style.display = 'none';

            // Refresh positions after 3 seconds
            setTimeout(() => {
                closeModal();
                loadPositions(broker);
                confirmBtn.style.display = '';
            }, 3000);

        } else {
            // Failed
            addLogEntry(`‚ùå ${data.error || 'Failed to close position'}`, 'error');

            // Reset processing flag to allow closing
            isOrderProcessing = false;

            // Reset buttons
            confirmBtn.textContent = 'Close';
            confirmBtn.disabled = false;
            confirmBtn.onclick = closeModal;
            cancelBtn.textContent = 'Cancel';
            cancelBtn.disabled = false;
            cancelBtn.onclick = closeModal;
        }

    } catch (error) {
        console.error('Error closing position:', error);

        // Stop polling
        closeExecutionState.isRunning = false;
        if (closeExecutionState.pollInterval) {
            clearInterval(closeExecutionState.pollInterval);
        }

        addLogEntry(`‚ùå Error: ${error.message}`, 'error');

        // Reset processing flag to allow closing
        isOrderProcessing = false;

        // Reset buttons
        confirmBtn.textContent = 'Close';
        confirmBtn.disabled = false;
        confirmBtn.onclick = closeModal;
        cancelBtn.textContent = 'Cancel';
        cancelBtn.disabled = false;
        cancelBtn.onclick = closeModal;
    }
}

// Get CSRF token
function getCsrfToken() {
    // Try to get from form input first
    const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (tokenInput) return tokenInput.value;

    // Try to get from cookie
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue || '';
}

// ======================================
// Average Position Modal Functions
// ======================================

// Show average position modal
async function showAverageModal(broker) {
    const modal = document.getElementById('averagePositionModal');
    const modalBody = document.getElementById('averageModalBody');

    modal.classList.add('active');
    modalBody.innerHTML = '<div class="loading-spinner">Loading position recommendations...</div>';

    try {
        // Get all positions for the broker
        const response = await fetch(`/trading/api/get-positions/?broker=${broker}`);
        const data = await response.json();

        if (data.success && data.positions && data.positions.length > 0) {
            // Build the modal content with all positions
            displayAverageRecommendations(broker, data.positions);
        } else {
            modalBody.innerHTML = `
                <div class="no-positions">
                    <div class="no-positions-icon">üì≠</div>
                    <p>No active positions found for averaging</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading positions for averaging:', error);
        modalBody.innerHTML = `<div class="error-message">Failed to load positions. Please try again.</div>`;
    }
}

// Display average recommendations for each position
function displayAverageRecommendations(broker, positions) {
    const modalBody = document.getElementById('averageModalBody');

    const html = `
        <div style="margin-bottom: 20px;">
            <p style="color: #6b7280; margin-bottom: 20px;">
                Select a position below to view averaging recommendations based on real-time market analysis.
            </p>
        </div>

        ${positions.map(pos => `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s;"
                 onclick="verifyPositionForAveraging('${broker}', '${pos.symbol}')"
                 onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'"
                 onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow=''">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0 0 8px 0; font-size: 1.25rem; color: #1f2937;">${pos.symbol}</h3>
                        <div style="display: flex; gap: 15px; font-size: 0.875rem; color: #6b7280;">
                            <span>Direction: <strong class="${pos.direction.toLowerCase() === 'long' ? 'direction-long' : 'direction-short'}">${pos.direction}</strong></span>
                            <span>Qty: <strong>${pos.quantity}</strong></span>
                            <span>Avg Price: <strong>‚Çπ${parseFloat(pos.average_price).toFixed(2)}</strong></span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">Unrealized P&L</div>
                        <div class="${getPnLClass(pos.unrealized_pnl)}" style="font-size: 1.25rem; font-weight: 700;">
                            ‚Çπ${parseFloat(pos.unrealized_pnl).toFixed(2)}
                        </div>
                        <div style="font-size: 0.875rem; color: #6b7280;">
                            ${parseFloat(pos.pnl_percentage).toFixed(2)}%
                        </div>
                    </div>
                </div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f3f4f6; text-align: center; color: #3b82f6; font-size: 0.875rem; font-weight: 600;">
                    Click to verify averaging opportunity ‚Üí
                </div>
            </div>
        `).join('')}
    `;

    modalBody.innerHTML = html;
}

// Current averaging analysis data
let currentAveragingData = null;

// Verify position for averaging (calls the verify API)
async function verifyPositionForAveraging(broker, symbol) {
    const modalBody = document.getElementById('averageModalBody');
    modalBody.innerHTML = '<div class="loading-spinner">Analyzing position for averaging...</div>';

    try {
        // First, get the position details
        const positionsResponse = await fetch(`/trading/api/get-positions/?broker=${broker}`);
        const positionsData = await positionsResponse.json();

        if (!positionsData.success) {
            throw new Error('Failed to fetch position details');
        }

        // Find the specific position
        const position = positionsData.positions.find(p => p.symbol === symbol);
        if (!position) {
            throw new Error('Position not found');
        }

        // Extract expiry date from position (format varies by broker)
        // For futures, symbol usually contains expiry info
        const expiry_date = position.expiry_date || '';  // Will be extracted from position data

        // Call averaging analysis API
        const response = await fetch('/trading/api/analyze-averaging/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                broker: broker,
                symbol: symbol,
                direction: position.direction,
                entry_price: position.average_price,
                quantity: position.net_quantity_shares || position.quantity,
                expiry_date: expiry_date
            })
        });

        const data = await response.json();

        if (!data.success) {
            modalBody.innerHTML = `
                <div class="error-message">
                    <strong>Analysis Failed</strong><br>
                    ${data.error || 'Unable to analyze position for averaging'}
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-secondary" onclick="showAverageModal('${broker}')">‚Üê Back to Positions</button>
                </div>
            `;
            return;
        }

        // Store current data for later use
        currentAveragingData = {
            ...data,
            broker: broker,
            symbol: symbol,
            position: position
        };

        // Display the averaging recommendation
        displayAveragingAnalysis(data, broker, symbol);

    } catch (error) {
        console.error('Error verifying position:', error);
        modalBody.innerHTML = `
            <div class="error-message">
                <strong>Error</strong><br>
                ${error.message || 'Failed to analyze position. Please try again.'}
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-secondary" onclick="showAverageModal('${broker}')">‚Üê Back to Positions</button>
            </div>
        `;
    }
}

// Display averaging analysis results
function displayAveragingAnalysis(data, broker, symbol) {
    const modalBody = document.getElementById('averageModalBody');

    const recommendation = data.recommendation;
    const confidence = data.confidence;
    const critical_checks = data.critical_checks || {};
    const additional_checks = data.additional_checks || {};
    const risk_assessment = data.risk_assessment || {};
    const position_sizing = data.position_sizing || {};

    // Determine recommendation color and badge
    let recColor = '#6b7280';
    let recBadge = 'NO AVERAGE';
    let recIcon = '‚õî';

    if (recommendation === 'STRONG_AVERAGE') {
        recColor = '#10b981';
        recBadge = 'STRONG BUY';
        recIcon = '‚úÖ';
    } else if (recommendation === 'MODERATE_AVERAGE') {
        recColor = '#f59e0b';
        recBadge = 'MODERATE BUY';
        recIcon = '‚ö†Ô∏è';
    } else if (recommendation === 'WEAK_AVERAGE') {
        recColor = '#ef4444';
        recBadge = 'WEAK - RISKY';
        recIcon = '‚ùå';
    }

    let html = `
        <!-- Recommendation Banner -->
        <div style="background: linear-gradient(135deg, ${recColor} 0%, ${recColor}dd 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 10px;">${recIcon}</div>
            <h2 style="margin: 0; font-size: 1.75rem;">${recBadge}</h2>
            <p style="margin: 10px 0 0 0; font-size: 1rem; opacity: 0.9;">${data.reason}</p>
            <div style="margin-top: 15px; font-size: 2rem; font-weight: 700;">
                Confidence: ${confidence}/100
            </div>
        </div>

        <!-- Price Summary -->
        <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="color: #1f2937; margin: 0 0 15px 0;">üìä Price Analysis</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div class="position-card">
                    <div class="position-label">Entry Price</div>
                    <div class="position-value">‚Çπ${parseFloat(data.entry_price).toFixed(2)}</div>
                </div>
                <div class="position-card">
                    <div class="position-label">Current Price</div>
                    <div class="position-value">‚Çπ${parseFloat(data.current_price).toFixed(2)}</div>
                </div>
                <div class="position-card">
                    <div class="position-label">Price Change</div>
                    <div class="position-value" style="color: ${data.price_change_pct < 0 ? '#ef4444' : '#10b981'};">
                        ${data.price_change_pct > 0 ? '+' : ''}${parseFloat(data.price_change_pct).toFixed(2)}%
                    </div>
                </div>
            </div>
        </div>

        <!-- Critical Checks -->
        <div class="score-card">
            <h3 class="score-header">üîç Critical Checks (Must Pass)</h3>

            ${buildCheckCard(
                'Price Movement Check',
                critical_checks.price_drop_check,
                critical_checks.price_drop_check?.passed ? '‚úÖ' : '‚ùå'
            )}

            ${buildCheckCard(
                'Support/Resistance Proximity',
                critical_checks.support_proximity_check,
                critical_checks.support_proximity_check?.passed ? '‚úÖ' : '‚ùå'
            )}

            ${buildCheckCard(
                'Open Interest',
                critical_checks.open_interest_check,
                critical_checks.open_interest_check?.passed ? '‚úÖ' : '‚ùå'
            )}
        </div>

        <!-- Additional Checks -->
        ${Object.keys(additional_checks).length > 0 ? `
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #1f2937; margin: 0 0 15px 0;">üìà Additional Analysis</h3>
                ${buildAdditionalChecks(additional_checks)}
            </div>
        ` : ''}

        <!-- Risk Assessment -->
        ${risk_assessment.risk_level ? `
            <div style="background: ${risk_assessment.risk_level === 'LOW' ? '#d1fae5' : (risk_assessment.risk_level === 'MEDIUM' ? '#fef3c7' : '#fee2e2')}; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #1f2937; margin: 0 0 15px 0;">‚ö†Ô∏è Risk Assessment</h3>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 1.125rem; color: #1f2937;">Risk Level:</span>
                    <span style="font-size: 1.5rem; font-weight: 700; color: ${risk_assessment.risk_level === 'LOW' ? '#059669' : (risk_assessment.risk_level === 'MEDIUM' ? '#d97706' : '#dc2626')};">
                        ${risk_assessment.risk_level}
                    </span>
                </div>
                <div style="margin-top: 10px; color: #6b7280; font-size: 0.875rem;">
                    ${risk_assessment.message || ''}
                </div>
            </div>
        ` : ''}
    `;

    // Only show position sizing if recommendation is not NO_AVERAGE
    if (recommendation !== 'NO_AVERAGE' && position_sizing.recommended_lots > 0) {
        html += buildPositionSizingSection(position_sizing, data, broker, symbol);
    } else {
        html += `
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="showAverageModal('${broker}')">‚Üê Back to Positions</button>
            </div>
        `;
    }

    modalBody.innerHTML = html;
}

// Helper function to build check cards
function buildCheckCard(title, check, icon) {
    if (!check) return '';

    return `
        <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h4 style="margin: 0; font-size: 1rem; color: #1f2937;">${icon} ${title}</h4>
                <span style="background: ${check.passed ? '#d1fae5' : '#fee2e2'}; color: ${check.passed ? '#065f46' : '#991b1b'}; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                    ${check.passed ? 'PASSED' : 'FAILED'}
                </span>
            </div>
            <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">${check.message || ''}</p>
        </div>
    `;
}

// Helper function to build additional checks
function buildAdditionalChecks(checks) {
    let html = '<div style="display: grid; gap: 10px;">';

    if (checks.trend) {
        html += buildCheckCard('Trend Analysis', checks.trend, checks.trend.healthy ? '‚úÖ' : '‚ö†Ô∏è');
    }

    if (checks.volume) {
        html += buildCheckCard('Volume Check', checks.volume, checks.volume.adequate ? '‚úÖ' : '‚ö†Ô∏è');
    }

    if (checks.sector) {
        html += buildCheckCard('Sector Health', checks.sector, checks.sector.healthy ? '‚úÖ' : '‚ö†Ô∏è');
    }

    if (checks.volatility) {
        html += buildCheckCard('Volatility', checks.volatility, checks.volatility.acceptable ? '‚úÖ' : '‚ö†Ô∏è');
    }

    html += '</div>';
    return html;
}

// Build position sizing section with editable lots
function buildPositionSizingSection(position_sizing, data, broker, symbol) {
    const recommended_lots = position_sizing.recommended_lots || 0;
    const current_lots = position_sizing.current_lots || 0;
    const lot_size = data.lot_size || 0;

    return `
        <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 12px; padding: 25px; margin-bottom: 20px; color: white;">
            <h3 style="color: white; margin-bottom: 20px; font-size: 1.3rem;">üìä Position Sizing Recommendation</h3>

            <!-- Current Position Info -->
            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">Current Lots</div>
                        <div style="font-size: 1.5rem; font-weight: 700;">${current_lots}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">Current Qty</div>
                        <div style="font-size: 1.5rem; font-weight: 700;">${position_sizing.current_quantity || 0}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">Avg Price</div>
                        <div style="font-size: 1.5rem; font-weight: 700;">‚Çπ${parseFloat(data.entry_price).toFixed(2)}</div>
                    </div>
                </div>
            </div>

            <!-- Lot Size Editor -->
            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="color: white; margin-bottom: 15px; font-size: 1rem;">üéØ Adjust Averaging Size</h4>
                <div style="display: flex; align-items: center; gap: 15px; justify-content: center;">
                    <button onclick="adjustAveragingLots(-1)"
                            style="background: #ef4444; color: white; width: 40px; height: 40px; border: none; border-radius: 8px; font-size: 1.5rem; cursor: pointer; font-weight: 700;">‚àí</button>
                    <div style="text-align: center;">
                        <input type="number"
                               id="averagingLotsInput"
                               value="${recommended_lots}"
                               min="1"
                               max="100"
                               onchange="updateAveragingPosition()"
                               style="width: 100px; padding: 12px; border: none; border-radius: 8px; text-align: center; font-size: 1.25rem; font-weight: 700;">
                        <div style="font-size: 0.875rem; margin-top: 5px;">Lots to Add</div>
                    </div>
                    <button onclick="adjustAveragingLots(1)"
                            style="background: #10b981; color: white; width: 40px; height: 40px; border: none; border-radius: 8px; font-size: 1.5rem; cursor: pointer; font-weight: 700;">+</button>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                    <button onclick="setAveragingLots(${Math.max(1, Math.floor(current_lots * 0.1))})" style="padding: 8px 16px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: white; cursor: pointer; font-size: 0.875rem;">10% (${Math.max(1, Math.floor(current_lots * 0.1))} lots)</button>
                    <button onclick="setAveragingLots(${Math.max(1, Math.floor(current_lots * 0.25))})" style="padding: 8px 16px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: white; cursor: pointer; font-size: 0.875rem;">25% (${Math.max(1, Math.floor(current_lots * 0.25))} lots)</button>
                    <button onclick="setAveragingLots(${recommended_lots})" style="padding: 8px 16px; background: rgba(16,185,129,0.3); border: 1px solid rgba(16,185,129,0.5); border-radius: 6px; color: white; cursor: pointer; font-size: 0.875rem;">Recommended (${recommended_lots} lots)</button>
                </div>
            </div>

            <!-- Live Position Summary -->
            <div id="averagingPositionSummary" style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 8px;">
                ${buildAveragingPositionSummary(position_sizing, data, recommended_lots)}
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
            <button onclick="executeAveragingOrder()" class="btn btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 14px 40px; border: none; border-radius: 8px; font-size: 1.125rem; font-weight: 600; cursor: pointer;">
                ‚úÖ Place Averaging Order
            </button>
            <button onclick="showAverageModal('${broker}')" class="btn btn-secondary" style="background: #6b7280; color: white; padding: 14px 40px; border: none; border-radius: 8px; font-size: 1.125rem; font-weight: 600; cursor: pointer;">
                ‚Üê Back to Positions
            </button>
        </div>
    `;
}

// Build averaging position summary
function buildAveragingPositionSummary(position_sizing, data, add_lots) {
    const lot_size = data.lot_size || 0;
    const current_price = data.current_price || 0;
    const entry_price = data.entry_price || 0;
    const current_quantity = position_sizing.current_quantity || 0;

    const add_quantity = add_lots * lot_size;
    const new_total_quantity = current_quantity + add_quantity;
    const new_avg_price = ((entry_price * current_quantity) + (current_price * add_quantity)) / new_total_quantity;
    const price_improvement = Math.abs(new_avg_price - entry_price);
    const improvement_pct = (price_improvement / entry_price) * 100;

    const margin_per_lot = position_sizing.margin_per_lot || 0;
    const margin_required = add_lots * margin_per_lot;
    const available_margin = position_sizing.available_margin || 0;
    const margin_utilization = available_margin > 0 ? ((margin_required / available_margin) * 100).toFixed(1) : '0';

    return `
        <h4 style="color: white; margin-bottom: 15px; font-size: 1rem;">üìà After Averaging Summary</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 6px;">
                <div style="font-size: 0.75rem; opacity: 0.9;">Add Quantity</div>
                <div style="font-size: 1.25rem; font-weight: 700;">+${add_quantity}</div>
                <div style="font-size: 0.7rem; opacity: 0.8;">${add_lots} lots</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 6px;">
                <div style="font-size: 0.75rem; opacity: 0.9;">New Total Qty</div>
                <div style="font-size: 1.25rem; font-weight: 700;">${new_total_quantity}</div>
                <div style="font-size: 0.7rem; opacity: 0.8;">${Math.floor(new_total_quantity / lot_size)} lots</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 6px;">
                <div style="font-size: 0.75rem; opacity: 0.9;">New Avg Price</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #a7f3d0;">‚Çπ${new_avg_price.toFixed(2)}</div>
                <div style="font-size: 0.7rem; opacity: 0.8;">Improved by ${improvement_pct.toFixed(2)}%</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 6px;">
                <div style="font-size: 0.75rem; opacity: 0.9;">Margin Required</div>
                <div style="font-size: 1.25rem; font-weight: 700;">‚Çπ${formatIndianNumber(margin_required)}</div>
                <div style="font-size: 0.7rem; opacity: 0.8;">${margin_utilization}% utilization</div>
            </div>
        </div>
        <div style="padding: 15px; background: rgba(59, 130, 246, 0.2); border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.4);">
            <div style="font-size: 0.875rem; opacity: 0.9;">
                üí∞ <strong>Margin Available:</strong> ‚Çπ${formatIndianNumber(available_margin)} ‚Ä¢
                <strong>Utilization:</strong> ${margin_utilization}% ‚Ä¢
                ${margin_utilization > 60 ? '‚ö†Ô∏è High' : '‚úÖ Safe'}
            </div>
        </div>
    `;
}

// Adjust averaging lots
function adjustAveragingLots(delta) {
    const input = document.getElementById('averagingLotsInput');
    const currentValue = parseInt(input.value) || 1;
    const newValue = Math.max(1, Math.min(100, currentValue + delta));
    input.value = newValue;
    updateAveragingPosition();
}

// Set specific averaging lots
function setAveragingLots(lots) {
    document.getElementById('averagingLotsInput').value = lots;
    updateAveragingPosition();
}

// Update averaging position summary
function updateAveragingPosition() {
    const lots = parseInt(document.getElementById('averagingLotsInput').value) || 1;

    if (currentAveragingData) {
        const position_sizing = currentAveragingData.position_sizing;
        const summary = buildAveragingPositionSummary(position_sizing, currentAveragingData, lots);
        document.getElementById('averagingPositionSummary').innerHTML = summary;
    }
}

// Format Indian number system
function formatIndianNumber(num) {
    if (!num) return '0';
    const x = num.toString();
    const lastThree = x.substring(x.length - 3);
    const otherNumbers = x.substring(0, x.length - 3);
    if (otherNumbers !== '') {
        return otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + "," + lastThree;
    }
    return lastThree;
}

// Execute averaging order
async function executeAveragingOrder() {
    if (!currentAveragingData) {
        alert('No averaging data available');
        return;
    }

    const lots = parseInt(document.getElementById('averagingLotsInput').value) || 0;
    if (lots === 0) {
        alert('Please enter a valid lot size');
        return;
    }

    // Show confirmation
    const lot_size = currentAveragingData.lot_size || 0;
    const quantity = lots * lot_size;
    const current_price = currentAveragingData.current_price || 0;
    const value = quantity * current_price;

    if (!confirm(`‚ö†Ô∏è CONFIRM AVERAGING ORDER\n\nSymbol: ${currentAveragingData.symbol}\nDirection: ${currentAveragingData.direction}\nQuantity: ${quantity} (${lots} lots)\nPrice: ‚Çπ${current_price.toFixed(2)}\nValue: ‚Çπ${formatIndianNumber(value)}\n\nThis will add to your existing position. Continue?`)) {
        return;
    }

    // TODO: Implement order placement
    alert('Order placement will be implemented in the next phase.\n\nThis will:\n1. Place futures order via Breeze/Neo API\n2. Update your position\n3. Show order confirmation');
}

// Handle overlay click for average modal
function handleAverageOverlayClick(event) {
    if (event.target.id === 'averagePositionModal') {
        closeAverageModal();
    }
}

// Close average modal
function closeAverageModal() {
    const modal = document.getElementById('averagePositionModal');
    modal.classList.remove('active');
}
</script>
{% endblock %}

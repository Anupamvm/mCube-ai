{% extends "core/master_base.html" %}
{% load static %}

{% block title %}Manual Trade Triggers - mCube Trading{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: var(--white);
        padding: 2rem 0;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-sm);
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0 0 0.5rem 0;
    }

    .page-subtitle {
        color: var(--gray);
        margin: 0;
    }

    .triggers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .trigger-card {
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-md);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .trigger-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .trigger-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .trigger-icon {
        font-size: 2.5rem;
    }

    .trigger-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0;
    }

    .trigger-description {
        color: var(--gray);
        margin: 0 0 1.5rem 0;
        line-height: 1.6;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--dark);
    }

    .form-select {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid var(--gray-light);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
        width: 100%;
    }

    .btn-primary {
        background: var(--primary);
        color: var(--white);
    }

    .btn-primary:hover:not(:disabled) {
        background: var(--primary-hover);
        transform: translateY(-1px);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-success {
        background: var(--success);
        color: var(--white);
    }

    .btn-success:hover {
        background: var(--success-hover);
    }

    .btn-secondary {
        background: var(--white);
        color: var(--dark);
        border: 1px solid var(--gray-light);
    }

    .btn-secondary:hover {
        background: var(--light);
    }

    .loading-spinner {
        display: none;
        margin-top: 1rem;
        text-align: center;
        color: var(--primary);
    }

    .loading-spinner.active {
        display: block;
    }

    .result-panel {
        display: none;
        margin-top: 2rem;
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-md);
    }

    .result-panel.active {
        display: block;
    }

    .result-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--light);
        margin-bottom: 1.5rem;
    }

    .result-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        flex: 1;
    }

    .result-badge {
        padding: 0.5rem 1rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
    }

    .result-badge.pass {
        background: #D1FAE5;
        color: #065F46;
    }

    .result-badge.fail {
        background: #FEE2E2;
        color: #991B1B;
    }

    .result-section {
        margin-bottom: 2rem;
    }

    .result-section h3 {
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0 0 1rem 0;
        color: var(--dark);
    }

    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .result-item {
        background: var(--lighter);
        padding: 1rem;
        border-radius: var(--radius-md);
    }

    .result-item-label {
        font-size: 0.75rem;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .result-item-value {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--dark);
    }

    .explanation-box {
        background: #F0F9FF;
        border-left: 4px solid var(--primary);
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-top: 1rem;
    }

    .explanation-box h4 {
        margin: 0 0 0.5rem 0;
        color: var(--primary);
        font-size: 1rem;
    }

    .explanation-box p {
        margin: 0.5rem 0;
        line-height: 1.6;
        color: var(--dark);
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .error-message {
        background: #FEE2E2;
        color: #991B1B;
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-top: 1rem;
        border-left: 4px solid var(--danger);
    }

    /* Breeze Login Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: var(--radius-lg);
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        margin-bottom: 1.5rem;
    }

    .modal-header h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        color: var(--dark);
    }

    .modal-header p {
        margin: 0;
        color: var(--gray);
        font-size: 0.875rem;
    }

    .modal-body {
        margin-bottom: 1.5rem;
    }

    .modal-body .form-group {
        margin-bottom: 1rem;
    }

    .modal-body .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--dark);
    }

    .modal-body .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--gray-light);
        border-radius: var(--radius-md);
        font-size: 1rem;
    }

    .modal-body .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .modal-footer {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .modal-error {
        background: #FEE2E2;
        color: #991B1B;
        padding: 0.75rem;
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }

    .modal-success {
        background: #D1FAE5;
        color: #065F46;
        padding: 0.75rem;
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }

    @media (max-width: 768px) {
        .triggers-grid {
            grid-template-columns: 1fr;
        }

        .result-grid {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">Manual Trade Triggers</h1>
        <p class="page-subtitle">Manually run trading algorithms and get detailed analysis</p>
    </div>
</div>

<div class="container">
    <div class="triggers-grid">
        <!-- 1. Run Futures Algorithm -->
        <div class="trigger-card">
            <div class="trigger-header">
                <span class="trigger-icon">üéØ</span>
                <h2 class="trigger-title">Futures Algorithm</h2>
            </div>
            <p class="trigger-description">
                Runs the complete futures screening algorithm to find the top 3 trading opportunities.
                Uses multi-factor analysis (OI, sector strength, technical indicators) with volume filtering.
            </p>

            <!-- Volume Threshold Inputs -->
            <div class="form-group" style="background: var(--lighter); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                <label class="form-label" style="margin-bottom: 0.75rem;">üìä Volume Filters (OR Logic)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <div>
                        <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem; color: var(--gray);">This Month Volume (‚â•)</label>
                        <input type="number" class="form-select" id="futuresThisMonthVolume" value="1000" min="0" step="100" style="padding: 0.5rem;" placeholder="e.g., 1000">
                    </div>
                    <div>
                        <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem; color: var(--gray);">Next Month Volume (‚â•)</label>
                        <input type="number" class="form-select" id="futuresNextMonthVolume" value="800" min="0" step="100" style="padding: 0.5rem;" placeholder="e.g., 800">
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: var(--gray); margin: 0.5rem 0 0 0;">
                    üí° Tip: Algorithm analyzes all contracts meeting volume criteria and returns top 3 opportunities.
                </p>
            </div>

            <button class="btn btn-primary" onclick="runFuturesAlgorithm(this)" id="btnFutures">
                Run Futures Screening
            </button>
            <div class="loading-spinner" id="loadingFutures">
                <div>‚è≥ Analyzing stocks...</div>
            </div>
        </div>

        <!-- 2. Nifty Options Strangle -->
        <div class="trigger-card">
            <div class="trigger-header">
                <span class="trigger-icon">üìä</span>
                <h2 class="trigger-title">Nifty Strangle</h2>
            </div>
            <p class="trigger-description">
                Generates a Nifty weekly strangle position for your Kotak account.
                Calculates optimal strikes based on current market conditions and VIX.
            </p>
            <button class="btn btn-primary" onclick="runNiftyStrangle(this)" id="btnStrangle">
                Generate Strangle Position
            </button>
            <div class="loading-spinner" id="loadingStrangle">
                <div>‚è≥ Calculating strikes...</div>
            </div>
        </div>

        <!-- 3. Verify Future Trade -->
        <div class="trigger-card">
            <div class="trigger-header">
                <span class="trigger-icon">‚úÖ</span>
                <h2 class="trigger-title">Verify Future Trade</h2>
            </div>
            <p class="trigger-description">
                Verify a specific futures contract for trading. Adjust volume thresholds to filter contracts and get complete analysis with pass/fail verdict.
            </p>

            <!-- Volume Threshold Inputs -->
            <div class="form-group" style="background: var(--lighter); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                <label class="form-label" style="margin-bottom: 0.75rem;">üìä Volume Filters (OR Logic)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div>
                        <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem; color: var(--gray);">This Month Volume (‚â•)</label>
                        <input type="number" class="form-select" id="thisMonthVolume" value="1000" min="0" step="100" style="padding: 0.5rem;" placeholder="e.g., 1000">
                    </div>
                    <div>
                        <label class="form-label" style="font-size: 0.75rem; margin-bottom: 0.25rem; color: var(--gray);">Next Month Volume (‚â•)</label>
                        <input type="number" class="form-select" id="nextMonthVolume" value="800" min="0" step="100" style="padding: 0.5rem;" placeholder="e.g., 800">
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: var(--gray); margin: 0 0 0.75rem 0;">
                    üí° Tip: Lower values = more contracts. Try 500/400 for smaller volume stocks.
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <button class="btn btn-secondary" onclick="refreshContractList()" id="btnRefreshContracts" style="margin-bottom: 0; font-size: 0.8rem;" title="Query local database with volume filters (fast)">
                        üîÑ Update List
                    </button>
                    <button class="btn btn-primary" onclick="fetchAndUpdateTrendlyne()" id="btnFetchTrendlyne" style="margin-bottom: 0; font-size: 0.8rem;" title="Download fresh data from Trendlyne (2-3 mins)">
                        üì• Fetch Fresh Data
                    </button>
                </div>
                <p style="font-size: 0.7rem; color: var(--gray); margin: 0.5rem 0 0 0; font-style: italic;">
                    <strong>Update List</strong>: Filter existing data | <strong>Fetch Fresh Data</strong>: Download from Trendlyne (2-3 min)
                </p>
            </div>

            <div class="form-group">
                <label class="form-label" for="contractSelect">Select Futures Contract (<span id="contractCount">{{ total_contracts|default:"0" }}</span> contracts available)</label>
                <select class="form-select" id="contractSelect">
                    <option value="">-- Select a contract --</option>
                    {% for contract in futures_contracts %}
                    <option value="{{ contract.value }}"
                            data-volume="{{ contract.volume }}"
                            data-price="{{ contract.price }}"
                            data-lot="{{ contract.lot_size }}">
                        {{ contract.display }} (Vol: {{ contract.volume }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <button class="btn btn-primary" onclick="verifyFutureTrade(this)" id="btnVerify">
                Verify Trade
            </button>
            <div class="loading-spinner" id="loadingVerify">
                <div>‚è≥ Analyzing <span id="verifyingStock"></span>...</div>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="result-panel" id="resultsPanel">
        <div class="result-header">
            <h2 class="result-title" id="resultTitle">Analysis Results</h2>
            <span class="result-badge" id="resultBadge"></span>
        </div>
        <div id="resultContent"></div>
    </div>
</div>

<!-- Breeze Login Modal -->
<div class="modal-overlay" id="breezeLoginModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üîê Breeze Re-Authentication Required</h2>
            <p>Your Breeze session has expired. Please enter your new session token to continue.</p>
        </div>
        <div class="modal-body">
            <div id="modalMessage"></div>
            <div class="form-group">
                <label class="form-label" for="sessionTokenInput">Session Token</label>
                <input
                    type="text"
                    id="sessionTokenInput"
                    class="form-input"
                    placeholder="Enter Breeze session token"
                    autocomplete="off"
                />
                <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.5rem;">
                    üí° <a href="https://api.icicidirect.com/apiuser/home" target="_blank" style="color: var(--primary); text-decoration: underline;">Click here to get your session token</a>
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeBreezeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateBreezeSession()" id="updateSessionBtn">
                Update & Retry
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // CSRF token for POST requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Global variable to store the pending request for retry after re-auth
    let pendingRequest = null;

    // Breeze Authentication Modal Functions
    function showBreezeLoginModal(pendingRequestData) {
        pendingRequest = pendingRequestData;
        document.getElementById('breezeLoginModal').classList.add('active');
        document.getElementById('sessionTokenInput').value = '';
        document.getElementById('modalMessage').innerHTML = '';
        document.getElementById('sessionTokenInput').focus();
    }

    function closeBreezeModal() {
        document.getElementById('breezeLoginModal').classList.remove('active');
        pendingRequest = null;
    }

    async function updateBreezeSession() {
        const sessionToken = document.getElementById('sessionTokenInput').value.trim();
        const btn = document.getElementById('updateSessionBtn');
        const messageDiv = document.getElementById('modalMessage');

        if (!sessionToken) {
            messageDiv.innerHTML = '<div class="modal-error">Please enter a session token</div>';
            return;
        }

        btn.disabled = true;
        btn.textContent = '‚è≥ Updating...';
        messageDiv.innerHTML = '';

        try {
            const response = await fetch('{% url "trading:update_breeze_session" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ session_token: sessionToken })
            });

            const data = await response.json();

            if (data.success) {
                messageDiv.innerHTML = '<div class="modal-success">‚úÖ Session updated successfully! Retrying request...</div>';

                // Wait a moment then close modal and retry
                setTimeout(async () => {
                    closeBreezeModal();

                    // Retry the original request
                    if (pendingRequest) {
                        await retryRequest(pendingRequest);
                    }
                }, 1000);
            } else {
                messageDiv.innerHTML = `<div class="modal-error">‚ùå ${data.error}</div>`;
                btn.disabled = false;
                btn.textContent = 'Update & Retry';
            }
        } catch (error) {
            messageDiv.innerHTML = `<div class="modal-error">‚ùå Network error: ${error.message}</div>`;
            btn.disabled = false;
            btn.textContent = 'Update & Retry';
        }
    }

    async function retryRequest(requestData) {
        // Retry the original request based on request type
        const { type, params } = requestData;

        if (type === 'futures_algorithm') {
            const btn = document.getElementById('btnFutures');
            await runFuturesAlgorithm(btn, params.confirmed);
        } else if (type === 'verify_trade') {
            const btn = document.getElementById('btnVerify');
            await verifyFutureTrade(btn);
        } else if (type === 'nifty_strangle') {
            const btn = document.getElementById('btnStrangle');
            await runNiftyStrangle(btn);
        }
    }

    // Handle authentication errors in responses
    function handleAuthError(data, requestType, params = {}) {
        if (data.auth_required) {
            showBreezeLoginModal({
                type: requestType,
                params: params
            });
            return true;
        }
        return false;
    }

    // Refresh Contract List from Local DB (fast operation)
    // This just queries the existing database with new volume filters
    async function refreshContractList() {
        const thisMonthVol = document.getElementById('thisMonthVolume').value || 1000;
        const nextMonthVol = document.getElementById('nextMonthVolume').value || 800;
        const btn = document.getElementById('btnRefreshContracts');

        btn.disabled = true;
        btn.textContent = '‚è≥ Updating...';

        try {
            const response = await fetch('{% url "trading:get_contracts" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    this_month_volume: parseInt(thisMonthVol),
                    next_month_volume: parseInt(nextMonthVol)
                })
            });

            const data = await response.json();

            if (data.success) {
                // Update dropdown with new contract list
                const select = document.getElementById('contractSelect');
                select.innerHTML = '<option value="">-- Select a contract --</option>';

                data.contracts.forEach(contract => {
                    const option = document.createElement('option');
                    option.value = contract.value;
                    option.setAttribute('data-volume', contract.volume);
                    option.setAttribute('data-price', contract.price || 0);
                    option.setAttribute('data-lot', contract.lot_size || 0);
                    option.textContent = `${contract.display} (Vol: ${contract.volume})`;
                    select.appendChild(option);
                });

                // Update count
                document.getElementById('contractCount').textContent = data.total_contracts;

                btn.textContent = '‚úÖ Updated';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Update List';
                }, 2000);
            } else {
                alert('Error updating contracts: ' + data.error);
                btn.textContent = 'üîÑ Update List';
            }
        } catch (error) {
            alert('Network error: ' + error.message);
            btn.textContent = 'üîÑ Update List';
        } finally {
            btn.disabled = false;
        }
    }

    // Fetch Fresh Data from Trendlyne (slow operation - webscraping)
    // This downloads latest F&O data from Trendlyne and updates the dropdown
    async function fetchAndUpdateTrendlyne() {
        const thisMonthVol = document.getElementById('thisMonthVolume').value || 1000;
        const nextMonthVol = document.getElementById('nextMonthVolume').value || 800;
        const btn = document.getElementById('btnFetchTrendlyne');
        const updateBtn = document.getElementById('btnRefreshContracts');
        const selectElement = document.getElementById('contractSelect');

        // Disable both buttons during fetch
        btn.disabled = true;
        updateBtn.disabled = true;
        btn.textContent = '‚è≥ Fetching...';

        // Show wait message in dropdown
        selectElement.innerHTML = '<option value="">‚è≥ Downloading Trendlyne data... Please wait 2-3 minutes...</option>';

        try {
            const response = await fetch('{% url "trading:refresh_trendlyne" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data_type: 'fno'
                })
            });

            const data = await response.json();

            if (data.success) {
                btn.textContent = '‚úÖ Fetched';
                selectElement.innerHTML = '<option value="">‚úÖ Data downloaded! Updating list...</option>';

                // Now refresh the contract list with current volume filters
                setTimeout(async () => {
                    await refreshContractList();
                    btn.textContent = 'üì• Fetch Trendlyne';
                }, 1000);
            } else {
                selectElement.innerHTML = `<option value="">‚ùå Error: ${data.error}</option>`;
                btn.textContent = 'üì• Fetch Trendlyne';
                alert('Error fetching Trendlyne data: ' + data.error);
            }
        } catch (error) {
            selectElement.innerHTML = `<option value="">‚ùå Network error occurred</option>`;
            btn.textContent = 'üì• Fetch Trendlyne';
            alert('Network error: ' + error.message);
        } finally {
            btn.disabled = false;
            updateBtn.disabled = false;
        }
    }

    // 1. Run Futures Algorithm
    async function runFuturesAlgorithm(btn, confirmed = false) {
        const thisMonthVol = document.getElementById('futuresThisMonthVolume').value || 1000;
        const nextMonthVol = document.getElementById('futuresNextMonthVolume').value || 800;

        btn.disabled = true;
        document.getElementById('loadingFutures').classList.add('active');
        document.getElementById('resultsPanel').classList.remove('active');

        try {
            const response = await fetch('{% url "trading:trigger_futures" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    this_month_volume: parseInt(thisMonthVol),
                    next_month_volume: parseInt(nextMonthVol),
                    confirmed: confirmed
                })
            });

            const data = await response.json();

            // Check for authentication error
            if (handleAuthError(data, 'futures_algorithm', { confirmed })) {
                return;
            }

            if (data.success) {
                displayFuturesTop3Result(data);
            } else if (data.requires_confirmation) {
                // Ask user for confirmation
                const userConfirmed = confirm(
                    `${data.message}\n\n` +
                    `Contracts found: ${data.contract_count}\n` +
                    `This will analyze ALL contracts and may take several minutes.\n\n` +
                    `Click OK to proceed or Cancel to adjust filters.`
                );

                if (userConfirmed) {
                    // Re-run with confirmation
                    await runFuturesAlgorithm(btn, true);
                    return;
                } else {
                    displayError('Analysis cancelled. Please adjust volume filters to reduce contract count.');
                }
            } else {
                displayError(data.error);
            }
        } catch (error) {
            displayError('Network error: ' + error.message);
        } finally {
            btn.disabled = false;
            document.getElementById('loadingFutures').classList.remove('active');
        }
    }

    function displayFuturesTop3Result(data) {
        const allContracts = data.all_contracts;
        const totalAnalyzed = data.total_analyzed;
        const totalPassed = data.total_passed;
        const totalFailed = data.total_failed;
        const totalErrors = data.total_errors;
        const volumeFilters = data.volume_filters;

        document.getElementById('resultTitle').textContent = `Futures Analysis Results`;
        document.getElementById('resultBadge').textContent = `${totalPassed} PASSED / ${totalFailed} FAILED`;
        document.getElementById('resultBadge').className = 'result-badge ' + (totalPassed > 0 ? 'pass' : 'fail');

        // Build HTML for all contracts
        let contractsHTML = '';

        allContracts.forEach((contract, index) => {
            const rank = index + 1;
            const isPassed = contract.verdict === 'PASS';
            const isFailed = contract.verdict === 'FAIL';
            const isError = contract.verdict === 'ERROR';

            // Determine emoji and color scheme
            let rankEmoji, bgGradient, buttonColor;
            if (isPassed) {
                if (rank === 1) {
                    rankEmoji = 'ü•á';
                    bgGradient = '#10B981 0%, #059669 100%';
                    buttonColor = '#059669';
                } else if (rank === 2) {
                    rankEmoji = 'ü•à';
                    bgGradient = '#3B82F6 0%, #2563EB 100%';
                    buttonColor = '#2563EB';
                } else if (rank === 3) {
                    rankEmoji = 'ü•â';
                    bgGradient = '#F59E0B 0%, #D97706 100%';
                    buttonColor = '#D97706';
                } else {
                    rankEmoji = '‚úÖ';
                    bgGradient = '#10B981 0%, #059669 100%';
                    buttonColor = '#059669';
                }
            } else if (isError) {
                rankEmoji = '‚ùå';
                bgGradient = '#EF4444 0%, #DC2626 100%';
                buttonColor = '#DC2626';
            } else {
                rankEmoji = '‚ö†Ô∏è';
                bgGradient = '#6B7280 0%, #4B5563 100%';
                buttonColor = '#4B5563';
            }

            // Build explanation
            let explanationHTML = '';
            if (contract.explanation && contract.explanation.length > 0) {
                explanationHTML = contract.explanation.map(exp => `<p>‚Ä¢ ${exp}</p>`).join('');
            } else if (contract.error) {
                explanationHTML = `<p style="color: rgba(255,255,255,0.95);">‚ùå ${contract.error}</p>`;
            }

            // Build score breakdown
            const scores = contract.scores || {};
            const scoreBreakdown = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 0.5rem; margin-top: 0.75rem;">
                    <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: 0.7rem; opacity: 0.9;">Basis</div>
                        <div style="font-weight: 600;">${scores.basis || 0}/10</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: 0.7rem; opacity: 0.9;">OI</div>
                        <div style="font-weight: 600;">${scores.oi || 0}/15</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: 0.7rem; opacity: 0.9;">DMA</div>
                        <div style="font-weight: 600;">${scores.dma || 0}/15</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: 0.7rem; opacity: 0.9;">Sector</div>
                        <div style="font-weight: 600;">${scores.sector || 0}/20</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: 0.7rem; opacity: 0.9;">Volume</div>
                        <div style="font-weight: 600;">${scores.volume || 0}/10</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: 0.7rem; opacity: 0.9;">Tech</div>
                        <div style="font-weight: 600;">${scores.technical || 0}/15</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: 0.7rem; opacity: 0.9;">S/R</div>
                        <div style="font-weight: 600;">${scores.sr || 0}/5</div>
                    </div>
                </div>
            `;

            contractsHTML += `
                <div style="background: linear-gradient(135deg, ${bgGradient}); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.5rem; color: white; ${!isPassed ? 'opacity: 0.85;' : ''}">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 2rem;">${rankEmoji}</span>
                            <div>
                                <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">${contract.symbol}</h3>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Expiry: ${contract.expiry}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 2rem; font-weight: 700;">${contract.composite_score}</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">Score</div>
                            <div style="font-size: 0.875rem; font-weight: 600; margin-top: 0.25rem; padding: 0.25rem 0.5rem; background: rgba(255,255,255,0.2); border-radius: var(--radius-sm);">${contract.verdict}</div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; backdrop-filter: blur(10px);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem;">
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Direction</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${contract.direction}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Spot Price</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${contract.spot_price.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Futures Price</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${contract.futures_price.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Basis</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">‚Çπ${contract.basis.toFixed(2)} (${contract.basis_pct.toFixed(2)}%)</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Volume</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${contract.volume.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Lot Size</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${contract.lot_size}</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; backdrop-filter: blur(10px);">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 1rem; opacity: 0.95;">Why This Contract? (Verify Future Trade Logic)</h4>
                        <div style="font-size: 0.875rem; line-height: 1.6; opacity: 0.95;">
                            ${explanationHTML || '<p>‚Ä¢ Multi-factor analysis completed</p>'}
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; opacity: 0.9;">Score Breakdown</h4>
                        ${scoreBreakdown}
                    </div>

                    <div style="margin-top: 1rem; display: flex; gap: 0.75rem; justify-content: center;">
                        <button class="btn btn-success" onclick='openFullAnalysisInNewTab(${JSON.stringify(contract)})' style="background: rgba(255,255,255,0.95); color: ${buttonColor}; border: none; width: auto; padding: 0.75rem 1.5rem; font-weight: 600;">
                            üìä View Full Details ‚Üó
                        </button>
                        ${isPassed ? `
                        <button class="btn btn-success" onclick="verifyAndTrade('${contract.symbol}', '${contract.expiry_date}')" style="background: rgba(255,255,255,0.95); color: ${buttonColor}; border: none; width: auto; padding: 0.75rem 1.5rem; font-weight: 600;">
                            ‚úÖ Run & Trade
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        const html = `
            <div class="result-section">
                <h3>Analysis Summary</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="result-item">
                        <div class="result-item-label">Contracts Analyzed</div>
                        <div class="result-item-value">${totalAnalyzed}</div>
                    </div>
                    <div class="result-item" style="background: #D1FAE5;">
                        <div class="result-item-label">‚úÖ Passed</div>
                        <div class="result-item-value" style="color: #065F46;">${totalPassed}</div>
                    </div>
                    <div class="result-item" style="background: #FEE2E2;">
                        <div class="result-item-label">‚ö†Ô∏è Failed</div>
                        <div class="result-item-value" style="color: #991B1B;">${totalFailed}</div>
                    </div>
                    <div class="result-item" style="background: #FEE2E2;">
                        <div class="result-item-label">‚ùå Errors</div>
                        <div class="result-item-value" style="color: #991B1B;">${totalErrors}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">This Month Filter</div>
                        <div class="result-item-value">‚â•${volumeFilters.this_month}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Next Month Filter</div>
                        <div class="result-item-value">‚â•${volumeFilters.next_month}</div>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h3>All Analyzed Contracts (Sorted by Score)</h3>
                <p style="color: var(--gray); margin-bottom: 1rem;">
                    Showing all ${totalAnalyzed} contracts analyzed. Click "View Full Analysis" on any contract to see complete step-by-step breakdown.
                </p>
                ${contractsHTML}
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="hideResults()">
                    ‚Üê Back to Triggers
                </button>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    function openFullAnalysisInNewTab(contract) {
        // Create a new window/tab with the full analysis
        const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');

        if (!newWindow) {
            alert('Pop-up blocked! Please allow pop-ups for this site to view detailed analysis.');
            return;
        }

        // Build the complete HTML for the new tab
        const executionLog = contract.execution_log || [];
        const metrics = contract.metrics || {};
        const scores = contract.scores || {};

        // Build execution log HTML
        let logHTML = '';
        if (executionLog.length > 0) {
            logHTML = executionLog.map((log, index) => {
                let statusColor = '#2563EB';
                let statusIcon = '‚óè';
                let statusBg = '#2563EB';

                if (log.status === 'PASS' || log.status === 'success') {
                    statusColor = '#10B981';
                    statusIcon = '‚úì';
                    statusBg = '#10B981';
                } else if (log.status === 'FAIL' || log.status === 'fail') {
                    statusColor = '#EF4444';
                    statusIcon = '‚úó';
                    statusBg = '#EF4444';
                } else if (log.status === 'SKIP' || log.status === 'warning') {
                    statusColor = '#F59E0B';
                    statusIcon = '‚ö†';
                    statusBg = '#F59E0B';
                }

                let detailsHTML = '';
                if (log.details && Object.keys(log.details).length > 0) {
                    detailsHTML = '<div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.5rem; padding: 0.5rem; background: #F9FAFB; border-radius: 0.375rem; font-family: monospace; max-height: 150px; overflow-y: auto;">';
                    for (const [key, value] of Object.entries(log.details)) {
                        if (typeof value !== 'object') {
                            detailsHTML += `<div><strong>${key}:</strong> ${value}</div>`;
                        }
                    }
                    detailsHTML += '</div>';
                }

                return `
                    <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid #E5E7EB;">
                        <span style="flex-shrink: 0; background: ${statusBg}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${log.step}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1F2937; margin-bottom: 0.25rem;">${log.action}</div>
                            <div style="font-size: 0.875rem; color: #6B7280;">${log.message}</div>
                            ${detailsHTML}
                        </div>
                        <span style="flex-shrink: 0; color: ${statusColor}; font-size: 1.25rem;">${statusIcon}</span>
                    </div>
                `;
            }).join('');
        }

        const html = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Full Analysis: ${contract.symbol} - ${contract.expiry}</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        padding: 2rem;
                        background: #F3F4F6;
                        line-height: 1.6;
                    }
                    .container { max-width: 1200px; margin: 0 auto; }
                    .header {
                        background: linear-gradient(135deg, ${contract.verdict === 'PASS' ? '#10B981 0%, #059669 100%' : contract.verdict === 'ERROR' ? '#EF4444 0%, #DC2626 100%' : '#6B7280 0%, #4B5563 100%'});
                        color: white;
                        padding: 2rem;
                        border-radius: 0.75rem;
                        margin-bottom: 2rem;
                    }
                    .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
                    .header .verdict {
                        display: inline-block;
                        padding: 0.5rem 1rem;
                        background: rgba(255,255,255,0.2);
                        border-radius: 0.5rem;
                        font-weight: 600;
                        margin-top: 0.5rem;
                    }
                    .section {
                        background: white;
                        padding: 1.5rem;
                        border-radius: 0.75rem;
                        margin-bottom: 1.5rem;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    }
                    .section h2 {
                        font-size: 1.25rem;
                        color: #1F2937;
                        margin-bottom: 1rem;
                        padding-bottom: 0.5rem;
                        border-bottom: 2px solid #E5E7EB;
                    }
                    .grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 1rem;
                    }
                    .grid-item {
                        padding: 1rem;
                        background: #F9FAFB;
                        border-radius: 0.5rem;
                    }
                    .grid-item-label {
                        font-size: 0.75rem;
                        color: #6B7280;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin-bottom: 0.25rem;
                    }
                    .grid-item-value {
                        font-size: 1.125rem;
                        font-weight: 600;
                        color: #1F2937;
                    }
                    .print-btn {
                        background: #2563EB;
                        color: white;
                        padding: 0.75rem 1.5rem;
                        border: none;
                        border-radius: 0.5rem;
                        font-weight: 600;
                        cursor: pointer;
                        margin-top: 1rem;
                    }
                    .print-btn:hover { background: #1D4ED8; }
                    @media print {
                        body { background: white; padding: 0; }
                        .print-btn { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <h1>${contract.symbol} - ${contract.expiry}</h1>
                        <div>Composite Score: ${contract.composite_score}/100 | Direction: ${contract.direction}</div>
                        <span class="verdict">${contract.verdict}</span>
                    </div>

                    <div class="section">
                        <h2>Contract Overview</h2>
                        <div class="grid">
                            <div class="grid-item">
                                <div class="grid-item-label">Symbol</div>
                                <div class="grid-item-value">${contract.symbol}</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Expiry</div>
                                <div class="grid-item-value">${contract.expiry}</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Composite Score</div>
                                <div class="grid-item-value">${contract.composite_score}/100</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Direction</div>
                                <div class="grid-item-value">${contract.direction}</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Spot Price</div>
                                <div class="grid-item-value">‚Çπ${contract.spot_price.toFixed(2)}</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Futures Price</div>
                                <div class="grid-item-value">‚Çπ${contract.futures_price.toFixed(2)}</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Basis</div>
                                <div class="grid-item-value">‚Çπ${contract.basis.toFixed(2)} (${contract.basis_pct.toFixed(2)}%)</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Volume</div>
                                <div class="grid-item-value">${contract.volume.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    ${logHTML ? `
                    <div class="section">
                        <h2>üìã Step-by-Step Analysis</h2>
                        <div style="background: #F9FAFB; border-radius: 0.5rem; padding: 1rem;">
                            ${logHTML}
                        </div>
                    </div>
                    ` : ''}

                    <div class="section">
                        <h2>Score Breakdown</h2>
                        <div class="grid">
                            <div class="grid-item">
                                <div class="grid-item-label">Basis</div>
                                <div class="grid-item-value">${scores.basis || 0}/10</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Open Interest</div>
                                <div class="grid-item-value">${scores.oi || 0}/15</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">DMA</div>
                                <div class="grid-item-value">${scores.dma || 0}/15</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Sector</div>
                                <div class="grid-item-value">${scores.sector || 0}/20</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Volume</div>
                                <div class="grid-item-value">${scores.volume || 0}/10</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Technical</div>
                                <div class="grid-item-value">${scores.technical || 0}/15</div>
                            </div>
                            <div class="grid-item">
                                <div class="grid-item-label">Support/Resistance</div>
                                <div class="grid-item-value">${scores.sr || 0}/5</div>
                            </div>
                        </div>
                    </div>

                    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Analysis</button>
                </div>
            </body>
            </html>
        `;

        newWindow.document.write(html);
        newWindow.document.close();
    }

    function showFullAnalysis(contract) {
        // Display detailed execution log for this contract
        const executionLog = contract.execution_log || [];
        const metrics = contract.metrics || {};
        const scores = contract.scores || {};

        document.getElementById('resultTitle').textContent = `Full Analysis: ${contract.symbol}`;
        document.getElementById('resultBadge').textContent = contract.verdict;
        document.getElementById('resultBadge').className = 'result-badge ' + (contract.verdict === 'PASS' ? 'pass' : 'fail');

        // Build execution log HTML
        let logHTML = '';
        if (executionLog.length > 0) {
            logHTML = `
                <div class="result-section">
                    <h3>üìã Step-by-Step Analysis</h3>
                    <div style="background: var(--lighter); border-radius: var(--radius-md); padding: 1rem;">
                        ${executionLog.map((log, index) => {
                            let statusColor = 'var(--primary)';
                            let statusIcon = '‚óè';
                            let statusBg = 'var(--primary)';

                            if (log.status === 'PASS' || log.status === 'success') {
                                statusColor = 'var(--success)';
                                statusIcon = '‚úì';
                                statusBg = 'var(--success)';
                            } else if (log.status === 'FAIL' || log.status === 'fail') {
                                statusColor = 'var(--danger)';
                                statusIcon = '‚úó';
                                statusBg = 'var(--danger)';
                            } else if (log.status === 'SKIP' || log.status === 'warning') {
                                statusColor = 'var(--warning)';
                                statusIcon = '‚ö†';
                                statusBg = 'var(--warning)';
                            }

                            return `
                                <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid var(--gray-light);">
                                    <span style="flex-shrink: 0; background: ${statusBg}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${log.step}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--dark); margin-bottom: 0.25rem;">${log.action}</div>
                                        <div style="font-size: 0.875rem; color: var(--gray);">${log.message}</div>
                                        ${log.details && Object.keys(log.details).length > 0 ? `
                                            <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: var(--radius-sm); font-family: monospace; max-height: 150px; overflow-y: auto;">
                                                ${Object.entries(log.details).map(([key, value]) => {
                                                    if (typeof value === 'object') return '';
                                                    return `<div><strong>${key}:</strong> ${value}</div>`;
                                                }).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <span style="flex-shrink: 0; color: ${statusColor}; font-size: 1.25rem;">
                                        ${statusIcon}
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        const html = `
            <div class="result-section">
                <h3>Contract Overview</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Symbol</div>
                        <div class="result-item-value">${contract.symbol}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Expiry</div>
                        <div class="result-item-value">${contract.expiry}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Composite Score</div>
                        <div class="result-item-value">${contract.composite_score}/100</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Direction</div>
                        <div class="result-item-value">${contract.direction}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Spot Price</div>
                        <div class="result-item-value">‚Çπ${contract.spot_price.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Futures Price</div>
                        <div class="result-item-value">‚Çπ${contract.futures_price.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Basis</div>
                        <div class="result-item-value">‚Çπ${contract.basis.toFixed(2)} (${contract.basis_pct.toFixed(2)}%)</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Volume</div>
                        <div class="result-item-value">${contract.volume.toLocaleString()}</div>
                    </div>
                </div>
            </div>

            ${logHTML}

            <div class="result-section">
                <h3>Score Breakdown</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Basis</div>
                        <div class="result-item-value">${scores.basis || 0}/10</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Open Interest</div>
                        <div class="result-item-value">${scores.oi || 0}/15</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">DMA</div>
                        <div class="result-item-value">${scores.dma || 0}/15</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Sector</div>
                        <div class="result-item-value">${scores.sector || 0}/20</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Volume</div>
                        <div class="result-item-value">${scores.volume || 0}/10</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Technical</div>
                        <div class="result-item-value">${scores.technical || 0}/15</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Support/Resistance</div>
                        <div class="result-item-value">${scores.sr || 0}/5</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                ${contract.verdict === 'PASS' ? `
                    <button class="btn btn-success" onclick="verifyAndTrade('${contract.symbol}', '${contract.expiry_date}')">
                        ‚úÖ Run & Trade
                    </button>
                ` : ''}
                <button class="btn btn-secondary" onclick="hideResults()">
                    ‚Üê Back to Results
                </button>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    async function verifyAndTrade(symbol, expiryDate) {
        // Hide results panel first
        hideResults();

        // Populate the Verify Future Trade dropdown with this contract
        const contractValue = symbol + '|' + expiryDate;
        const contractSelect = document.getElementById('contractSelect');

        // Find and select the option
        let optionFound = false;
        for (let i = 0; i < contractSelect.options.length; i++) {
            if (contractSelect.options[i].value === contractValue) {
                contractSelect.selectedIndex = i;
                optionFound = true;
                break;
            }
        }

        if (!optionFound) {
            alert(`Contract ${symbol} (${expiryDate}) not found in dropdown. It may need to be refreshed.`);
            return;
        }

        // Scroll to Verify Future Trade card
        const verifyCard = document.querySelector('.trigger-card:nth-child(3)');
        if (verifyCard) {
            verifyCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Highlight the card briefly
            verifyCard.style.boxShadow = '0 0 20px rgba(37, 99, 235, 0.5)';
            verifyCard.style.transition = 'box-shadow 0.3s ease';
            setTimeout(() => {
                verifyCard.style.boxShadow = '';
            }, 2000);
        }

        // Wait a moment, then automatically trigger verification
        setTimeout(() => {
            const verifyBtn = document.getElementById('btnVerify');
            if (verifyBtn) {
                // Flash the button to draw attention
                verifyBtn.style.background = 'var(--success)';
                setTimeout(() => {
                    verifyBtn.style.background = '';
                    // Trigger the verification
                    verifyFutureTrade(verifyBtn);
                }, 500);
            }
        }, 1000);
    }

    function displayFuturesResult(data) {
        const candidate = data.candidate;
        const llm = data.llm_validation;

        document.getElementById('resultTitle').textContent = `Futures Opportunity: ${candidate.symbol}`;
        document.getElementById('resultBadge').textContent = candidate.direction.toUpperCase();
        document.getElementById('resultBadge').className = 'result-badge ' + (candidate.direction === 'BULLISH' ? 'pass' : 'fail');

        const html = `
            <div class="result-section">
                <h3>Trade Details</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Symbol</div>
                        <div class="result-item-value">${candidate.symbol}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Expiry Date</div>
                        <div class="result-item-value">${candidate.expiry || 'N/A'}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Direction</div>
                        <div class="result-item-value">${candidate.direction}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Entry Price</div>
                        <div class="result-item-value">‚Çπ${candidate.entry_price.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Stop Loss</div>
                        <div class="result-item-value">‚Çπ${candidate.stop_loss.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Target</div>
                        <div class="result-item-value">‚Çπ${candidate.target.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Composite Score</div>
                        <div class="result-item-value">${candidate.composite_score}/100</div>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h3>Algorithm Explanation</h3>
                <div class="explanation-box">
                    <h4>Why This Trade?</h4>
                    <p><strong>OI Analysis:</strong> ${candidate.oi_analysis?.buildup_type || 'Strong buildup detected'}</p>
                    <p><strong>Sector Strength:</strong> ${candidate.sector_analysis?.verdict || 'Sector aligned across timeframes'}</p>
                    <p><strong>Technical Setup:</strong> ${candidate.technical_analysis?.summary || 'Price at key support/resistance'}</p>
                    <p><strong>LLM Confidence:</strong> ${llm.confidence}% - ${llm.reasoning || 'Trade validated by AI'}</p>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="takeTrade('${candidate.symbol}', 'FUTURES')">
                    ‚úÖ Take This Trade
                </button>
                <button class="btn btn-secondary" onclick="hideResults()">
                    ‚ùå Reject
                </button>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    // 2. Run Nifty Strangle
    async function runNiftyStrangle(btn) {
        btn.disabled = true;
        document.getElementById('loadingStrangle').classList.add('active');
        document.getElementById('resultsPanel').classList.remove('active');

        try {
            const response = await fetch('{% url "trading:trigger_strangle" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            // Check for authentication error
            if (data.auth_required || (data.error && data.error.includes('Session key is expired'))) {
                // Show re-authentication modal
                showBreezeLoginModal({
                    type: 'nifty_strangle',
                    params: {}
                });
                return;
            }

            if (data.success) {
                console.log('Strangle data received:', data);
                displayStrangleResult(data);
            } else {
                // Check if it's a NO TRADE DAY with validation report
                if (data.is_no_trade_day && data.validation_report) {
                    displayNoTradeDay(data);
                } else {
                    displayError(data.error);
                }
            }
        } catch (error) {
            displayError('Network error: ' + error.message);
        } finally {
            btn.disabled = false;
            document.getElementById('loadingStrangle').classList.remove('active');
        }
    }

    // Build position sizing section with interactive lot adjustment
    function buildPositionSizingSection(positionSizing, strangle) {
        if (!positionSizing || !strangle) {
            console.warn('Position sizing data not available');
            return '';
        }

        const marginData = positionSizing.margin_data;
        const position = positionSizing.position;
        const pnl = positionSizing.pnl_analysis;

        // Helper function for color coding P&L
        const getPnlColor = (pnl) => pnl >= 0 ? '#D1FAE5' : '#FEE2E2';

        return `
            <div class="result-section" style="background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                <h3 style="color: white; margin-bottom: 1rem;">üìä Position Sizing & Risk Analysis</h3>

                <!-- Initial Position -->
                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; backdrop-filter: blur(10px);">
                    <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üéØ Recommended Initial Position</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Recommended Lots</div>
                            <div style="font-size: 1.75rem; font-weight: 700;">${initial.lots}</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">${initial.total_quantity} qty</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Margin Required</div>
                            <div style="font-size: 1.75rem; font-weight: 700;">‚Çπ${(initial.margin_required / 1000).toFixed(0)}K</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">${initial.margin_utilization_percent.toFixed(1)}% used</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Premium Collected</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: #D1FAE5;">‚Çπ${initial.premium_collected.toFixed(0)}</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">per lot: ‚Çπ${initial.premium_per_lot.toFixed(0)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.5rem;">Return on Margin</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: #FEF3C7;">${initial.rom_percent.toFixed(2)}%</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">if held to expiry</div>
                        </div>
                    </div>

                    <!-- Interactive Lot Adjustment -->
                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">
                            Adjust Number of Lots
                        </label>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button onclick="adjustLots(-1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: var(--radius-md); font-size: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚àí</button>
                            <input type="number" id="lotsInput" value="${initial.lots}" min="1" max="50"
                                   onchange="updatePositionCalculations()"
                                   style="flex: 1; background: rgba(255,255,255,0.9); border: none; padding: 0.75rem; border-radius: var(--radius-md); font-size: 1.25rem; font-weight: 700; text-align: center; color: #1F2937;">
                            <button onclick="adjustLots(1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: var(--radius-md); font-size: 1.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">+</button>
                        </div>
                        <div id="adjustedCalculations" style="margin-top: 1rem; font-size: 0.875rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                                <span>Total Quantity:</span>
                                <span id="adjQuantity" style="font-weight: 700;">${initial.total_quantity}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                                <span>Margin Required:</span>
                                <span id="adjMargin" style="font-weight: 700;">‚Çπ${initial.margin_required.toFixed(0)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                                <span>Premium Collected:</span>
                                <span id="adjPremium" style="font-weight: 700; color: #D1FAE5;">‚Çπ${initial.premium_collected.toFixed(0)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span>Return on Margin:</span>
                                <span id="adjROM" style="font-weight: 700; color: #FEF3C7;">${initial.rom_percent.toFixed(2)}%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Averaging Scenarios -->
                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; backdrop-filter: blur(10px);">
                    <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üîÑ Averaging Down Scenarios (20-50-50 Protocol)</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <!-- Attempt 1 -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                üìç Attempt 1 (20% Balance)
                            </div>
                            <div style="font-size: 0.75rem; margin-bottom: 0.5rem;">
                                <div style="opacity: 0.8;">Trigger: Position -1%</div>
                                <div style="opacity: 0.8;">Entry: Current premiums</div>
                            </div>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Additional Lots:</span>
                                    <span style="font-weight: 700;">${averaging.attempt_1.lots}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Margin:</span>
                                    <span style="font-weight: 700;">‚Çπ${(averaging.attempt_1.margin_required / 1000).toFixed(0)}K</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                                    <span>Total So Far:</span>
                                    <span style="font-weight: 700; color: #D1FAE5;">${averaging.after_attempt_1.total_lots} lots</span>
                                </div>
                            </div>
                        </div>

                        <!-- Attempt 2 -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                üìç Attempt 2 (50% Balance)
                            </div>
                            <div style="font-size: 0.75rem; margin-bottom: 0.5rem;">
                                <div style="opacity: 0.8;">Trigger: Position -1% again</div>
                                <div style="opacity: 0.8;">Entry: Current premiums</div>
                            </div>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Additional Lots:</span>
                                    <span style="font-weight: 700;">${averaging.attempt_2.lots}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Margin:</span>
                                    <span style="font-weight: 700;">‚Çπ${(averaging.attempt_2.margin_required / 1000).toFixed(0)}K</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                                    <span>Total So Far:</span>
                                    <span style="font-weight: 700; color: #D1FAE5;">${averaging.after_attempt_2.total_lots} lots</span>
                                </div>
                            </div>
                        </div>

                        <!-- Attempt 3 -->
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; opacity: 0.9;">
                                üìç Attempt 3 (50% Balance)
                            </div>
                            <div style="font-size: 0.75rem; margin-bottom: 0.5rem;">
                                <div style="opacity: 0.8;">Trigger: Position -1% again</div>
                                <div style="opacity: 0.8;">Entry: Current premiums</div>
                            </div>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Additional Lots:</span>
                                    <span style="font-weight: 700;">${averaging.attempt_3.lots}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                    <span>Margin:</span>
                                    <span style="font-weight: 700;">‚Çπ${(averaging.attempt_3.margin_required / 1000).toFixed(0)}K</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                                    <span>Total So Far:</span>
                                    <span style="font-weight: 700; color: #D1FAE5;">${averaging.total_after_all_averaging.total_lots} lots</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Final Position Summary -->
                    <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: var(--radius-md);">
                        <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">
                            üìà After All Averaging Attempts
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem;">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">Total Lots</div>
                                <div style="font-size: 1.25rem; font-weight: 700;">${averaging.total_after_all_averaging.total_lots}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">Total Quantity</div>
                                <div style="font-size: 1.25rem; font-weight: 700;">${averaging.total_after_all_averaging.total_quantity}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">Total Margin</div>
                                <div style="font-size: 1.25rem; font-weight: 700;">‚Çπ${(averaging.total_after_all_averaging.total_margin_required / 1000).toFixed(0)}K</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">Total Premium</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: #D1FAE5;">‚Çπ${averaging.total_after_all_averaging.total_premium_collected.toFixed(0)}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- P&L Analysis -->
                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                    <h4 style="color: white; font-size: 1rem; margin-bottom: 1rem;">üí∞ P&L at Key Price Levels</h4>

                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.1);">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.2);">Price Level</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.2);">Nifty Price</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.2);">P&L</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.2);">ROI %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pnl.at_resistance_1 ? `
                                <tr style="background: rgba(255,255,255,0.05);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">üìà Resistance 1</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.at_resistance_1.nifty_price.toFixed(2)}</td>
                                    <td id="pnlR1" style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: ${getPnlColor(pnl.at_resistance_1.pnl)};">‚Çπ${pnl.at_resistance_1.pnl.toFixed(0)}</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">${pnl.at_resistance_1.roi_percent.toFixed(2)}%</td>
                                </tr>
                                ` : ''}
                                ${pnl.at_5_percent_rise ? `
                                <tr style="background: rgba(255,255,255,0.05);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">üìà +5% Rise</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.at_5_percent_rise.nifty_price.toFixed(2)}</td>
                                    <td id="pnlRise5" style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: ${getPnlColor(pnl.at_5_percent_rise.pnl)};">‚Çπ${pnl.at_5_percent_rise.pnl.toFixed(0)}</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">${pnl.at_5_percent_rise.roi_percent.toFixed(2)}%</td>
                                </tr>
                                ` : ''}
                                ${pnl.breakeven_upper ? `
                                <tr style="background: rgba(255,255,255,0.08);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">‚öñÔ∏è Upper Breakeven</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.breakeven_upper.nifty_price.toFixed(2)}</td>
                                    <td style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: #FEF3C7;">‚Çπ0</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">0.00%</td>
                                </tr>
                                ` : ''}
                                ${pnl.breakeven_lower ? `
                                <tr style="background: rgba(255,255,255,0.08);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">‚öñÔ∏è Lower Breakeven</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.breakeven_lower.nifty_price.toFixed(2)}</td>
                                    <td style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: #FEF3C7;">‚Çπ0</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">0.00%</td>
                                </tr>
                                ` : ''}
                                ${pnl.at_support_1 ? `
                                <tr style="background: rgba(255,255,255,0.05);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">üìâ Support 1</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.at_support_1.nifty_price.toFixed(2)}</td>
                                    <td id="pnlS1" style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: ${getPnlColor(pnl.at_support_1.pnl)};">‚Çπ${pnl.at_support_1.pnl.toFixed(0)}</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">${pnl.at_support_1.roi_percent.toFixed(2)}%</td>
                                </tr>
                                ` : ''}
                                ${pnl.at_5_percent_drop ? `
                                <tr style="background: rgba(255,255,255,0.05);">
                                    <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">üìâ -5% Drop</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">‚Çπ${pnl.at_5_percent_drop.nifty_price.toFixed(2)}</td>
                                    <td id="pnlDrop5" style="padding: 0.75rem; text-align: right; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); color: ${getPnlColor(pnl.at_5_percent_drop.pnl)};">‚Çπ${pnl.at_5_percent_drop.pnl.toFixed(0)}</td>
                                    <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1);">${pnl.at_5_percent_drop.roi_percent.toFixed(2)}%</td>
                                </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: var(--radius-md); font-size: 0.75rem; opacity: 0.9;">
                        <div style="margin-bottom: 0.5rem;">
                            <strong>üí° Note:</strong> P&L calculated with ${averaging.total_after_all_averaging.total_lots} lots (after all averaging attempts)
                        </div>
                        <div>
                            <strong>üìä Risk Range:</strong> Max Loss: ‚Çπ${risk.max_loss_at_5_percent.toFixed(0)} | Max Profit: ‚Çπ${risk.max_profit.toFixed(0)} (if both expire worthless)
                        </div>
                    </div>
                </div>

            </div>
        `;

        // Store position sizing data for later use
        if (positionSizing && strangle) {
            const psData = document.createElement('div');
            psData.id = 'positionSizingData';
            psData.style.display = 'none';
            psData.textContent = JSON.stringify(positionSizing);

            const sData = document.createElement('div');
            sData.id = 'strangleData';
            sData.style.display = 'none';
            sData.textContent = JSON.stringify({
                call_strike: strangle.call_strike,
                put_strike: strangle.put_strike,
                call_premium: strangle.call_premium,
                put_premium: strangle.put_premium,
                total_premium: strangle.total_premium
            });

            // We'll append these after setting innerHTML
            setTimeout(() => {
                const resultContent = document.getElementById('resultContent');
                if (resultContent) {
                    resultContent.appendChild(psData);
                    resultContent.appendChild(sData);
                }
            }, 0);
        }

        return html;
    }

    function displayStrangleResult(data) {
        console.log('displayStrangleResult called with:', data);
        const strangle = data.strangle;
        const reasoning = strangle.reasoning;
        const executionLog = strangle.execution_log || [];
        console.log('Position sizing data:', data.position_sizing);

        document.getElementById('resultTitle').textContent = 'Nifty Strangle Position';
        document.getElementById('resultBadge').textContent = 'SELL STRANGLE';
        document.getElementById('resultBadge').className = 'result-badge pass';

        // Build execution log HTML
        let logHTML = '';
        if (executionLog.length > 0) {
            logHTML = `
                <div class="result-section">
                    <h3>üìã Execution Log</h3>
                    <div style="background: var(--lighter); border-radius: var(--radius-md); padding: 1rem;">
                        ${executionLog.map((log, index) => `
                            <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-light);">
                                <span style="flex-shrink: 0; background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${log.step}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--dark); margin-bottom: 0.25rem;">${log.action}</div>
                                    <div style="font-size: 0.875rem; color: var(--gray);">${log.message}</div>
                                    ${log.details ? `<div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem; font-family: monospace;">${JSON.stringify(log.details, null, 2).substring(0, 200)}${JSON.stringify(log.details).length > 200 ? '...' : ''}</div>` : ''}
                                </div>
                                <span style="flex-shrink: 0; color: var(--success); font-size: 1.25rem;">‚úì</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Build market validation report section
        let validationHTML = '';
        if (strangle.validation_report && strangle.validation_report.validation_results) {
            const validation = strangle.validation_report;
            const results = validation.validation_results || [];

            // Determine overall color based on verdict
            let verdictColor = '#10B981'; // Green (success)
            let verdictBg = '#D1FAE5';
            if (validation.overall_verdict.includes('NO TRADE')) {
                verdictColor = '#EF4444'; // Red (fail)
                verdictBg = '#FEE2E2';
            } else if (validation.overall_verdict.includes('CAUTION')) {
                verdictColor = '#F59E0B'; // Orange (warning)
                verdictBg = '#FEF3C7';
            }

            validationHTML = `
                <div class="result-section" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                    <h3 style="color: white; margin-bottom: 1rem;">üõ°Ô∏è Market Condition Validation</h3>

                    <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; backdrop-filter: blur(10px);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Overall Verdict</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">${validation.overall_verdict}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Status</div>
                                <div style="display: inline-block; background: ${verdictBg}; color: ${verdictColor}; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 600; font-size: 0.875rem;">
                                    ${validation.trade_allowed ? '‚úì ALLOWED' : '‚úó BLOCKED'}
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 0.875rem; opacity: 0.95; line-height: 1.6;">
                            ${validation.verdict_reason}
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #D1FAE5;">${validation.status_summary.PASS || 0}</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">PASSED</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #FEF3C7;">${validation.status_summary.WARNING || 0}</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">WARNINGS</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #FEE2E2;">${validation.status_summary.FAIL || 0}</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">FAILED</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #E5E7EB;">${validation.status_summary.SKIP || 0}</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">SKIPPED</div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                        <h4 style="color: white; font-size: 0.9rem; margin-bottom: 0.75rem; opacity: 0.9;">Detailed Validation Checks</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${results.map((result, idx) => {
                                let statusIcon = '‚úì';
                                let statusColor = '#D1FAE5';
                                if (result.status === 'FAIL') {
                                    statusIcon = '‚úó';
                                    statusColor = '#FEE2E2';
                                } else if (result.status === 'WARNING') {
                                    statusIcon = '‚ö†';
                                    statusColor = '#FEF3C7';
                                } else if (result.status === 'SKIP') {
                                    statusIcon = '‚óã';
                                    statusColor = '#E5E7EB';
                                }

                                return `
                                    <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: var(--radius-sm); border-left: 3px solid ${statusColor};">
                                        <div style="display: flex; align-items: start; gap: 0.75rem;">
                                            <span style="font-size: 1.25rem; color: ${statusColor};">${statusIcon}</span>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; margin-bottom: 0.25rem; font-size: 0.875rem;">${result.check}</div>
                                                <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.5rem;">${result.message}</div>
                                                ${Object.keys(result.details).length > 0 ? `
                                                    <div style="font-size: 0.7rem; opacity: 0.8; font-family: monospace; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: var(--radius-sm); max-height: 100px; overflow-y: auto;">
                                                        ${Object.entries(result.details).map(([key, value]) => {
                                                            if (typeof value === 'object') return '';
                                                            return `<div><strong>${key}:</strong> ${typeof value === 'number' ? value.toFixed(2) : value}</div>`;
                                                        }).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <span style="font-weight: 600; font-size: 0.75rem; color: ${statusColor};">${result.status}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Build delta details section
        let deltaHTML = '';
        if (strangle.delta_details) {
            const delta = strangle.delta_details;
            const breakdown = delta.delta_breakdown || {};
            const calcLog = delta.calculation_log || [];

            deltaHTML = `
                <div class="result-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                    <h3 style="color: white; margin-bottom: 1rem;">üéØ Smart Delta Calculation</h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Base Delta</div>
                            <div style="font-size: 1.75rem; font-weight: 700;">${delta.base_delta.toFixed(2)}%</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">${strangle.days_to_expiry} days expiry</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Adjusted Delta</div>
                            <div style="font-size: 1.75rem; font-weight: 700;">${delta.adjusted_delta.toFixed(3)}%</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">After ${Object.keys(breakdown).length} adjustments</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Strike Distance</div>
                            <div style="font-size: 1.75rem; font-weight: 700;">${delta.strike_distance.toFixed(0)}</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">points from spot</div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; backdrop-filter: blur(10px);">
                        <h4 style="color: white; font-size: 0.9rem; margin-bottom: 0.75rem; opacity: 0.9;">Delta Adjustment Factors</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">
                            ${Object.entries(breakdown).map(([key, value]) => `
                                <div style="background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: var(--radius-sm);">
                                    <div style="font-size: 0.75rem; opacity: 0.8;">${key.replace('_multiplier', '').replace(/_/g, ' ').toUpperCase()}</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;">${value.toFixed(2)}x</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${calcLog.length > 0 ? `
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                            <h4 style="color: white; font-size: 0.9rem; margin-bottom: 0.75rem; opacity: 0.9;">Calculation Steps</h4>
                            <div style="max-height: 250px; overflow-y: auto; font-size: 0.85rem;">
                                ${calcLog.map((step, idx) => `
                                    <div style="padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${step.factor}</div>
                                        <div style="opacity: 0.9;">${step.reason}</div>
                                        ${step.value !== undefined && step.value !== null ? `<div style="opacity: 0.8; font-size: 0.75rem; margin-top: 0.25rem;">Value: ${typeof step.value === 'number' ? step.value.toFixed(2) : step.value} | Multiplier: ${step.multiplier}x</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        let positionSizingHTML = '';
        try {
            if (data.position_sizing) {
                positionSizingHTML = buildPositionSizingSection(data.position_sizing, strangle);
                console.log('Position sizing HTML generated successfully');
            }
        } catch (error) {
            console.error('Error building position sizing section:', error);
            positionSizingHTML = '<div class="result-section"><p style="color: red;">Error loading position sizing. See console for details.</p></div>';
        }

        const html = `
            ${logHTML}
            ${validationHTML}
            ${deltaHTML}

            <div class="result-section">
                <h3>Position Details</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Underlying</div>
                        <div class="result-item-value">${strangle.underlying}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Current Price</div>
                        <div class="result-item-value">‚Çπ${strangle.current_price.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">India VIX</div>
                        <div class="result-item-value">${strangle.vix}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Expiry Date</div>
                        <div class="result-item-value">${strangle.expiry_date}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Days to Expiry</div>
                        <div class="result-item-value">${strangle.days_to_expiry} days</div>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h3>Strikes & Premiums</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Call Strike</div>
                        <div class="result-item-value">${strangle.call_strike} CE</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Call Premium</div>
                        <div class="result-item-value">‚Çπ${strangle.call_premium.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Put Strike</div>
                        <div class="result-item-value">${strangle.put_strike} PE</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Put Premium</div>
                        <div class="result-item-value">‚Çπ${strangle.put_premium.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Total Premium</div>
                        <div class="result-item-value">‚Çπ${strangle.total_premium.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Margin Required</div>
                        <div class="result-item-value">‚Çπ${strangle.margin_required.toFixed(0)}</div>
                    </div>
                </div>
            </div>

            ${positionSizingHTML}

            <div class="result-section">
                <h3>Strategy Explanation</h3>
                <div class="explanation-box">
                    <h4>Why This Strangle?</h4>
                    <p><strong>Strike Selection:</strong> ${reasoning.strike_selection}</p>
                    <p><strong>Risk Profile:</strong> ${reasoning.risk_profile}</p>
                    <p><strong>Entry Logic:</strong> ${reasoning.entry_logic}</p>
                    <p><strong>Exit Strategy:</strong> ${reasoning.exit_strategy}</p>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="takeTrade('NIFTY', 'STRANGLE')">
                    ‚úÖ Take This Trade
                </button>
                <button class="btn btn-secondary" onclick="hideResults()">
                    ‚ùå Reject
                </button>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    // Display NO TRADE DAY with validation report
    function displayNoTradeDay(data) {
        const validation = data.validation_report;
        const executionLog = data.execution_log || [];

        document.getElementById('resultTitle').textContent = '‚õî NO TRADE DAY';
        document.getElementById('resultBadge').textContent = 'BLOCKED';
        document.getElementById('resultBadge').className = 'result-badge fail';

        // Build execution log
        let logHTML = '';
        if (executionLog.length > 0) {
            logHTML = `
                <div class="result-section">
                    <h3>üìã Execution Log</h3>
                    <div style="background: var(--lighter); border-radius: var(--radius-md); padding: 1rem;">
                        ${executionLog.map((log, index) => {
                            const statusIcon = log.status === 'success' ? '‚úì' : (log.status === 'fail' ? '‚úó' : '‚ö†');
                            const statusColor = log.status === 'success' ? 'var(--success)' : (log.status === 'fail' ? 'var(--error)' : 'var(--warning)');
                            return `
                                <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-light);">
                                    <span style="flex-shrink: 0; background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${log.step}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--dark); margin-bottom: 0.25rem;">${log.action}</div>
                                        <div style="font-size: 0.875rem; color: var(--gray);">${log.message}</div>
                                    </div>
                                    <span style="flex-shrink: 0; color: ${statusColor}; font-size: 1.25rem;">${statusIcon}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // Build validation report (reuse same structure)
        const results = validation.validation_results || [];
        let verdictColor = '#EF4444'; // Red (fail)
        let verdictBg = '#FEE2E2';

        const html = `
            ${logHTML}

            <div class="result-section" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                <h3 style="color: white; margin-bottom: 1rem;">üõ°Ô∏è Market Condition Validation</h3>

                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; backdrop-filter: blur(10px);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Overall Verdict</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${validation.overall_verdict}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Status</div>
                            <div style="display: inline-block; background: ${verdictBg}; color: ${verdictColor}; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 600; font-size: 0.875rem;">
                                ‚úó BLOCKED
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 0.875rem; opacity: 0.95; line-height: 1.6;">
                        ${validation.verdict_reason}
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #D1FAE5;">${validation.status_summary.PASS || 0}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">PASSED</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #FEF3C7;">${validation.status_summary.WARNING || 0}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">WARNINGS</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #FEE2E2;">${validation.status_summary.FAIL || 0}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">FAILED</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px); text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #E5E7EB;">${validation.status_summary.SKIP || 0}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">SKIPPED</div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md); backdrop-filter: blur(10px);">
                    <h4 style="color: white; font-size: 0.9rem; margin-bottom: 0.75rem; opacity: 0.9;">Detailed Validation Checks</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${results.map((result, idx) => {
                            let statusIcon = '‚úì';
                            let statusColor = '#D1FAE5';
                            if (result.status === 'FAIL') {
                                statusIcon = '‚úó';
                                statusColor = '#FEE2E2';
                            } else if (result.status === 'WARNING') {
                                statusIcon = '‚ö†';
                                statusColor = '#FEF3C7';
                            } else if (result.status === 'SKIP') {
                                statusIcon = '‚óã';
                                statusColor = '#E5E7EB';
                            }

                            return `
                                <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: var(--radius-sm); border-left: 3px solid ${statusColor};">
                                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                                        <span style="font-size: 1.25rem; color: ${statusColor};">${statusIcon}</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; margin-bottom: 0.25rem; font-size: 0.875rem;">${result.check}</div>
                                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.5rem;">${result.message}</div>
                                            ${Object.keys(result.details).length > 0 ? `
                                                <div style="font-size: 0.7rem; opacity: 0.8; font-family: monospace; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: var(--radius-sm); max-height: 100px; overflow-y: auto;">
                                                    ${Object.entries(result.details).map(([key, value]) => {
                                                        if (typeof value === 'object') return '';
                                                        return `<div><strong>${key}:</strong> ${typeof value === 'number' ? value.toFixed(2) : value}</div>`;
                                                    }).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                        <span style="font-weight: 600; font-size: 0.75rem; color: ${statusColor};">${result.status}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>

            <div class="result-section" style="background: var(--lighter); padding: 1.5rem; border-radius: var(--radius-md);">
                <h3 style="color: var(--error); margin-bottom: 1rem;">‚ö†Ô∏è Trading Blocked</h3>
                <p style="color: var(--gray); line-height: 1.6; margin-bottom: 1rem;">
                    The system has detected unfavorable market conditions that do not meet the entry criteria for a Nifty Strangle position.
                    Trading has been automatically blocked to protect capital.
                </p>
                <p style="color: var(--gray); line-height: 1.6;">
                    <strong>Reason:</strong> ${data.error}
                </p>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="hideResults()">
                    ‚Üê Back
                </button>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    // 3. Verify Future Trade
    async function verifyFutureTrade(btn) {
        const contractValue = document.getElementById('contractSelect').value;
        if (!contractValue) {
            alert('Please select a futures contract');
            return;
        }

        // Parse contract value to get display name
        const selectedOption = document.getElementById('contractSelect').selectedOptions[0];
        const displayText = selectedOption.text;

        btn.disabled = true;
        document.getElementById('loadingVerify').classList.add('active');
        document.getElementById('verifyingStock').textContent = displayText;
        document.getElementById('resultsPanel').classList.remove('active');

        try {
            const formData = new FormData();
            formData.append('contract', contractValue);

            const response = await fetch('{% url "trading:verify_trade" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                displayVerificationResult(data);
            } else {
                // Show execution log even on error for debugging
                if (data.execution_log && data.execution_log.length > 0) {
                    displayVerificationResult({
                        ...data,
                        passed: false,
                        symbol: data.symbol || 'Unknown',
                        expiry: data.expiry || 'Unknown',
                        contract_display: data.contract_display || 'Unknown',
                        analysis: {
                            direction: 'NEUTRAL',
                            composite_score: 0,
                            contract_price: 0,
                            spot_price: 0,
                            position_details: {}
                        },
                        verdict: 'FAIL',
                        reason: data.error || 'Analysis failed - see steps for details'
                    });
                } else {
                    displayError(data.error);
                }
            }
        } catch (error) {
            displayError('Network error: ' + error.message);
        } finally {
            btn.disabled = false;
            document.getElementById('loadingVerify').classList.remove('active');
        }
    }

    function displayVerificationResult(data) {
        const analysis = data.analysis;
        const llm = data.llm_validation;
        const posDetails = analysis.position_details || {};
        const executionLog = data.execution_log || [];

        document.getElementById('resultTitle').textContent = `Verification: ${data.contract_display}`;
        document.getElementById('resultBadge').textContent = data.verdict;
        document.getElementById('resultBadge').className = 'result-badge ' + (data.passed ? 'pass' : 'fail');

        // Build execution log HTML (similar to strangle)
        let logHTML = '';
        if (executionLog.length > 0) {
            logHTML = `
                <div class="result-section">
                    <h3>üìã Step-by-Step Analysis</h3>
                    <div style="background: var(--lighter); border-radius: var(--radius-md); padding: 1rem;">
                        ${executionLog.map((log, index) => `
                            <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid var(--gray-light);">
                                <span style="flex-shrink: 0; background: ${log.status === 'PASS' ? 'var(--success)' : log.status === 'FAIL' ? 'var(--danger)' : 'var(--primary)'}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${log.step}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--dark); margin-bottom: 0.25rem;">${log.action}</div>
                                    <div style="font-size: 0.875rem; color: var(--gray);">${log.message}</div>
                                    ${log.details && Object.keys(log.details).length > 0 ? `
                                        <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: var(--radius-sm); font-family: monospace; max-height: 150px; overflow-y: auto;">
                                            ${Object.entries(log.details).map(([key, value]) => {
                                                if (typeof value === 'object') return '';
                                                return `<div><strong>${key}:</strong> ${value}</div>`;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <span style="flex-shrink: 0; color: ${log.status === 'PASS' ? 'var(--success)' : log.status === 'FAIL' ? 'var(--danger)' : 'var(--warning)'}; font-size: 1.25rem;">
                                    ${log.status === 'PASS' ? '‚úì' : log.status === 'FAIL' ? '‚úó' : '‚óè'}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        const html = `
            ${logHTML}

            <div class="result-section">
                <h3>Verdict: ${data.passed ? '‚úÖ PASS' : '‚ùå FAIL'}</h3>
                <p>${data.reason}</p>
            </div>

            <div class="result-section">
                <h3>Contract Details</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Symbol</div>
                        <div class="result-item-value">${data.symbol}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Expiry Date</div>
                        <div class="result-item-value">${data.expiry}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Futures Price</div>
                        <div class="result-item-value">‚Çπ${(analysis.contract_price || analysis.entry_price).toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Lot Size</div>
                        <div class="result-item-value">${analysis.lot_size || 'N/A'}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Trading Volume</div>
                        <div class="result-item-value">${analysis.traded_volume || 'N/A'} contracts</div>
                    </div>
                    ${analysis.basis ? `
                    <div class="result-item">
                        <div class="result-item-label">Basis</div>
                        <div class="result-item-value">‚Çπ${analysis.basis.toFixed(2)}</div>
                    </div>
                    ` : ''}
                </div>
            </div>

            <div class="result-section">
                <h3>Trade Analysis</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Direction</div>
                        <div class="result-item-value">${analysis.direction}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Entry Price</div>
                        <div class="result-item-value">‚Çπ${(analysis.contract_price || analysis.entry_price).toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Stop Loss</div>
                        <div class="result-item-value">‚Çπ${analysis.stop_loss.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Target</div>
                        <div class="result-item-value">‚Çπ${analysis.target.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Composite Score</div>
                        <div class="result-item-value">${analysis.composite_score}/100</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">LLM Confidence</div>
                        <div class="result-item-value">${llm.confidence}%</div>
                    </div>
                </div>
            </div>

            ${posDetails.lot_size ? `
            <div class="result-section">
                <h3>Position Details (1 Lot)</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item-label">Position Size</div>
                        <div class="result-item-value">${posDetails.lot_size} shares</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Entry Value</div>
                        <div class="result-item-value">‚Çπ${posDetails.entry_value.toFixed(0)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Risk Amount</div>
                        <div class="result-item-value">‚Çπ${posDetails.risk_amount.toFixed(0)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Reward Amount</div>
                        <div class="result-item-value">‚Çπ${posDetails.reward_amount.toFixed(0)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item-label">Risk:Reward</div>
                        <div class="result-item-value">1:${posDetails.risk_reward_ratio}</div>
                    </div>
                </div>
            </div>
            ` : ''}

            <div class="result-section">
                <h3>Detailed Explanation</h3>
                <div class="explanation-box">
                    <h4>Why This Trade?</h4>
                    <p><strong>OI Analysis:</strong> ${analysis.oi_analysis || 'Buildup analysis complete'}</p>
                    <p><strong>Sector Analysis:</strong> ${analysis.sector_analysis || 'Sector alignment verified'}</p>
                    <p><strong>Technical Setup:</strong> ${analysis.technical_setup || 'Technical indicators analyzed'}</p>
                    <p><strong>LLM Confidence ${llm.confidence}%:</strong> ${llm.reasoning || 'AI validation complete'}</p>
                </div>
            </div>

            ${data.passed ? `
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="placeOrder('${data.symbol}', '${data.expiry}', '${analysis.direction}', ${analysis.contract_price || analysis.entry_price}, ${analysis.stop_loss}, ${analysis.target}, ${analysis.lot_size || 0})">
                        üìà Place Order
                    </button>
                    <button class="btn btn-secondary" onclick="hideResults()">
                        ‚ùå Reject
                    </button>
                </div>
            ` : `
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="hideResults()">
                        Close
                    </button>
                </div>
            `}
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    function displayError(message) {
        document.getElementById('resultTitle').textContent = 'Error';
        document.getElementById('resultBadge').textContent = 'ERROR';
        document.getElementById('resultBadge').className = 'result-badge fail';

        const html = `
            <div class="error-message">
                ${message}
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="hideResults()">Close</button>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultsPanel').classList.add('active');
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
    }

    function hideResults() {
        document.getElementById('resultsPanel').classList.remove('active');
    }

    // Position sizing lot adjustment functions
    function adjustLots(delta) {
        const input = document.getElementById('lotsInput');
        if (!input) return;

        const currentValue = parseInt(input.value) || 1;
        const newValue = Math.max(1, Math.min(50, currentValue + delta));
        input.value = newValue;
        updatePositionCalculations();
    }

    function updatePositionCalculations() {
        const input = document.getElementById('lotsInput');
        if (!input) return;

        const lots = parseInt(input.value) || 1;

        // Get stored position sizing data from JSON script tags
        const psElement = document.getElementById('positionSizingData');
        const strangleElement = document.getElementById('strangleData');

        if (!psElement || !strangleElement) {
            console.error('Position sizing data not available');
            return;
        }

        const ps = JSON.parse(psElement.textContent);
        const strangle = JSON.parse(strangleElement.textContent);
        const LOT_SIZE = 50; // NIFTY lot size

        // Recalculate initial position metrics
        const quantity = lots * LOT_SIZE;
        const premiumPerLot = strangle.total_premium * LOT_SIZE;
        const premiumCollected = lots * premiumPerLot;

        // Margin per lot (30% of higher strike)
        const higherStrike = Math.max(strangle.call_strike, strangle.put_strike);
        const marginPerLot = higherStrike * LOT_SIZE * 0.30;
        const marginRequired = lots * marginPerLot;

        // Return on margin
        const rom = (premiumCollected / marginRequired) * 100;

        // Update displayed values
        document.getElementById('adjQuantity').textContent = quantity.toLocaleString();
        document.getElementById('adjMargin').textContent = '‚Çπ' + marginRequired.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        document.getElementById('adjPremium').textContent = '‚Çπ' + premiumCollected.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        document.getElementById('adjROM').textContent = rom.toFixed(2) + '%';

        // Recalculate P&L at key levels with new lot count
        // This is based on full averaging scenario, so multiply by ratio
        const originalLots = ps.initial_position.lots;
        const originalTotalLots = ps.averaging_scenarios.total_after_all_averaging.total_lots;
        const lotMultiplier = lots / originalLots;
        const newTotalLots = Math.round(originalTotalLots * lotMultiplier);

        // Update P&L values
        const pnl = ps.pnl_analysis;

        if (pnl.at_resistance_1 && document.getElementById('pnlR1')) {
            const newPnl = pnl.at_resistance_1.pnl * lotMultiplier;
            document.getElementById('pnlR1').textContent = '‚Çπ' + newPnl.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('pnlR1').style.color = newPnl >= 0 ? '#D1FAE5' : '#FEE2E2';
        }

        if (pnl.at_5_percent_rise && document.getElementById('pnlRise5')) {
            const newPnl = pnl.at_5_percent_rise.pnl * lotMultiplier;
            document.getElementById('pnlRise5').textContent = '‚Çπ' + newPnl.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('pnlRise5').style.color = newPnl >= 0 ? '#D1FAE5' : '#FEE2E2';
        }

        if (pnl.at_support_1 && document.getElementById('pnlS1')) {
            const newPnl = pnl.at_support_1.pnl * lotMultiplier;
            document.getElementById('pnlS1').textContent = '‚Çπ' + newPnl.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('pnlS1').style.color = newPnl >= 0 ? '#D1FAE5' : '#FEE2E2';
        }

        if (pnl.at_5_percent_drop && document.getElementById('pnlDrop5')) {
            const newPnl = pnl.at_5_percent_drop.pnl * lotMultiplier;
            document.getElementById('pnlDrop5').textContent = '‚Çπ' + newPnl.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('pnlDrop5').style.color = newPnl >= 0 ? '#D1FAE5' : '#FEE2E2';
        }

        // Store the adjusted lot count for order placement
        window.adjustedLots = lots;
    }

    function takeTrade(symbol, type) {
        // Prepare trade data for manual execution
        const tradeData = {
            algorithm_type: type === 'futures' ? 'futures' : 'strangle',
            instrument: symbol,
            direction: 'LONG',  // Will be determined by algorithm
            analysis_summary: `Manual trade trigger for ${symbol} via ${type} algorithm`
        };

        // Include adjusted lots if available (from position sizing)
        if (window.adjustedLots) {
            tradeData.lots = window.adjustedLots;
        }

        // Submit to preparation page for 4-checkbox confirmation
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "trading:prepare_manual_execution" %}';

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);

        const dataInput = document.createElement('input');
        dataInput.type = 'hidden';
        dataInput.name = 'trade_data';
        dataInput.value = JSON.stringify(tradeData);
        form.appendChild(dataInput);

        document.body.appendChild(form);
        form.submit();
    }

    function placeOrder(symbol, expiry, direction, entryPrice, stopLoss, target, lotSize) {
        // Calculate margin required (simplified)
        const positionValue = entryPrice * lotSize;
        const marginRequired = positionValue * 0.20; // Assume 20% margin

        // Prepare detailed trade data
        const tradeData = {
            algorithm_type: 'futures',
            instrument: symbol,
            direction: direction,
            entry_price: entryPrice,
            stop_loss: stopLoss,
            target: target,
            quantity: lotSize,
            expiry_date: expiry,
            margin_required: marginRequired,
            analysis_summary: `Manual futures trade: ${symbol} ${direction} @ ‚Çπ${entryPrice.toFixed(2)}`
        };

        // Submit to confirmation page with 4-checkbox safety protocol
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "trading:prepare_manual_execution" %}';

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);

        const dataInput = document.createElement('input');
        dataInput.type = 'hidden';
        dataInput.name = 'trade_data';
        dataInput.value = JSON.stringify(tradeData);
        form.appendChild(dataInput);

        document.body.appendChild(form);
        form.submit();
    }
</script>
{% endblock %}
